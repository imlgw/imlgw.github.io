<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5"><title>æ·±å…¥ThreadPoolExecutoræºç  | iMlGw0</title><meta name="description" content="æ·±å…¥ThreadPoolExecutoræºç "><meta name="keywords" content="å¤šçº¿ç¨‹,å¹¶å‘ç¼–ç¨‹"><meta name="author" content="imlgw"><meta name="copyright" content="imlgw"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/jedi-solid.ico"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="https://hm.baidu.com"><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="æ·±å…¥ThreadPoolExecutoræºç "><meta name="twitter:description" content="æ·±å…¥ThreadPoolExecutoræºç "><meta name="twitter:image" content="http://static.imlgw.top/blog/20190806/wdUz2J3lFXcL.jpg?imageslim"><meta property="og:type" content="article"><meta property="og:title" content="æ·±å…¥ThreadPoolExecutoræºç "><meta property="og:url" content="http://imlgw.top/2019/07/30/executor-kuang-jia/"><meta property="og:site_name" content="iMlGw0"><meta property="og:description" content="æ·±å…¥ThreadPoolExecutoræºç "><meta property="og:image" content="http://static.imlgw.top/blog/20190806/wdUz2J3lFXcL.jpg?imageslim"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><link rel="canonical" href="http://imlgw.top/2019/07/30/executor-kuang-jia/"><link rel="prev" title="é˜»å¡é˜Ÿåˆ—" href="http://imlgw.top/2019/08/07/zu-sai-dui-lie/"><link rel="next" title="JUCå¹¶å‘å·¥å…·åŒ…" href="http://imlgw.top/2019/07/24/bing-fa-gong-ju-bao/"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?93be601f1b40364d8cd640d751012180";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹:${query}"}},
  translate: {"defaultEncoding":1,"translateDelay":0,"cookieDomain":"imlgw.top","msgToTraditionalChinese":"ç¹","msgToSimplifiedChinese":"ç®€"},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: 'æŒ‰',
    message_next: 'é”®å°†æœ¬é¡µåŠ å…¥ä¹¦ç­¾'
  },
  runtime_unit: 'å¤©',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: true,
  fancybox: false,
  Snackbar: {"bookmark":{"title":"Snackbar.bookmark.title","message_prev":"æŒ‰","message_next":"é”®å°†æœ¬é¡µåŠ å…¥ä¹¦ç­¾"},"chs_to_cht":"ä½ å·²åˆ‡æ¢ä¸ºç¹ä½“","cht_to_chs":"ä½ å·²åˆ‡æ¢ä¸ºç®€ä½“","day_to_night":"ä½ å·²åˆ‡æ¢ä¸ºæ·±è‰²æ¨¡å¼","night_to_day":"ä½ å·²åˆ‡æ¢ä¸ºæµ…è‰²æ¨¡å¼","bgLight":"#49b1f5","bgDark":"#2d3035","position":"bottom-left"},
  baiduPush: false,
  isHome: false,
  isPost: true
  
}</script><meta name="generator" content="Hexo 4.2.0"><link rel="stylesheet" href="/css/prism.css" type="text/css"></head><body><header> <div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">iMlGw0</a></span><span class="toggle-menu pull_right close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> æ—¶é—´è½´</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> æ ‡ç­¾</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> åˆ†ç±»</span></a></div><div class="menus_item"><a class="site-page" href="/board/"><i class="fa-fw fa fa-link"></i><span> ç•™è¨€æ¿</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> å…³äº</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> LeetCode</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="http://imlgw.top/2019/02/27/leetcode-lian-biao/"><i class="fa-fw fa fa-tags"></i><span> é“¾è¡¨</span></a></li><li><a class="site-page" href="http://imlgw.top/2019/05/04/leetcode-shu-zu/"><i class="fa-fw fa fa-tags"></i><span> æ•°ç»„</span></a></li><li><a class="site-page" href="http://imlgw.top/2019/10/01/leetcode-zhan-dui-lie/"><i class="fa-fw fa fa-tags"></i><span> æ ˆ&amp;é˜Ÿåˆ—</span></a></li><li><a class="site-page" href="http://imlgw.top/2019/09/15/leetcode-cha-zhao/"><i class="fa-fw fa fa-tags"></i><span> æŸ¥æ‰¾</span></a></li><li><a class="site-page" href="http://imlgw.top/2019/12/06/leetcode-er-fen-cha-zhao/"><i class="fa-fw fa fa-tags"></i><span> äºŒåˆ†æŸ¥æ‰¾</span></a></li><li><a class="site-page" href="http://imlgw.top/2019/11/06/leetcode-er-cha-shu/"><i class="fa-fw fa fa-tags"></i><span> äºŒå‰æ ‘</span></a></li><li><a class="site-page" href="http://imlgw.top/2019/07/20/leetcode-hua-dong-chuang-kou/"><i class="fa-fw fa fa-tags"></i><span> æ»‘åŠ¨çª—å£</span></a></li><li><a class="site-page" href="http://imlgw.top/2019/09/01/leetcode-dong-tai-gui-hua/"><i class="fa-fw fa fa-tags"></i><span> åŠ¨æ€è§„åˆ’</span></a></li><li><a class="site-page" href="http://imlgw.top/2019/11/29/leetcode-bei-bao-wen-ti/"><i class="fa-fw fa fa-tags"></i><span> èƒŒåŒ…é—®é¢˜</span></a></li><li><a class="site-page" href="http://imlgw.top/2019/10/10/leetcode-hui-su/"><i class="fa-fw fa fa-tags"></i><span> å›æº¯</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link"><i class="fa-fw fa fa-address-book"></i><span> å¤§ä½¬ä»¬</span></a></div></div></span><span class="pull_right" id="search_button"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> æœç´¢</span></a></span></div></header><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="http://static.imlgw.top/blog/20191125/NtrimWLEnNSI.png?imageslim" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length_num">58</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length_num">58</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length_num">12</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> æ—¶é—´è½´</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> æ ‡ç­¾</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> åˆ†ç±»</span></a></div><div class="menus_item"><a class="site-page" href="/board/"><i class="fa-fw fa fa-link"></i><span> ç•™è¨€æ¿</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> å…³äº</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> LeetCode</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="http://imlgw.top/2019/02/27/leetcode-lian-biao/"><i class="fa-fw fa fa-tags"></i><span> é“¾è¡¨</span></a></li><li><a class="site-page" href="http://imlgw.top/2019/05/04/leetcode-shu-zu/"><i class="fa-fw fa fa-tags"></i><span> æ•°ç»„</span></a></li><li><a class="site-page" href="http://imlgw.top/2019/10/01/leetcode-zhan-dui-lie/"><i class="fa-fw fa fa-tags"></i><span> æ ˆ&amp;é˜Ÿåˆ—</span></a></li><li><a class="site-page" href="http://imlgw.top/2019/09/15/leetcode-cha-zhao/"><i class="fa-fw fa fa-tags"></i><span> æŸ¥æ‰¾</span></a></li><li><a class="site-page" href="http://imlgw.top/2019/12/06/leetcode-er-fen-cha-zhao/"><i class="fa-fw fa fa-tags"></i><span> äºŒåˆ†æŸ¥æ‰¾</span></a></li><li><a class="site-page" href="http://imlgw.top/2019/11/06/leetcode-er-cha-shu/"><i class="fa-fw fa fa-tags"></i><span> äºŒå‰æ ‘</span></a></li><li><a class="site-page" href="http://imlgw.top/2019/07/20/leetcode-hua-dong-chuang-kou/"><i class="fa-fw fa fa-tags"></i><span> æ»‘åŠ¨çª—å£</span></a></li><li><a class="site-page" href="http://imlgw.top/2019/09/01/leetcode-dong-tai-gui-hua/"><i class="fa-fw fa fa-tags"></i><span> åŠ¨æ€è§„åˆ’</span></a></li><li><a class="site-page" href="http://imlgw.top/2019/11/29/leetcode-bei-bao-wen-ti/"><i class="fa-fw fa fa-tags"></i><span> èƒŒåŒ…é—®é¢˜</span></a></li><li><a class="site-page" href="http://imlgw.top/2019/10/10/leetcode-hui-su/"><i class="fa-fw fa fa-tags"></i><span> å›æº¯</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link"><i class="fa-fw fa fa-address-book"></i><span> å¤§ä½¬ä»¬</span></a></div></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">ç›®å½•</div><div class="sidebar-toc__content"><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#æ·±å…¥ThreadPoolExecutoræºç "><span class="toc_mobile_items-number">1.</span> <span class="toc_mobile_items-text">æ·±å…¥ThreadPoolExecutoræºç </span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#ç±»ç»“æ„"><span class="toc_mobile_items-number">1.1.</span> <span class="toc_mobile_items-text">ç±»ç»“æ„</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#çº¿ç¨‹æ± çŠ¶æ€"><span class="toc_mobile_items-number">1.2.</span> <span class="toc_mobile_items-text">çº¿ç¨‹æ± çŠ¶æ€</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#çŠ¶æ€è½¬æ¢è¿‡ç¨‹"><span class="toc_mobile_items-number">1.2.1.</span> <span class="toc_mobile_items-text">çŠ¶æ€è½¬æ¢è¿‡ç¨‹</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#æˆå‘˜å˜é‡"><span class="toc_mobile_items-number">1.3.</span> <span class="toc_mobile_items-text">æˆå‘˜å˜é‡</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#execute"><span class="toc_mobile_items-number">1.4.</span> <span class="toc_mobile_items-text">execute()</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#addWorker"><span class="toc_mobile_items-number">1.5.</span> <span class="toc_mobile_items-text">addWorker()</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#addWorkerFailed"><span class="toc_mobile_items-number">1.6.</span> <span class="toc_mobile_items-text">addWorkerFailed()</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#Workerç±»"><span class="toc_mobile_items-number">1.7.</span> <span class="toc_mobile_items-text">Workerç±»</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#runWorker"><span class="toc_mobile_items-number">1.8.</span> <span class="toc_mobile_items-text">runWorker()</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#getTask"><span class="toc_mobile_items-number">1.9.</span> <span class="toc_mobile_items-text">getTask()</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#processWorkerExit"><span class="toc_mobile_items-number">1.10.</span> <span class="toc_mobile_items-text">processWorkerExit()</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#å·¥ä½œçº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ"><span class="toc_mobile_items-number">1.11.</span> <span class="toc_mobile_items-text">å·¥ä½œçº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#tryTerminate"><span class="toc_mobile_items-number">1.12.</span> <span class="toc_mobile_items-text">tryTerminate()</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#shutdown"><span class="toc_mobile_items-number">1.13.</span> <span class="toc_mobile_items-text">shutdown()</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#interruptIdleWorkers"><span class="toc_mobile_items-number">1.14.</span> <span class="toc_mobile_items-text">interruptIdleWorkers()</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#shutdownNow"><span class="toc_mobile_items-number">1.15.</span> <span class="toc_mobile_items-text">shutdownNow()</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#interruptWorkers"><span class="toc_mobile_items-number">1.16.</span> <span class="toc_mobile_items-text">interruptWorkers()</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#ThreadPoolExecutorä½¿ç”¨"><span class="toc_mobile_items-number">2.</span> <span class="toc_mobile_items-text">ThreadPoolExecutorä½¿ç”¨</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#æ„é€ æ–¹æ³•"><span class="toc_mobile_items-number">2.1.</span> <span class="toc_mobile_items-text">æ„é€ æ–¹æ³•</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#çº¿ç¨‹æ± çš„å…³é—­"><span class="toc_mobile_items-number">2.2.</span> <span class="toc_mobile_items-text">çº¿ç¨‹æ± çš„å…³é—­</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#å·¥å‚æ–¹æ³•"><span class="toc_mobile_items-number">2.3.</span> <span class="toc_mobile_items-text">å·¥å‚æ–¹æ³•</span></a></li></ol></li></ol></div></div></div><div id="body-wrap"><div id="web_bg" data-type="color"></div><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">ç›®å½•</div><div class="sidebar-toc__progress"><span class="progress-notice">ä½ å·²ç»è¯»äº†</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#æ·±å…¥ThreadPoolExecutoræºç "><span class="toc-number">1.</span> <span class="toc-text">æ·±å…¥ThreadPoolExecutoræºç </span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ç±»ç»“æ„"><span class="toc-number">1.1.</span> <span class="toc-text">ç±»ç»“æ„</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#çº¿ç¨‹æ± çŠ¶æ€"><span class="toc-number">1.2.</span> <span class="toc-text">çº¿ç¨‹æ± çŠ¶æ€</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#çŠ¶æ€è½¬æ¢è¿‡ç¨‹"><span class="toc-number">1.2.1.</span> <span class="toc-text">çŠ¶æ€è½¬æ¢è¿‡ç¨‹</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#æˆå‘˜å˜é‡"><span class="toc-number">1.3.</span> <span class="toc-text">æˆå‘˜å˜é‡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#execute"><span class="toc-number">1.4.</span> <span class="toc-text">execute()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#addWorker"><span class="toc-number">1.5.</span> <span class="toc-text">addWorker()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#addWorkerFailed"><span class="toc-number">1.6.</span> <span class="toc-text">addWorkerFailed()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Workerç±»"><span class="toc-number">1.7.</span> <span class="toc-text">Workerç±»</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#runWorker"><span class="toc-number">1.8.</span> <span class="toc-text">runWorker()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#getTask"><span class="toc-number">1.9.</span> <span class="toc-text">getTask()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#processWorkerExit"><span class="toc-number">1.10.</span> <span class="toc-text">processWorkerExit()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#å·¥ä½œçº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ"><span class="toc-number">1.11.</span> <span class="toc-text">å·¥ä½œçº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tryTerminate"><span class="toc-number">1.12.</span> <span class="toc-text">tryTerminate()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#shutdown"><span class="toc-number">1.13.</span> <span class="toc-text">shutdown()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#interruptIdleWorkers"><span class="toc-number">1.14.</span> <span class="toc-text">interruptIdleWorkers()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#shutdownNow"><span class="toc-number">1.15.</span> <span class="toc-text">shutdownNow()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#interruptWorkers"><span class="toc-number">1.16.</span> <span class="toc-text">interruptWorkers()</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ThreadPoolExecutorä½¿ç”¨"><span class="toc-number">2.</span> <span class="toc-text">ThreadPoolExecutorä½¿ç”¨</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#æ„é€ æ–¹æ³•"><span class="toc-number">2.1.</span> <span class="toc-text">æ„é€ æ–¹æ³•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#çº¿ç¨‹æ± çš„å…³é—­"><span class="toc-number">2.2.</span> <span class="toc-text">çº¿ç¨‹æ± çš„å…³é—­</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#å·¥å‚æ–¹æ³•"><span class="toc-number">2.3.</span> <span class="toc-text">å·¥å‚æ–¹æ³•</span></a></li></ol></li></ol></div></div></div><main id="content-outer"><div id="top-container" style="background-image: url(http://static.imlgw.top/blog/20190806/wdUz2J3lFXcL.jpg?imageslim)"><div id="post-info"><div id="post-title"><div class="posttitle">æ·±å…¥ThreadPoolExecutoræºç </div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> å‘è¡¨äº 2019-07-30<span class="post-meta__separator">|</span><i class="fa fa-history fa-fw" aria-hidden="true"></i> æ›´æ–°äº 2019-12-23</time><span class="post-meta__separator">|</span><span><i class="fa fa-inbox post-meta__icon fa-fw" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E5%B9%B6%E5%8F%91/">å¹¶å‘</a></span><div class="post-meta-wordcount"><i class="fa fa-file-word-o post-meta__icon fa-fw" aria-hidden="true"></i><span>å­—æ•°æ€»è®¡:</span><span class="word-count">113</span><span class="post-meta__separator">|</span><i class="fa fa-clock-o post-meta__icon fa-fw" aria-hidden="true"></i><span>é˜…è¯»æ—¶é•¿: 1 åˆ†é’Ÿ</span><div class="post-meta-pv-cv"><span class="post-meta__separator">|</span><span><i class="fa fa-eye post-meta__icon fa-fw" aria-hidden="true"> </i>é˜…è¯»é‡:</span><span id="busuanzi_value_page_pv"></span></div></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><html><head></head><body><h2 id="æ·±å…¥ThreadPoolExecutoræºç "><a href="#æ·±å…¥ThreadPoolExecutoræºç " class="headerlink" title="æ·±å…¥ThreadPoolExecutoræºç "></a>æ·±å…¥ThreadPoolExecutoræºç </h2><h3 id="ç±»ç»“æ„"><a href="#ç±»ç»“æ„" class="headerlink" title="ç±»ç»“æ„"></a>ç±»ç»“æ„</h3><p><img alt="mark" data-src="http://static.imlgw.top/blog/20190802/wTkHh1NbyM8K.png?imageslim" src="/img/loading.gif" class="lazyload"></p>
<p>è¿™é‡Œä¸»è¦è¦è¯´çš„æ˜¯ <code>ThreadPoolExecutor</code>ç±»</p>
<h3 id="çº¿ç¨‹æ± çŠ¶æ€"><a href="#çº¿ç¨‹æ± çŠ¶æ€" class="headerlink" title="çº¿ç¨‹æ± çŠ¶æ€"></a>çº¿ç¨‹æ± çŠ¶æ€</h3><p>æ‰“å¼€æºç æ˜ å…¥çœ¼å¸˜çš„å°±æ˜¯è¿™å‡ ä¸ªå­—æ®µå’Œæ–¹æ³•ï¼Œå¯¹åº”çš„å°±æ˜¯çº¿ç¨‹æ± çš„ä¸€äº›è¿è¡ŒçŠ¶æ€å’Œç›¸å…³æ–¹æ³•</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">//æ§åˆ¶çº¿ç¨‹æ± ä¸­æ•°é‡å’ŒçŠ¶æ€çš„å­—æ®µ,ç”¨AtomicIntegerä¿å­˜</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicInteger ctl = <span class="keyword">new</span> AtomicInteger(ctlOf(RUNNING, <span class="number">0</span>));</span><br><span class="line"><span class="comment">//count bité¡¾åæ€ä¹‰å°±æ˜¯ workerCountçš„ä½æ•°ï¼Œè¿™é‡Œæ˜¯29</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> COUNT_BITS = Integer.SIZE - <span class="number">3</span>;</span><br><span class="line"><span class="comment">//1<<29 -1 == 1111....1111(29ä¸ª1) çº¿ç¨‹æ•°(workerCount)ä¸Šé™ å¤§çº¦5äº¿</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CAPACITY   = (<span class="number">1</span> << COUNT_BITS) - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// runState is stored in the high-order bits</span></span><br><span class="line"><span class="comment">//é«˜ä¸‰ä½å­˜æ”¾çŠ¶æ€ï¼Œç›¸åº”çš„ä½29ä½å°±æ˜¯workerCount</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RUNNING    = -<span class="number">1</span> << COUNT_BITS;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SHUTDOWN   =  <span class="number">0</span> << COUNT_BITS;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STOP       =  <span class="number">1</span> << COUNT_BITS;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TIDYING    =  <span class="number">2</span> << COUNT_BITS;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TERMINATED =  <span class="number">3</span> << COUNT_BITS;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Packing and unpacking ctl</span></span><br><span class="line"><span class="comment">// æ‹†è§£ctlè·å–çŠ¶æ€å’Œæ•°é‡</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">runStateOf</span><span class="params">(<span class="keyword">int</span> c)</span>     </span>{ <span class="keyword">return</span> c & ~CAPACITY; }</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">workerCountOf</span><span class="params">(<span class="keyword">int</span> c)</span>  </span>{ <span class="keyword">return</span> c & CAPACITY; }</span><br><span class="line"><span class="comment">// æ‹¼æ¥çŠ¶æ€å’Œæ•°é‡å¾—åˆ°ctl</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">ctlOf</span><span class="params">(<span class="keyword">int</span> rs, <span class="keyword">int</span> wc)</span> </span>{ <span class="keyword">return</span> rs | wc; }</span><br></pre></td></tr></tbody></table></figure></div>

<h4 id="çŠ¶æ€è½¬æ¢è¿‡ç¨‹"><a href="#çŠ¶æ€è½¬æ¢è¿‡ç¨‹" class="headerlink" title="çŠ¶æ€è½¬æ¢è¿‡ç¨‹"></a>çŠ¶æ€è½¬æ¢è¿‡ç¨‹</h4><p><img alt="mark" data-src="http://static.imlgw.top/blog/20190802/EWlphYbCMVjv.png?imageslim" src="/img/loading.gif" class="lazyload"></p>
<p>ğŸ’¡ <strong>RUNNING</strong> ï¼šèƒ½æ¥å—æ–°æäº¤çš„ä»»åŠ¡ï¼Œå¹¶ä¸”ä¹Ÿèƒ½å¤„ç†é˜»å¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼›</p>
<p>ğŸ’¡ <strong>SHUTDOWN</strong>ï¼šå…³é—­çŠ¶æ€ï¼Œä¸å†æ¥å—æ–°æäº¤çš„ä»»åŠ¡ï¼Œä½†å´å¯ä»¥ç»§ç»­å¤„ç†é˜»å¡é˜Ÿåˆ—ä¸­å·²ä¿å­˜çš„ä»»åŠ¡ã€‚åœ¨çº¿ç¨‹æ± å¤„äº <code>RUNNING</code> çŠ¶æ€æ—¶ï¼Œè°ƒç”¨ <code>shutdown()</code>æ–¹æ³•ä¼šä½¿çº¿ç¨‹æ± è¿›å…¥åˆ°è¯¥çŠ¶æ€ã€‚ï¼ˆ<code>finalize()</code> æ–¹æ³•åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¹Ÿä¼šè°ƒç”¨shutdown()æ–¹æ³•è¿›å…¥è¯¥çŠ¶æ€ï¼‰</p>
<p>ğŸ’¡ <strong>STOP</strong>ï¼šä¸èƒ½æ¥å—æ–°ä»»åŠ¡ï¼Œä¹Ÿä¸å¤„ç†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œä¼šä¸­æ–­æ­£åœ¨å¤„ç†ä»»åŠ¡çš„çº¿ç¨‹ã€‚åœ¨çº¿ç¨‹æ± å¤„äº <code>RUNNING</code> æˆ– <code>SHUTDOWN</code> çŠ¶æ€æ—¶ï¼Œè°ƒç”¨ <code>shutdownNow()</code> æ–¹æ³•ä¼šä½¿çº¿ç¨‹æ± è¿›å…¥åˆ°è¯¥çŠ¶æ€</p>
<p>ğŸ’¡ <strong>TIDYING</strong>ï¼šå¦‚æœæ‰€æœ‰çš„ä»»åŠ¡éƒ½å·²ç»ˆæ­¢äº†ï¼ŒworkerCount (æœ‰æ•ˆçº¿ç¨‹æ•°) ä¸º0ï¼Œçº¿ç¨‹æ± è¿›å…¥è¯¥çŠ¶æ€åä¼šè°ƒç”¨ terminated() æ–¹æ³•è¿›å…¥TERMINATED çŠ¶æ€</p>
<p>ğŸ’¡ <strong>TERMINATED</strong>ï¼šåœ¨terminated() æ–¹æ³•æ‰§è¡Œå®Œåè¿›å…¥è¯¥çŠ¶æ€ï¼Œé»˜è®¤terminated()æ–¹æ³•ä¸­ä»€ä¹ˆä¹Ÿæ²¡æœ‰åšã€‚</p>
<p>è¿›å…¥<code>TERMINATED</code>çš„æ¡ä»¶å¦‚ä¸‹ï¼š</p>
<ul>
<li>çº¿ç¨‹æ± ä¸æ˜¯RUNNINGçŠ¶æ€ï¼›</li>
<li>çº¿ç¨‹æ± çŠ¶æ€ä¸æ˜¯TIDYINGçŠ¶æ€æˆ–TERMINATEDçŠ¶æ€ï¼›</li>
<li>å¦‚æœçº¿ç¨‹æ± çŠ¶æ€æ˜¯SHUTDOWNå¹¶ä¸”workerQueueä¸ºç©ºï¼›</li>
<li>workerCountä¸º0ï¼›</li>
<li>è®¾ç½®TIDYINGçŠ¶æ€æˆåŠŸã€‚</li>
</ul>
<h3 id="æˆå‘˜å˜é‡"><a href="#æˆå‘˜å˜é‡" class="headerlink" title="æˆå‘˜å˜é‡"></a>æˆå‘˜å˜é‡</h3><p>å†å¾€ä¸‹ï¼Œå°±ä¼šçœ‹è§ä¸€äº›å¾ˆé‡è¦çš„æˆå‘˜å˜é‡</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">//ä»»åŠ¡ç¼“å­˜é˜Ÿåˆ—ï¼Œå­˜æ”¾å¾…æ‰§è¡Œçš„ä»»åŠ¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue<runnable> workQueue; </runnable></span><br><span class="line"><span class="comment">//å¯é‡å…¥é”ï¼Œçº¿ç¨‹æ± ä¸»è¦çš„é”</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line"><span class="comment">//çº¿ç¨‹é›†åˆ(çº¿ç¨‹æ± çš„workersé›†åˆ)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> HashSet<worker> workers = <span class="keyword">new</span> HashSet<worker>();</worker></worker></span><br><span class="line"><span class="comment">//å¯¹åº”çš„æ¡ä»¶å˜é‡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Condition termination = mainLock.newCondition(); </span><br><span class="line"><span class="comment">//ç”¨æ¥è®°å½•çº¿ç¨‹æ± ä¸­æ›¾ç»å‡ºç°è¿‡çš„æœ€å¤§çº¿ç¨‹æ•°ï¼Œå’Œçº¿ç¨‹æ± å®¹é‡æ²¡æœ‰å…³ç³»</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> largestPoolSize;</span><br><span class="line"><span class="comment">//ç”¨æ¥è®°å½•å·²ç»æ‰§è¡Œå®Œæ¯•çš„ä»»åŠ¡ä¸ªæ•°</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">long</span> completedTaskCount; </span><br><span class="line"><span class="comment">//å·¥å‚æ–¹æ³•ï¼Œç”¨æ¥åˆ›å»ºçº¿ç¨‹</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> ThreadFactory threadFactory; </span><br><span class="line"><span class="comment">//æ‹’ç»ç­–ç•¥</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> RejectedExecutionHandler handler; </span><br><span class="line"><span class="comment">//çº¿ç¨‹é—²ç½®æ—¶å€™çš„æœ€å¤§å­˜æ´»æ—¶é—´</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> keepAliveTime; </span><br><span class="line"><span class="comment">//æ˜¯å¦å…è®¸æ ¸å¿ƒçº¿ç¨‹é—²ç½®çš„æ—¶å€™è¶…æ—¶</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> allowCoreThreadTimeOut; </span><br><span class="line"><span class="comment">//æ ¸å¿ƒçº¿ç¨‹æ•°</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> corePoolSize; </span><br><span class="line"><span class="comment">//æœ€å¤§çº¿ç¨‹æ•°</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> maximumPoolSize; </span><br><span class="line"><span class="comment">//é»˜è®¤çš„æ‹’ç»ç­–ç•¥ï¼šAbortPolicyç›´æ¥æ‹’ç»å¹¶æŠ›å¼‚å¸¸</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> RejectedExecutionHandler defaultHandler = <span class="keyword">new</span> AbortPolicy();</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="execute"><a href="#execute" class="headerlink" title="execute()"></a>execute()</h3><p> <strong>æºç åˆ†æ</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Runnable command)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (command == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è·å–çº¿ç¨‹æ± çš„çŠ¶æ€å’Œçº¿ç¨‹æ•°é‡</span></span><br><span class="line">    <span class="keyword">int</span> c = ctl.get();</span><br><span class="line">    <span class="keyword">if</span> (workerCountOf(c) < corePoolSize) { <span class="comment">//workerCountå°äºæ ¸å¿ƒçº¿ç¨‹æ•°é‡</span></span><br><span class="line">        <span class="comment">//å°†ä»»åŠ¡æ·»åŠ åˆ°workersä¸­ï¼Œç¬¬äºŒä¸ªå‚æ•°ä»£è¡¨æ˜¯å¦æ ¹æ®corePoolSizeæ¥æ·»åŠ çº¿ç¨‹ï¼Œfalseåˆ™æ ¹æ®maxPoolSize</span></span><br><span class="line">        <span class="keyword">if</span> (addWorker(command, <span class="keyword">true</span>))</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="comment">//æ·»åŠ å¤±è´¥ï¼Œé‡æ–°è·å–ctl</span></span><br><span class="line">        c = ctl.get();</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//ä¸Šé¢æ·»åŠ åˆ°workersä¸­å¤±è´¥ï¼Œæœ‰å¯èƒ½æ˜¯æ ¸å¿ƒçº¿ç¨‹ä¸å¤Ÿç”¨äº†æˆ–è€…çº¿ç¨‹æ± ä¸æ˜¯è¿è¡ŒçŠ¶æ€</span></span><br><span class="line">    <span class="comment">//å¦‚æœçº¿ç¨‹æ± æ˜¯RunningçŠ¶æ€ å°è¯•æ·»åŠ ä»»åŠ¡åˆ°é˜»å¡é˜Ÿåˆ—ä¸­</span></span><br><span class="line">    <span class="keyword">if</span> (isRunning(c) && workQueue.offer(command)) {</span><br><span class="line">        <span class="comment">//æ·»åŠ åˆ°ç­‰å¾…é˜Ÿåˆ—æˆåŠŸï¼Œé‡æ–°è·å–ctl</span></span><br><span class="line">        <span class="keyword">int</span> recheck = ctl.get();</span><br><span class="line">        <span class="comment">//å¦‚æœçº¿ç¨‹æ± ä¸æ˜¯RunningçŠ¶æ€å°±ä»ç­‰å¾…é˜Ÿåˆ—ä¸­removeè¿™ä¸ªä»»åŠ¡</span></span><br><span class="line">        <span class="keyword">if</span> (! isRunning(recheck) && remove(command))</span><br><span class="line">            reject(command); <span class="comment">//é‡‡ç”¨æ‹’ç»ç­–ç•¥æ‹’ç»è¯¥ä»»åŠ¡</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (workerCountOf(recheck) == <span class="number">0</span>)</span><br><span class="line">            <span class="comment">//çº¿ç¨‹æ± Runningä½†æ˜¯æ²¡æœ‰çº¿ç¨‹</span></span><br><span class="line">            <span class="comment">//åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ä½†æ˜¯ä¸ä¼ å…¥Runnable(å·²ç»åœ¨é˜»å¡é˜Ÿåˆ—ä¸­äº†)</span></span><br><span class="line">            addWorker(<span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//ä¸¤ç§æƒ…å†µ</span></span><br><span class="line">    <span class="comment">//1. çº¿ç¨‹æ± ä¸æ˜¯RunningçŠ¶æ€å¹¶ä¸”commandä¸ä¸ºnullï¼ŒaddWorkerä¼šç›´æ¥falseç„¶åæ‹’ç»è¿™ä¸ªä»»åŠ¡</span></span><br><span class="line">    <span class="comment">//2. æ·»åŠ åˆ°workQueue(é˜»å¡é˜Ÿåˆ—)å¤±è´¥ï¼Œä¹Ÿå°±æ˜¯ queueæ»¡äº†ï¼Œå¯èƒ½æ˜¯éœ€è¦æ‰©å®¹äº†</span></span><br><span class="line">    <span class="comment">//   æ‰€ä»¥åé¢çš„å‚æ•°æ˜¯falseï¼Œæ·»åŠ å¤±è´¥ä¹Ÿä¼šç›´æ¥æ‹’ç»</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!addWorker(command, <span class="keyword">false</span>))</span><br><span class="line">        reject(command);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>è¿™é‡Œè¦ç†è§£addWorkerçš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œtrueåˆ™ä»£è¡¨å½“å‰çº¿ç¨‹æ± çš„<strong>ä¸Šç•Œ</strong>ä»ç„¶æ˜¯corePoolSizeï¼Œåé¢çš„addWorkerä¼šæ ¹æ®ä¸Šç•Œæ¥åˆ¤æ–­æ˜¯å¦å¢åŠ çº¿ç¨‹ï¼Œfalseåˆ™ä»£è¡¨<strong>ä¸Šç•Œ</strong>æ˜¯maximumPoolSizeï¼Œè¿™ä¸€ç‚¹åœ¨åé¢çš„åˆ†æä¸­ä¼šçœ‹åˆ°ã€‚</p>
<p><strong>Executorå¤§è‡´æ‰§è¡Œæµç¨‹</strong></p>
<p><img alt="mark" data-src="http://static.imlgw.top/blog/20190803/j3xQrmOkc3Kl.png?imageslim" src="/img/loading.gif" class="lazyload"></p>
<h3 id="addWorker"><a href="#addWorker" class="headerlink" title="addWorker()"></a>addWorker()</h3><p><code>addWorker()</code> çš„ä½œç”¨å°±æ˜¯åˆ›å»ºçº¿ç¨‹(Worker)å¹¶ä¸”æ·»åŠ åˆ°Workersé›†åˆä¸­ï¼Œç„¶åå¯åŠ¨çº¿ç¨‹</p>
<p><strong>æºç åˆ†æ</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">addWorker</span><span class="params">(Runnable firstTask, <span class="keyword">boolean</span> core)</span> </span>{</span><br><span class="line">    retry:</span><br><span class="line">    <span class="keyword">for</span> (;;) {</span><br><span class="line">        <span class="keyword">int</span> c = ctl.get();</span><br><span class="line">        <span class="keyword">int</span> rs = runStateOf(c);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// rs>=SHUTDOWNè¯´æ˜ä¸æ˜¯RUNNINGçŠ¶æ€</span></span><br><span class="line">        <span class="keyword">if</span> (rs >= SHUTDOWN && !(rs == SHUTDOWN && firstTask == <span class="keyword">null</span> &&!workQueue.isEmpty()))</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (;;) {</span><br><span class="line">            <span class="keyword">int</span> wc = workerCountOf(c);</span><br><span class="line">            <span class="comment">//å¦‚æœå¤§äºå¯å…è®¸çš„æœ€å¤§çº¿ç¨‹æ•°ï¼Œæˆ–è€…å¤§äºå½“å‰çš„çº¿ç¨‹æ± çš„ä¸Šç•Œï¼Œç›´æ¥false</span></span><br><span class="line">            <span class="comment">//ä¸Šé¢ä¼ å…¥çš„ç¬¬äºŒä¸ªå‚æ•°çš„ä½œç”¨ä½“ç°å‡ºæ¥äº†ï¼Œä¸ºtrueä¸Šç•Œåˆ™æ˜¯corePoolSize</span></span><br><span class="line">            <span class="keyword">if</span> (wc >= CAPACITY || wc >= (core ? corePoolSize : maximumPoolSize))</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            <span class="comment">//åˆ©ç”¨CASè‡ªå¢ å¢å¤§workCountçº¿ç¨‹æ•°ï¼ŒæˆåŠŸåå°±è·³å‡ºå¾ªç¯</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndIncrementWorkerCount(c))</span><br><span class="line">                <span class="keyword">break</span> retry;</span><br><span class="line">            <span class="comment">//CASå¤±è´¥ï¼Œé‡æ–°è·å–ctl</span></span><br><span class="line">            c = ctl.get();  <span class="comment">// Re-read ctl</span></span><br><span class="line">            <span class="comment">//åˆ¤æ–­è¿˜æ˜¯ä¸æ˜¯RunningçŠ¶æ€(èƒ½åˆ°è¿™é‡Œè¯´æ˜rs==RunningçŠ¶æ€)ï¼Œä¸æ˜¯çš„è¯å°±è·³å‡ºå»é‡æ–°æ¥è¿‡</span></span><br><span class="line">            <span class="keyword">if</span> (runStateOf(c) != rs)</span><br><span class="line">                <span class="keyword">continue</span> retry;</span><br><span class="line">            <span class="comment">// else CAS failed due to workerCount change; retry inner loop</span></span><br><span class="line">            <span class="comment">// CASå¤±è´¥å¹¶ä¸”è¿˜æ˜¯RunningçŠ¶æ€ï¼Œç»§ç»­è‡ªæ—‹å°è¯•è‡ªå¢</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//çº¿ç¨‹æ˜¯å¦å¯åŠ¨ï¼Œä»¥åŠçº¿ç¨‹æ˜¯å¦æ·»åŠ </span></span><br><span class="line">    <span class="keyword">boolean</span> workerStarted = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">boolean</span> workerAdded = <span class="keyword">false</span>;</span><br><span class="line">    Worker w = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">//åˆ›å»ºä¸€ä¸ªWorker(å¯¹çº¿ç¨‹çš„å°è£…)</span></span><br><span class="line">        w = <span class="keyword">new</span> Worker(firstTask);</span><br><span class="line">        <span class="keyword">final</span> Thread t = w.thread;</span><br><span class="line">        <span class="keyword">if</span> (t != <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">            mainLock.lock();</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                <span class="comment">// Recheck while holding lock.</span></span><br><span class="line">                <span class="comment">// Back out on ThreadFactory failure or if</span></span><br><span class="line">                <span class="comment">// shut down before lock acquired.</span></span><br><span class="line">                <span class="keyword">int</span> rs = runStateOf(ctl.get());</span><br><span class="line">				<span class="comment">//æ˜¯RUNNINGçŠ¶æ€ æˆ–è€… æ˜¯SHUTDOWNçŠ¶æ€ä¸”æ²¡æœ‰æäº¤ä»»åŠ¡(SHUTDOWNçŠ¶æ€è¿˜å¯ä»¥æ‰§è¡Œé˜»å¡é˜Ÿåˆ—çš„ä»»åŠ¡)</span></span><br><span class="line">                <span class="keyword">if</span> (rs < SHUTDOWN ||</span><br><span class="line">                    (rs == SHUTDOWN && firstTask == <span class="keyword">null</span>)) {</span><br><span class="line">                    <span class="keyword">if</span> (t.isAlive()) <span class="comment">// precheck that t is startable</span></span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalThreadStateException();</span><br><span class="line">                    <span class="comment">//æ·»åŠ åˆ°å·¥ä½œé›†ä¸­</span></span><br><span class="line">                    workers.add(w);</span><br><span class="line">                    <span class="keyword">int</span> s = workers.size();</span><br><span class="line">                    <span class="keyword">if</span> (s > largestPoolSize)</span><br><span class="line">                        largestPoolSize = s; <span class="comment">//è®°å½•æœ€å¤§å€¼</span></span><br><span class="line">                    workerAdded = <span class="keyword">true</span>; <span class="comment">//æ·»åŠ æˆåŠŸ</span></span><br><span class="line">                }</span><br><span class="line">            } <span class="keyword">finally</span> {</span><br><span class="line">                mainLock.unlock();</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">if</span> (workerAdded) {</span><br><span class="line">                <span class="comment">//å¯åŠ¨çº¿ç¨‹ï¼Œæ‰§è¡ŒWorkerçš„runæ–¹æ³•</span></span><br><span class="line">                t.start(); </span><br><span class="line">                workerStarted = <span class="keyword">true</span>; <span class="comment">//å¯åŠ¨æˆåŠŸ</span></span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">finally</span> {</span><br><span class="line">        <span class="keyword">if</span> (! workerStarted)</span><br><span class="line">            <span class="comment">//å¯åŠ¨å¤±è´¥ï¼Œå›æ»šworkerså¹¶å°è¯•å…³é—­çº¿ç¨‹æ± </span></span><br><span class="line">            addWorkerFailed(w);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> workerStarted;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>ğŸ”¸ é¦–å…ˆåˆ¤æ–­å½“å‰çº¿ç¨‹æ± çš„çŠ¶æ€æ˜¯å¦é€‚åˆç»§ç»­addWorkerï¼Œåˆ†æè¿™é‡Œçš„ifæ¡ä»¶ï¼ŒRUNNINGä¸ä¼šfalse ï¼ŒSTOPï¼ŒTIDYINGï¼ŒTERMINATEDç›´æ¥falseï¼ŒSHUTDOWNçŠ¶æ€å¦‚æœfirstTaskä¸ºç©º é˜»å¡é˜Ÿåˆ—ä¸­è¿˜æœ‰ä»»åŠ¡çš„æ—¶å€™ä¸ä¼šfalseï¼Œå…¶ä»–æƒ…å†µéƒ½falseã€‚</p>
<p>ğŸ”¸ è·å–å½“å‰çš„workerCountåˆ¤æ–­æ˜¯å¦è¶…è¿‡äº†å½“å‰çš„ä¸Šç•Œï¼Œè¿™é‡Œå°±ç”¨åˆ°äº†ç¬¬äºŒä¸ªå‚æ•°</p>
<p>ğŸ”¸ ç„¶ååˆ©ç”¨CASè‡ªæ—‹å¢åŠ workerCount</p>
<p>ğŸ”¸ åˆ›å»ºWorkerå¯¹è±¡ï¼Œè·å–mainLockå¹¶åŠ é”ï¼Œå› ä¸ºworkersæ˜¯HashSetå¹¶ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„</p>
<p>ğŸ”¸ å†æ¬¡è·å–çº¿ç¨‹æ± è½¬å°å¹¶åˆ¤æ–­æ˜¯å¦åˆæ³•ï¼Œåˆæ³•å°±æ·»åŠ åˆ°workersä¸­ï¼Œç„¶ååœ¨finallyå—ä¸­é‡Šæ”¾é”</p>
<p>ğŸ”¸ æ ¹æ®å‰é¢çš„workerAdded åˆ¤æ–­æ˜¯å¦å¯åŠ¨çº¿ç¨‹</p>
<p>ğŸ”¸ åœ¨æœ€ç»ˆçš„finallyå—ä¸­æ ¹æ®æ˜¯å¦å¯åŠ¨æˆåŠŸæ¥å†³å®šæ˜¯å¦å›æ»š</p>
<h3 id="addWorkerFailed"><a href="#addWorkerFailed" class="headerlink" title="addWorkerFailed()"></a>addWorkerFailed()</h3><p>å¯åŠ¨å¤±è´¥ï¼Œå›æ»šä¹‹å‰çš„æ·»åŠ æ“ä½œ</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addWorkerFailed</span><span class="params">(Worker w)</span> </span>{</span><br><span class="line">    <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">    <span class="comment">//è·å–é”</span></span><br><span class="line">    mainLock.lock();</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="keyword">if</span> (w != <span class="keyword">null</span>)</span><br><span class="line">            <span class="comment">//ä»workersä¸­ç§»é™¤</span></span><br><span class="line">            workers.remove(w);</span><br><span class="line">        <span class="comment">//å‡å°‘workerCount</span></span><br><span class="line">        decrementWorkerCount();</span><br><span class="line">        <span class="comment">//å°è¯•å…³é—­çº¿ç¨‹æ± </span></span><br><span class="line">        tryTerminate();</span><br><span class="line">    } <span class="keyword">finally</span> {</span><br><span class="line">        mainLock.unlock();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="Workerç±»"><a href="#Workerç±»" class="headerlink" title="Workerç±»"></a>Workerç±»</h3><p>å°è£…äº†çº¿ç¨‹å¯¹è±¡ï¼Œçº¿ç¨‹æ± ç»´æŠ¤çš„å°±æ˜¯è¿™äº›worker</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Worker</span> <span class="keyword">extends</span> <span class="title">AbstractQueuedSynchronizer</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span></span><br><span class="line"><span class="class"></span>{</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * This class will never be serialized, but we provide a</span></span><br><span class="line"><span class="comment">     * serialVersionUID to suppress a javac warning.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">6138294804551838833L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Thread this worker is running in.  Null if factory fails. */</span></span><br><span class="line">    <span class="keyword">final</span> Thread thread;</span><br><span class="line">    <span class="comment">/** Initial task to run.  Possibly null. */</span></span><br><span class="line">    Runnable firstTask; <span class="comment">//ä¼ å…¥çš„ä»»åŠ¡</span></span><br><span class="line">    <span class="comment">/** Per-thread task counter */</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">long</span> completedTasks;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates with given first task and thread from ThreadFactory.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> firstTask the first task (null if none)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Worker(Runnable firstTask) {</span><br><span class="line">        setState(-<span class="number">1</span>); <span class="comment">// è®¾ç½®çŠ¶æ€ä¸º -1</span></span><br><span class="line">        <span class="keyword">this</span>.firstTask = firstTask;</span><br><span class="line">        <span class="comment">//æ ¹æ®å·¥å‚æ–¹æ³•åˆ›å»ºçº¿ç¨‹</span></span><br><span class="line">        <span class="comment">//å°†Workerä¼ é€’è¿›å»ï¼Œä½œä¸ºThreadçš„å‚æ•°</span></span><br><span class="line">        <span class="comment">//new Thread(Worker worker);</span></span><br><span class="line">        <span class="keyword">this</span>.thread = getThreadFactory().newThread(<span class="keyword">this</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Delegates main run loop to outer runWorker  */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line">        runWorker(<span class="keyword">this</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Lock methods</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// The value 0 represents the unlocked state.</span></span><br><span class="line">    <span class="comment">// The value 1 represents the locked state.</span></span><br><span class="line">    <span class="comment">// æ˜¯å¦è·å–åˆ°äº†é”</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isHeldExclusively</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> getState() != <span class="number">0</span>; </span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> unused)</span> </span>{</span><br><span class="line">        <span class="comment">//åˆ©ç”¨CASè®¾ç½®state</span></span><br><span class="line">        <span class="comment">//å¾ˆæ˜æ˜¾è¿™é‡Œæ˜¯ä¸ªä¸å¯é‡å…¥çš„ç‹¬å é”ï¼Œå…·ä½“å¯ä»¥å¯¹æ¯”ReentrantLockçš„å®ç°æ–¹æ³•</span></span><br><span class="line">        <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>)) {</span><br><span class="line">            <span class="comment">//ç»§æ‰¿è‡ªAbstractOwnableSynchronizer</span></span><br><span class="line">            <span class="comment">//ä¿å­˜å½“å‰çš„æŒæœ‰é”çš„çº¿ç¨‹</span></span><br><span class="line">            setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//é‡Šæ”¾é”è®¾ç½®state=0</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">tryRelease</span><span class="params">(<span class="keyword">int</span> unused)</span> </span>{</span><br><span class="line">        <span class="comment">//è®¾ç½®ç‹¬å é”çº¿ç¨‹ä¸ºç©º</span></span><br><span class="line">        setExclusiveOwnerThread(<span class="keyword">null</span>);</span><br><span class="line">        setState(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span>        </span>{ acquire(<span class="number">1</span>); } <span class="comment">//æœ€ç»ˆä¼šè°ƒç”¨tryAcquire(1);</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryLock</span><span class="params">()</span>  </span>{ <span class="keyword">return</span> tryAcquire(<span class="number">1</span>); }</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unlock</span><span class="params">()</span>      </span>{ release(<span class="number">1</span>); } <span class="comment">//æœ€ç»ˆä¼šè°ƒç”¨tryRelease(1);</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isLocked</span><span class="params">()</span> </span>{ <span class="keyword">return</span> isHeldExclusively(); }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ‰“æ–­å·²ç»å¯åŠ¨çš„çº¿ç¨‹</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">interruptIfStarted</span><span class="params">()</span> </span>{</span><br><span class="line">        Thread t;</span><br><span class="line">        <span class="keyword">if</span> (getState() >= <span class="number">0</span> && (t = thread) != <span class="keyword">null</span> && !t.isInterrupted()) {</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                t.interrupt();</span><br><span class="line">            } <span class="keyword">catch</span> (SecurityException ignore) {</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>è¿™é‡Œå¯ä»¥çœ‹åˆ°Workerç»§æ‰¿äº†AQSå¹¶ä¸”å®ç°äº†Runnableæ¥å£ï¼Œç„¶åå€ŸåŠ©AQSå®ç°äº†ä¸€ä¸ª<code>ç‹¬å çš„ä¸å¯é‡å…¥çš„é”</code>ï¼Œå…¶å®è¿™ä¹Ÿæ˜¯å¾ˆå·§å¦™çš„ä¸€ç‚¹ï¼ˆè¿™é‡Œæˆ‘å’Œåšå®¢ä¸Šçš„ç†è§£æœ‰ç‚¹å‡ºå…¥ï¼‰ã€‚</p>
<p>åˆ°è¿™é‡Œå¤§å®¶è‚¯å®šä¼šæœ‰ç–‘é—®ï¼Œä¸ºä»€ä¹ˆè¿™é‡Œè¦å®ç°AQSç„¶åå®ç°ä¸€ä¸ªé”ï¼Ÿæ—¢ç„¶è¦åˆä¸ºä»€ä¹ˆè¦å®ç°ä¸€ä¸ªä¸å¯é‡å…¥çš„ï¼Œè€Œä¸ç›´æ¥ä½¿ç”¨<code>ReentrantLock</code> é‚£ä¸æ˜¯æ›´åŠ æ–¹ä¾¿ä¹ˆï¼Ÿï¼Ÿé™¤æ­¤ä¹‹å¤–è¿˜æœ‰ä¸€ä¸ªå°ç»†èŠ‚å°±æ˜¯æ„é€ å™¨é‡Œé¢ä¸ºä»€ä¹ˆ<code>setState(-1)</code>  è¿™æ ·ä¸å°±è·å–ä¸åˆ°é”äº†ä¹ˆï¼Ÿï¼Ÿ</p>
<p>å…¶å®è¿™æ˜¯ä¸ºäº†åé¢<code>shutdown</code>çš„æ—¶å€™<code>interruptIdleWorkers</code>èƒ½åˆ¤æ–­å‡ºçº¿ç¨‹æ˜¯å¦åœ¨å·¥ä½œï¼Œä»è€Œæ‰“æ–­é‚£äº›ç©ºé—²çš„çº¿ç¨‹ã€‚å¦‚æœä½¿ç”¨å¯é‡å…¥é”çš„è¯å°±æ— æ³•é€šè¿‡<code>tryLock()</code> æ¥åˆ¤æ–­çº¿ç¨‹æ˜¯å¦åœ¨å·¥ä½œã€‚è€Œ<code>setState(-1)</code> åˆ™æ˜¯ä¸ºäº†é˜²æ­¢åœ¨ä»»åŠ¡æ²¡æœ‰å¼€å§‹å‰è¢«æ‰“æ–­</p>
<h3 id="runWorker"><a href="#runWorker" class="headerlink" title="runWorker()"></a>runWorker()</h3><p>åœ¨ä¸Šé¢<code>AddWorker()</code>æœ€åæ·»åŠ æˆåŠŸåä¼šå¯åŠ¨Workerçº¿ç¨‹ï¼Œè€Œåœ¨workerçº¿ç¨‹ä¸­runæ–¹æ³•åˆä¼šè°ƒç”¨ä¸€ä¸ª<code>runWorker()</code>æ–¹æ³•ï¼Œè¿™é‡Œå°±æ˜¯å…·ä½“æ‰§è¡Œä»»åŠ¡çš„åœ°æ–¹</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">runWorker</span><span class="params">(Worker w)</span> </span>{</span><br><span class="line">    <span class="comment">//å½“å‰æ‰§è¡Œçº¿ç¨‹</span></span><br><span class="line">    Thread wt = Thread.currentThread();</span><br><span class="line">    <span class="comment">//æ‹¿åˆ°ä»»åŠ¡</span></span><br><span class="line">    Runnable task = w.firstTask; </span><br><span class="line">    w.firstTask = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">//å‰é¢æ„é€ workerçš„æ—¶å€™è®¾ç½®äº†state=-1</span></span><br><span class="line">    <span class="comment">//è®¾ç½®stateä¸º0ï¼ŒtryRelease(1)</span></span><br><span class="line">    <span class="comment">//å…¶å®è¿™æ ·æ˜¯ä¸ºäº†åœ¨è¿™ä¹‹å‰ä¸ä¼šè¢«æ‰“æ–­ï¼ˆè¿˜æ²¡æœ‰å¼€å§‹æ‰§è¡Œä»»åŠ¡ï¼‰</span></span><br><span class="line">    w.unlock(); <span class="comment">// allow interrupts</span></span><br><span class="line">    <span class="keyword">boolean</span> completedAbruptly = <span class="keyword">true</span>; <span class="comment">//æ˜¯å¦å› ä¸ºå¼‚å¸¸è€Œé€€å‡ºï¼Ÿ</span></span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">//taskä¸ºç©ºå°±ä»é˜»å¡é˜Ÿåˆ—ä¸­æ‹¿ä»»åŠ¡</span></span><br><span class="line">        <span class="keyword">while</span> (task != <span class="keyword">null</span> || (task = getTask()) != <span class="keyword">null</span>) {</span><br><span class="line">            <span class="comment">//åŠ é”ï¼Œä½†æ˜¯è¿™ä¸ªé”ä¸ä¼šå’Œå…¶ä»–çš„Workeräº’æ–¥ï¼Œè¿™ä¸ªé”åªæ˜¯ç”¨æ¥åˆ¤æ–­workeræ˜¯å¦åœ¨å·¥ä½œ</span></span><br><span class="line">            w.lock();</span><br><span class="line">            <span class="comment">// If pool is stopping, ensure thread is interrupted;</span></span><br><span class="line">            <span class="comment">// if not, ensure thread is not interrupted.  This</span></span><br><span class="line">            <span class="comment">// requires a recheck in second case to deal with</span></span><br><span class="line">            <span class="comment">// shutdownNow race while clearing interrupt</span></span><br><span class="line">            <span class="keyword">if</span> ((runStateAtLeast(ctl.get(), STOP) ||</span><br><span class="line">                 (Thread.interrupted() &&</span><br><span class="line">                  runStateAtLeast(ctl.get(), STOP))) &&</span><br><span class="line">                !wt.isInterrupted())</span><br><span class="line">                <span class="comment">//æ‰“æ–­å½“å‰æ‰§è¡Œçº¿ç¨‹wt</span></span><br><span class="line">                wt.interrupt();</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                <span class="comment">//ç©ºæ–¹æ³•äº¤ç»™å­ç±»å»å®ç°</span></span><br><span class="line">                beforeExecute(wt, task);</span><br><span class="line">                Throwable thrown = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    task.run(); <span class="comment">//æ‰§è¡Œä»»åŠ¡</span></span><br><span class="line">                } <span class="keyword">catch</span> (RuntimeException x) {</span><br><span class="line">                    thrown = x; <span class="keyword">throw</span> x;</span><br><span class="line">                } <span class="keyword">catch</span> (Error x) {</span><br><span class="line">                    thrown = x; <span class="keyword">throw</span> x;</span><br><span class="line">                } <span class="keyword">catch</span> (Throwable x) {</span><br><span class="line">                    thrown = x; <span class="keyword">throw</span> <span class="keyword">new</span> Error(x);</span><br><span class="line">                } <span class="keyword">finally</span> {</span><br><span class="line">                    <span class="comment">//ç©ºæ–¹æ³•äº¤ç»™å­ç±»å»å®ç°</span></span><br><span class="line">                    afterExecute(task, thrown);</span><br><span class="line">                }</span><br><span class="line">            } <span class="keyword">finally</span> {</span><br><span class="line">                task = <span class="keyword">null</span>;</span><br><span class="line">                w.completedTasks++; <span class="comment">//å®Œæˆä»»åŠ¡æ•°++</span></span><br><span class="line">                w.unlock();</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        completedAbruptly = <span class="keyword">false</span>; <span class="comment">//ä¸‹é¢çš„æ”¶å°¾å·¥ä½œä¼šæ ¹æ®è¿™ä¸ªåˆ¤æ–­æ˜¯å¦è°ƒæ•´çº¿ç¨‹æ•°</span></span><br><span class="line">    } <span class="keyword">finally</span> {</span><br><span class="line">        processWorkerExit(w, completedAbruptly); <span class="comment">//æ”¶å°¾å·¥ä½œ</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>ğŸ”¸ é¦–å…ˆè·å–äº†å‚æ•°ä¼ é€’è¿›æ¥çš„workeræºå¸¦çš„ä»»åŠ¡</p>
<p>ğŸ”¸ ç„¶åæ‰§è¡Œäº†w.unlock()ï¼Œå®é™…ä¸Šè¿™é‡Œå°±å¯¹åº”äº†ä¸Šé¢Workerç±»æ„é€ å™¨ä¸­çš„setState(-1)ï¼Œæ­£å› ä¸ºå‰é¢è®¾ç½®äº†stateä¸º -1 æ‰€ä»¥åœ¨unlock()ä¹‹å‰ï¼Œè·å¾—é”çš„CASæ“ä½œè‚¯å®šéƒ½ä¼šå¤±è´¥ï¼Œå½“ç„¶è¿™ä¹Ÿæ˜¯ä¸ºäº†åœ¨ä»»åŠ¡å¯åŠ¨å‰ä¸ä¼šè¢«æ‰“æ–­ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œunlock()å°±åˆå°†stateè®¾ç½®ä¸ºäº†0 ä¹Ÿå°±è¡¨ç¤ºå¯ä»¥é€šè¿‡CASè·å¾—é”äº†ï¼Œä¹Ÿå¯ä»¥è¢«shutdownæ‰“æ–­äº†ã€‚</p>
<p>ğŸ”¸ ç„¶åè¿™ä¸ªçº¿ç¨‹å°±ä¼šæ‰§è¡Œworkerä¸­çš„ä»»åŠ¡ï¼Œå¦‚æœworkerä¸­ä»»åŠ¡ä¸ºç©ºå°±ä¼šä»é˜»å¡é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡</p>
<p>ğŸ”¸ è·å–åˆ°ä»»åŠ¡åè¿›å…¥å¾ªç¯å…ˆè¿›è¡Œ lock() æ“ä½œï¼Œè¿™å°±ä»£è¡¨å·²ç»å¼€å§‹æ‰§è¡Œä»»åŠ¡äº†ï¼Œè¿™ä¸ªæ—¶å€™shutdownå°±æ— æ³•å‘é€ä¸­æ–­ä¿¡å·ä¸­æ–­è¿™ä¸ªçº¿ç¨‹æ‰§è¡Œ (æ³¨æ„è¿™ä¸ªlockå¹¶ä¸ä¼šå’Œå…¶ä»–çš„workeräº’æ–¥ï¼Œå› ä¸ºæ¯ä¸ªWorkeréƒ½æ˜¯æ–°newå‡ºæ¥çš„ï¼Œå®Œå…¨ä¸ç›¸å…³çš„ï¼Œä»–ä»¬çš„stateçŠ¶æ€éƒ½æ˜¯ç‹¬ç«‹çš„)</p>
<p>ğŸ”¸ <code>runStateAtLeast(ctl.get(), STOP)</code> è¿”å›<code>ctl.get() >= STOP</code>  ï¼Œåˆ¤æ–­çº¿ç¨‹æ± æ˜¯å¦æ­£åœ¨å…³é—­å¦‚æœæ˜¯å°±æ‰“æ–­è¯¥çº¿ç¨‹ï¼Œå¦‚æœä¸æ˜¯éœ€è¦ç¡®ä¿çº¿ç¨‹ä¸æ˜¯InterruptçŠ¶æ€</p>
<p><code>If pool is stopping, ensure thread is interrupted;  if not, ensure thread is not interrupted.</code></p>
<p>ğŸ”¸<code>beforeExecute()</code> å’Œ<code>afterExecute()</code> éƒ½æ˜¯ç©ºæ–¹æ³•äº¤ç»™å­ç±»å»å®ç°çš„ã€‚</p>
<p>ğŸ”¸ åˆ°finallyå—é‡Œé¢å°±ä»£è¡¨è¿™ä¸ªå·¥ä½œçº¿ç¨‹å·²ç»å¿«è¦ç»“æŸäº†ï¼Œ<code>processWorkerExit()</code>  å°±æ˜¯å¤„ç†ä¸€äº›â€åäº‹â€çš„</p>
<h3 id="getTask"><a href="#getTask" class="headerlink" title="getTask()"></a>getTask()</h3><p>è¿™ä¸ªæ–¹æ³•å°±æ˜¯ç”¨æ¥ä»é˜»å¡é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡çš„ï¼Œå¦‚æœ <code>getTask()</code> è¿”å›nullï¼Œåœ¨<code>runWorker()</code> é‡Œé¢æ¥æ”¶åˆ°<code>null</code> åå°±ä¼š<strong>è·³å‡ºå¾ªç¯</strong>è¿›è€Œæ‰§è¡Œ<code>finally</code> å—é‡Œé¢çš„<code>processWorkerExit()</code> ã€‚è€Œè¿™ä¹Ÿå°±æ„å‘³ç€è¿™ä¸ªçº¿ç¨‹<code>æ‰§è¡Œç»“æŸ</code>äº†ï¼Œä¸ä¼šåœ¨æ‰§è¡Œä»»åŠ¡äº†ï¼Œå‰©ä¸‹çš„å°±æ˜¯ç­‰å¾…JVMå›æ”¶è¿™ä¸ªçº¿ç¨‹ã€‚</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Runnable <span class="title">getTask</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">//æ˜¯å¦è¶…æ—¶ï¼Ÿå’ŒkeepAliveTimeç›¸å…³</span></span><br><span class="line">    <span class="keyword">boolean</span> timedOut = <span class="keyword">false</span>; <span class="comment">// Did the last poll() time out?</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) {</span><br><span class="line">        <span class="keyword">int</span> c = ctl.get();</span><br><span class="line">        <span class="keyword">int</span> rs = runStateOf(c);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check if queue empty only if necessary.</span></span><br><span class="line">        <span class="comment">// å¦‚æœçº¿ç¨‹æ± çŠ¶æ€ä¸ºSHUTDOWNå¹¶ä¸”ä»»åŠ¡é˜Ÿåˆ—æ²¡ä»»åŠ¡ æˆ–è€… çº¿ç¨‹çŠ¶æ€>=STOP</span></span><br><span class="line">        <span class="keyword">if</span> (rs >= SHUTDOWN && (rs >= STOP || workQueue.isEmpty())) {</span><br><span class="line">            decrementWorkerCount();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> wc = workerCountOf(c);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Are workers subject to culling?</span></span><br><span class="line">        <span class="comment">// æ˜¯å¦å…è®¸çº¿ç¨‹è¶…æ—¶ å…è®¸æ ¸å¿ƒçº¿ç¨‹è¶…æ—¶(ä¸»åŠ¨è¶…æ—¶)ï¼Ÿ æˆ–è€…wcå¤§äºäº†æ ¸å¿ƒçº¿ç¨‹æ•°(è¢«åŠ¨è¶…æ—¶)</span></span><br><span class="line">        <span class="keyword">boolean</span> timed = allowCoreThreadTimeOut || wc > corePoolSize;</span><br><span class="line">		<span class="comment">//æ­¤æ—¶éœ€è¦å›æ”¶å¤šä½™çš„çº¿ç¨‹</span></span><br><span class="line">        <span class="keyword">if</span> ((wc > maximumPoolSize || (timed && timedOut))</span><br><span class="line">            && (wc > <span class="number">1</span> || workQueue.isEmpty())) {</span><br><span class="line">            <span class="keyword">if</span> (compareAndDecrementWorkerCount(c)) <span class="comment">//caså‡å°‘çº¿ç¨‹æ•°</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>; <span class="comment">//è¿”å›null</span></span><br><span class="line">            <span class="keyword">continue</span>; <span class="comment">//caså¤±è´¥ ç»§ç»­å¾ªç¯</span></span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">//æ ¹æ®timedåˆ¤æ–­æ˜¯é™æ—¶è·å–è¿˜æ˜¯ç›´æ¥è·å–</span></span><br><span class="line">            Runnable r = timed ?</span><br><span class="line">                workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :</span><br><span class="line">                workQueue.take(); <span class="comment">//é˜»å¡çš„è·å–</span></span><br><span class="line">            <span class="keyword">if</span> (r != <span class="keyword">null</span>)</span><br><span class="line">                <span class="keyword">return</span> r;</span><br><span class="line">            <span class="comment">//æ²¡è·å–åˆ°ï¼Œè¶…æ—¶äº†</span></span><br><span class="line">            timedOut = <span class="keyword">true</span>;</span><br><span class="line">        } <span class="keyword">catch</span> (InterruptedException retry) {</span><br><span class="line">            timedOut = <span class="keyword">false</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>ğŸ”¸ è·å–çº¿ç¨‹æ± çŠ¶æ€ï¼Œå¦‚æœçº¿ç¨‹æ± çŠ¶æ€ä¸ºSHUTDOWNå¹¶ä¸”ä»»åŠ¡é˜Ÿåˆ—æ²¡ä»»åŠ¡ æˆ–è€… çº¿ç¨‹çŠ¶æ€>=STOP å°±é€šè¿‡CASè‡ªæ—‹å‡å°‘çº¿ç¨‹æ•°ï¼Œç„¶åè¿”å›null</p>
<p>ğŸ”¸ åˆ¤æ–­æ˜¯å¦å…è®¸å½“å‰çº¿ç¨‹è·å–ä»»åŠ¡è¶…æ—¶ï¼Œå¦‚æœå…è®¸æ ¸å¿ƒçº¿ç¨‹è¶…æ—¶å°±ä»£è¡¨æ‰€æœ‰çº¿ç¨‹éƒ½ä¼šè¶…æ—¶é™åˆ¶ï¼Œåˆæˆ–è€…æ˜¯å½“å‰çº¿ç¨‹æ•°è¶…è¿‡äº†æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œä¹Ÿå°±æ˜¯ç»è¿‡äº†æ‰©å®¹ï¼Œæ‰€ä»¥æ ¸å¿ƒçº¿ç¨‹ä¹‹å¤–çš„çº¿ç¨‹éƒ½æ˜¯æœ‰è¶…æ—¶é™åˆ¶çš„ã€‚</p>
<p>ğŸ”¸ å¦‚æœ â‘  wcè¶…è¿‡æœ€å¤§çº¿ç¨‹æ•°  â‘¡æ²¡è¶…è¿‡æœ€å¤§çº¿ç¨‹æ•°ï¼Œä½†æ˜¯è¶…æ—¶äº†å¹¶ä¸”æ­¤æ—¶wc>1(ç•™ä¸€ä¸ªå¤„ç†ä»»åŠ¡)â‘¢æ²¡è¶…è¿‡æœ€å¤§çº¿ç¨‹æ•°ï¼Œä½†æ˜¯è¶…æ—¶äº†å¹¶ä¸”é˜»å¡é˜Ÿåˆ—ä¸ºç©ºï¼Œæ­¤æ—¶éœ€è¦å›æ”¶å¤šä½™çš„çº¿ç¨‹</p>
<p>ğŸ”¸ æ ¹æ®timedé€‰å–ä»é˜»å¡é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡çš„æ–¹å¼ï¼Œè¦ä¹ˆæ˜¯é™æ—¶è·å–çš„pollæˆ–è€…ä¸€ç›´é˜»å¡çš„takeï¼Œè·å–åˆ°äº†ä¹‹åè¿”å›</p>
<h3 id="processWorkerExit"><a href="#processWorkerExit" class="headerlink" title="processWorkerExit()"></a>processWorkerExit()</h3><p>çœ‹åå­—å°±çŸ¥é“æ˜¯ä¸€ä¸ªæ”¶å°¾çš„æ–¹æ³•ï¼Œæ‰§è¡Œçº¿ç¨‹ç»“æŸåçš„ä¸€äº›å¿…è¦æ”¶å°¾å·¥ä½œã€‚</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processWorkerExit</span><span class="params">(Worker w, <span class="keyword">boolean</span> completedAbruptly)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (completedAbruptly) <span class="comment">// If abrupt, then workerCount wasn't adjusted</span></span><br><span class="line">        <span class="comment">//å¦‚æœæ˜¯å› ä¸ºå¼‚å¸¸è€Œé€€å‡ºåˆ™ getTask() æ²¡æœ‰æœºä¼šå»è°ƒæ•´çº¿ç¨‹æ•°æ‰€ä»¥éœ€è¦åœ¨è¿™é‡Œè°ƒæ•´</span></span><br><span class="line">        decrementWorkerCount();  <span class="comment">// wc--</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">    mainLock.lock();</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">//å®Œæˆä»»åŠ¡æ€»æ•°+=è¯¥workerå®Œæˆçš„ä»»åŠ¡æ•°</span></span><br><span class="line">        completedTaskCount += w.completedTasks;</span><br><span class="line">        <span class="comment">//ç§»é™¤å‡ºçº¿ç¨‹é›†workers</span></span><br><span class="line">        workers.remove(w);</span><br><span class="line">    } <span class="keyword">finally</span> {</span><br><span class="line">        mainLock.unlock();</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//å°è¯•ç»“æŸçº¿ç¨‹æ± </span></span><br><span class="line">    tryTerminate();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//è·å–ctl</span></span><br><span class="line">    <span class="keyword">int</span> c = ctl.get();</span><br><span class="line">    <span class="keyword">if</span> (runStateLessThan(c, STOP)) {</span><br><span class="line">        <span class="comment">//éå¼‚å¸¸ç»“æŸ</span></span><br><span class="line">        <span class="keyword">if</span> (!completedAbruptly) {</span><br><span class="line">            <span class="comment">//æœ€å°å€¼æ ¹æ®æ˜¯å¦å…è®¸æ ¸å¿ƒçº¿ç¨‹è¶…æ—¶æ¥åˆ¤æ–­</span></span><br><span class="line">            <span class="keyword">int</span> min = allowCoreThreadTimeOut ? <span class="number">0</span> : corePoolSize;</span><br><span class="line">            <span class="keyword">if</span> (min == <span class="number">0</span> && ! workQueue.isEmpty())</span><br><span class="line">                min = <span class="number">1</span>; <span class="comment">//å¦‚æœæœ€å°ä¸º0å¹¶ä¸”ä»»åŠ¡é˜Ÿåˆ—ä¸ä¸ºç©ºåˆ™ä¿è¯çº¿ç¨‹æ± ä¸­è‡³å°‘æœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œè¿™äº›ä»»åŠ¡</span></span><br><span class="line">            <span class="keyword">if</span> (workerCountOf(c) >= min)</span><br><span class="line">                <span class="keyword">return</span>; <span class="comment">// replacement not needed</span></span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//1.å¼‚å¸¸ç»“æŸï¼Œæ–°å¢åŠ ä¸€ä¸ªçº¿ç¨‹åˆ°çº¿ç¨‹æ± ,ç›¸å½“äºæ›¿æ¢äº†å¼‚å¸¸çš„çº¿ç¨‹</span></span><br><span class="line">        <span class="comment">//2.éå¼‚å¸¸ç»“æŸï¼Œå·¥ä½œçº¿ç¨‹å°äºæ ¸å¿ƒçº¿ç¨‹ï¼Œå¢åŠ çº¿ç¨‹ï¼Œç¡®ä¿åœ¨ä¸å…è®¸æ ¸å¿ƒçº¿ç¨‹è¶…æ—¶çš„æƒ…å†µä¸‹çº¿ç¨‹æ•°ä¸å°äºcorePoolSize</span></span><br><span class="line">        addWorker(<span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p><code>runStateLessThan</code>  c < STOP è¿”å›trueå°±è¯´æ˜æ˜¯<code>SHUTDOWN</code> æˆ–è€…<code>RUNNING</code> ï¼Œåˆ°è¿™é‡Œè¯¥å·¥ä½œçº¿ç¨‹ï¼ˆWorkerï¼‰çš„ç”Ÿå‘½å‘¨æœŸå°±ç»“æŸäº†ã€‚</p>
<h3 id="å·¥ä½œçº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ"><a href="#å·¥ä½œçº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="å·¥ä½œçº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ"></a>å·¥ä½œçº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ</h3><p><img alt="mark" data-src="http://static.imlgw.top/blog/20190803/NbjiMxDqJlu4.png?imageslim" src="/img/loading.gif" class="lazyload"></p>
<h3 id="tryTerminate"><a href="#tryTerminate" class="headerlink" title="tryTerminate()"></a>tryTerminate()</h3><p>åœ¨ä¸Šé¢çš„å¤„ç†æ”¶å°¾å·¥ä½œçš„<code>processWorkerExit()</code> çš„æ—¶å€™ä¸­é—´è°ƒç”¨äº†ä¸€ä¸ª <code>tryTerminate()</code> æ–¹æ³•</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">tryTerminate</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">for</span> (;;) {</span><br><span class="line">        <span class="keyword">int</span> c = ctl.get();</span><br><span class="line">        <span class="comment">//å¦‚æœæ˜¯åœ¨RUNNINGçŠ¶æ€ ç›´æ¥return</span></span><br><span class="line">        <span class="comment">//å¦‚æœå·²ç»æ˜¯TIDYINGæˆ–è€…TERMINATEDçŠ¶æ€ ç›´æ¥return</span></span><br><span class="line">        <span class="comment">//å¦‚æœæ˜¯SHUTDOWNçŠ¶æ€å¹¶ä¸”é˜»å¡é˜Ÿåˆ—ä¸­è¿˜æœ‰ä»»åŠ¡ ç›´æ¥return</span></span><br><span class="line">        <span class="comment">//returnå°±è¯´æ˜çº¿ç¨‹æ± è¿˜ä¸åˆ°å…³é—­çš„æ—¶å€™</span></span><br><span class="line">        <span class="keyword">if</span> (isRunning(c) ||</span><br><span class="line">            runStateAtLeast(c, TIDYING) ||</span><br><span class="line">            (runStateOf(c) == SHUTDOWN && ! workQueue.isEmpty()))</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="comment">//åˆ°è¿™é‡Œå°±è¯´æ˜è¦ä¹ˆæ˜¯STOPçŠ¶æ€ï¼Œè¦ä¹ˆæ˜¯SHUTDOWNçŠ¶æ€é˜»å¡é˜Ÿåˆ—ä¹Ÿæ²¡ä»»åŠ¡äº†</span></span><br><span class="line">        <span class="keyword">if</span> (workerCountOf(c) != <span class="number">0</span>) { <span class="comment">// Eligible to terminate</span></span><br><span class="line">            <span class="comment">//ä¸­æ–­ä¸€ä¸ªç©ºé—²çš„workerçº¿ç¨‹</span></span><br><span class="line">            interruptIdleWorkers(ONLY_ONE);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">		</span><br><span class="line">        <span class="comment">//wc==0 æ²¡æœ‰çº¿ç¨‹å­˜æ´»äº†</span></span><br><span class="line">        <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">        mainLock.lock();</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">//CASè‡ªæ—‹ ä¿®æ”¹çº¿ç¨‹æ± çŠ¶æ€ä¸ºTIDYING</span></span><br><span class="line">            <span class="keyword">if</span> (ctl.compareAndSet(c, ctlOf(TIDYING, <span class="number">0</span>))) {</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    terminated(); <span class="comment">//ç©ºæ–¹æ³•,äº¤ç»™å­ç±»å»å®ç°çš„</span></span><br><span class="line">                } <span class="keyword">finally</span> {</span><br><span class="line">                    <span class="comment">//è®¾ç½®çŠ¶æ€ä¸º TERMINATED</span></span><br><span class="line">                    ctl.set(ctlOf(TERMINATED, <span class="number">0</span>));</span><br><span class="line">                    <span class="comment">//å”¤é†’terminationä¸Šawiatçš„çº¿ç¨‹</span></span><br><span class="line">                    termination.signalAll();</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            }</span><br><span class="line">        } <span class="keyword">finally</span> {</span><br><span class="line">            mainLock.unlock();</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// else retry on failed CAS</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>è¿™é‡Œæœ€åçš„<code>termination.signalAll()</code> å®é™…ä¸Šæ˜¯å”¤é†’çš„<code>awaitTermination()</code> æ–¹æ³•é˜»å¡çš„çº¿ç¨‹</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">awaitTermination</span><span class="params">(<span class="keyword">long</span> timeout, TimeUnit unit)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> InterruptedException </span>{</span><br><span class="line">    <span class="keyword">long</span> nanos = unit.toNanos(timeout);</span><br><span class="line">    <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">    mainLock.lock();</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="keyword">for</span> (;;) {</span><br><span class="line">            <span class="keyword">if</span> (runStateAtLeast(ctl.get(), TERMINATED))</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (nanos <= <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            <span class="comment">//é™æ—¶ç­‰å¾…</span></span><br><span class="line">            nanos = termination.awaitNanos(nanos);</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">finally</span> {</span><br><span class="line">        mainLock.unlock();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="shutdown"><a href="#shutdown" class="headerlink" title="shutdown()"></a>shutdown()</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">    mainLock.lock();</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        checkShutdownAccess();</span><br><span class="line">        <span class="comment">//CASè‡ªæ—‹è®¾ç½®çº¿ç¨‹æ± çŠ¶æ€ä¸º SHUTDOWN</span></span><br><span class="line">        advanceRunState(SHUTDOWN);</span><br><span class="line">        <span class="comment">//æ‰“æ–­idle(ç©ºé—²)çš„worker</span></span><br><span class="line">        interruptIdleWorkers(); </span><br><span class="line">        onShutdown(); <span class="comment">// hook for ScheduledThreadPoolExecutor</span></span><br><span class="line">    } <span class="keyword">finally</span> {</span><br><span class="line">        mainLock.unlock();</span><br><span class="line">    }</span><br><span class="line">    tryTerminate();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>è¿™é‡Œå…³é”®çš„å°±æ˜¯è¿™ä¸ªæ‰“æ–­ç©ºé—²çº¿ç¨‹çš„æ“ä½œã€‚</p>
<h3 id="interruptIdleWorkers"><a href="#interruptIdleWorkers" class="headerlink" title="interruptIdleWorkers()"></a>interruptIdleWorkers()</h3><p>æ‰“æ–­ç©ºé—²çš„workerï¼Œè¿™é‡Œçš„ç©ºé—²çº¿ç¨‹å…¶å®æŒ‡çš„å°±æ˜¯åœ¨é˜»å¡é˜Ÿåˆ—ä¸Šè·å–ä¸åˆ°ä»»åŠ¡è€Œé˜»å¡çš„çº¿ç¨‹</p>
<p>ç»è¿‡ä¸Šé¢çš„åˆ†ææˆ‘ä»¬çŸ¥é“Workerä¼šä¸æ–­çš„ä»é˜»å¡é˜Ÿåˆ—ä¸­å»æ‹¿ä»»åŠ¡ä¹Ÿå°±æ˜¯ <code>getTask()</code> æ–¹æ³•ï¼Œå¦‚æœé˜»å¡é˜Ÿåˆ—ä¸ºç©ºå°±ä¼šé˜»å¡ä½ ç›´åˆ°æœ‰ä»»åŠ¡æäº¤åˆ°é˜»å¡é˜Ÿåˆ—ä¸­ï¼Œæˆ–è€…æ‰§è¡Œçº¿ç¨‹è¢«ä¸­æ–­ã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬æ˜¯è¦SHUTDOWNé‚£é˜»å¡é˜Ÿåˆ—ä¸­è‚¯å®šæ˜¯ä¸ä¼šå†æœ‰ä»»åŠ¡æäº¤ï¼Œæ‰€ä»¥<code>take()</code> ä¼šé˜»å¡ä½ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±åªèƒ½é€šè¿‡æ‰“æ–­æ‰§è¡Œçº¿ç¨‹çš„æ–¹å¼æ¥æ‰“æ–­<code>take()</code> æ“ä½œï¼Œå¦åˆ™ä¼šä¸€ç›´é˜»å¡ï¼Œçº¿ç¨‹æ± æ— æ³•å…³é—­ã€‚</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">interruptIdleWorkers</span><span class="params">(<span class="keyword">boolean</span> onlyOne)</span> </span>{</span><br><span class="line">    <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">    mainLock.lock(); <span class="comment">//åŠ é”ï¼Œå› ä¸ºWokersæ˜¯HashSetæ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„</span></span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="keyword">for</span> (Worker w : workers) {</span><br><span class="line">            Thread t = w.thread;</span><br><span class="line">            <span class="comment">//æ²¡æœ‰è¢«æ‰“æ–­å¹¶ä¸”æ²¡æœ‰åœ¨å·¥ä½œ(ç©ºé—²)</span></span><br><span class="line">            <span class="keyword">if</span> (!t.isInterrupted() && w.tryLock()) {</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    <span class="comment">//æ‰“æ–­Workeré‡Œé¢çš„çº¿ç¨‹</span></span><br><span class="line">                    t.interrupt();</span><br><span class="line">                } <span class="keyword">catch</span> (SecurityException ignore) {</span><br><span class="line">                } <span class="keyword">finally</span> {</span><br><span class="line">                    w.unlock();</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">//åªæ‰“æ–­ä¸€ä¸ªå°±ç›´æ¥break</span></span><br><span class="line">            <span class="keyword">if</span> (onlyOne)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">finally</span> {</span><br><span class="line">        mainLock.unlock();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>ğŸ”¸é¦–å…ˆè·å–äº†mainLockä¿è¯äº†workersçš„çº¿ç¨‹å®‰å…¨é¿å…äº§ç”Ÿå¹¶å‘ä¿®æ”¹å¼‚å¸¸ã€‚</p>
<p>ğŸ”¸ç„¶åéå†workersï¼Œæ‰“æ–­é‚£äº›æ²¡æœ‰è¢«æ‰“æ–­å¹¶ä¸”æ²¡æœ‰å·¥ä½œçš„çº¿ç¨‹ï¼Œé‚£è¿™é‡Œæ€ä¹ˆçŸ¥é“çº¿ç¨‹æ˜¯ä¸æ˜¯åœ¨å·¥ä½œå‘¢ï¼Ÿ</p>
<p>åˆ«å¿˜äº†å‰é¢æåˆ°çš„Workerç±»å€ŸåŠ©AQSå®ç°äº†ä¸€ä¸ª<code>ä¸å¯é‡å…¥</code>çš„<code>lock</code> æ–¹æ³•ï¼Œè€Œåœ¨workeræ‰§è¡Œä»»åŠ¡çš„æ—¶å€™ä¼šæ‰§è¡Œ <code>lock</code> åŠ é”ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œ<code>tryLock()</code> å¦‚æœè¿”å›<code>true</code>åˆ™è¯´æ˜ å¹¶æ²¡æœ‰åœ¨å·¥ä½œå¯ä»¥æ‰“æ–­ï¼Œåä¹‹å¦‚æœæ­£åœ¨å·¥ä½œ<code>tryLock()</code> ä¸å¯é‡å…¥ï¼Œæ— æ³•è·å–åˆ°è‡ªå·±æŒæœ‰çš„é”è¿”å›falseï¼Œæ‰€ä»¥çº¿ç¨‹è‚¯å®šæ˜¯åœ¨å·¥ä½œçŠ¶æ€æ‰€ä»¥ä¸åº”è¯¥æ‰“æ–­ï¼Œè¿™äº›çº¿ç¨‹ä¼šåœ¨æ‰§è¡Œå®Œä»»åŠ¡åè‡ªè¡Œäº†æ–­ï¼Œå› ä¸ºçº¿ç¨‹æ± çŠ¶æ€å·²ç»è®¾ç½®ä¸º<code>SHUTDOWN</code> å½“ç„¶å‰ææ˜¯è¿™äº›ä»»åŠ¡æ˜¯<strong>å¯ç»ˆæ­¢çš„</strong></p>
<p>ğŸ”¸æ‰“æ–­åé‡Šæ”¾<code>tryLock()</code>è·å–åˆ°çš„é”</p>
<p>ğŸ”¸å¦‚æœåªæ‰“æ–­ä¸€ä¸ªå°±ç›´æ¥breakï¼Œå¦åˆ™å°±ç»§ç»­ä¸‹ä¸€è½®å¾ªç¯</p>
<p>ğŸ”¸é‡Šæ”¾mianLock</p>
<blockquote>
<p>ççŒœ: è¿™é‡Œå¯ä»¥é€šè¿‡getStateåˆ¤æ–­çº¿ç¨‹çŠ¶æ€ä½†æ˜¯æœ‰å¯èƒ½åœ¨æ‰§è¡Œä»»åŠ¡çš„è¿‡ä¸­é˜»å¡</p>
</blockquote>
<h3 id="shutdownNow"><a href="#shutdownNow" class="headerlink" title="shutdownNow()"></a>shutdownNow()</h3><p>å’Œä¸Šé¢çš„shutdown()ä¸€æ ·éƒ½æ˜¯ç”¨æ¥å…³é—­çº¿ç¨‹æ± çš„ä½†æ˜¯çœ‹æ–¹æ³•åå°±çŸ¥é“è¿™ä¸ªæ¯”è¾ƒç²—æš´ï¼ŒshutdownNowç«‹åˆ»é©¬ä¸Šå…³é—­ï¼Œä¸€ç‚¹æƒ…é¢éƒ½ä¸ç»™ğŸ˜‚ï¼Œè™½ç„¶è¯´æ˜¯æ‰“æ–­æ‰€æœ‰çš„çº¿ç¨‹ä½†æ˜¯æ¯•ç«Ÿä½¿ç”¨çš„æ˜¯<code>Interrupt</code> ï¼Œä¹Ÿè®¸åˆ«äººæ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹æ ¹æœ¬å°±ä¸ä¼šç†ä½ ğŸ˜‚ï¼Œæ‰€ä»¥åœ¨æäº¤ä»»åŠ¡çš„æ—¶å€™è¦å¯¹ä»»åŠ¡è¿›è¡Œæ­£ç¡®çš„interruptå“åº”ï¼Œæˆ–è€…ç¡®ä¿çº¿ç¨‹ä¸ä¼šä¸€ç›´é˜»å¡å¦åˆ™çº¿ç¨‹æ± å°±æ— æ³•æ­£å¸¸å…³é—­</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List<runnable> <span class="title">shutdownNow</span><span class="params">()</span> </runnable></span>{</span><br><span class="line">    List<runnable> tasks;</runnable></span><br><span class="line">    <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">    mainLock.lock();</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        checkShutdownAccess();</span><br><span class="line">        <span class="comment">//CASè‡ªæ—‹è®¾ç½®çŠ¶æ€ä¸ºSTOP</span></span><br><span class="line">        advanceRunState(STOP);</span><br><span class="line">        <span class="comment">//æ‰“æ–­æ‰€æœ‰çš„çº¿ç¨‹åŒ…æ‹¬æ­£åœ¨å·¥ä½œçš„çº¿ç¨‹</span></span><br><span class="line">        interruptWorkers();</span><br><span class="line">        <span class="comment">//æ’å¹²é˜»å¡é˜Ÿåˆ—ï¼Œå› ä¸ºå·²ç»STOPäº†ä¸ä¼šå†æ‰§è¡Œé˜Ÿåˆ—é‡Œé¢çš„ä»»åŠ¡äº†</span></span><br><span class="line">        tasks = drainQueue();</span><br><span class="line">    } <span class="keyword">finally</span> {</span><br><span class="line">        mainLock.unlock();</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//å°è¯•å…³é—­çº¿ç¨‹æ± </span></span><br><span class="line">    tryTerminate();</span><br><span class="line">    <span class="keyword">return</span> tasks;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="interruptWorkers"><a href="#interruptWorkers" class="headerlink" title="interruptWorkers()"></a>interruptWorkers()</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">interruptWorkers</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">    mainLock.lock();</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="keyword">for</span> (Worker w : workers)</span><br><span class="line">            <span class="comment">//æ‰“æ–­æ‰€æœ‰å¯åŠ¨çš„çº¿ç¨‹</span></span><br><span class="line">            w.interruptIfStarted();</span><br><span class="line">    } <span class="keyword">finally</span> {</span><br><span class="line">        mainLock.unlock();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>æ‰“æ–­äº†æ‰€æœ‰çš„å¯åŠ¨çš„çº¿ç¨‹ï¼Œå³ä½¿ä»–ä»¬å¯èƒ½ä¸ä¼šå“åº”è¿™ä¸ªInterruptedä¿¡å·ï¼Œä½†æ˜¯ç”±äºçº¿ç¨‹æ± çŠ¶æ€å·²ç»å˜ä¸ºäº†STOPï¼Œæ‰€ä»¥ä»–ä»¬ä¹Ÿæ´»ä¸é•¿äº†(å½“ç„¶å‰ææ˜¯æ‰§è¡Œçš„ä»»åŠ¡æ˜¯å¯ä»¥ç»“æŸçš„)ï¼Œåœ¨ä¸‹ä¸€æ¬¡è·å–ä»»åŠ¡çš„æ—¶å€™å°±ä¼šç›´æ¥return ã€‚</p>
<h2 id="ThreadPoolExecutorä½¿ç”¨"><a href="#ThreadPoolExecutorä½¿ç”¨" class="headerlink" title="ThreadPoolExecutorä½¿ç”¨"></a>ThreadPoolExecutorä½¿ç”¨</h2><h3 id="æ„é€ æ–¹æ³•"><a href="#æ„é€ æ–¹æ³•" class="headerlink" title="æ„é€ æ–¹æ³•"></a>æ„é€ æ–¹æ³•</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ThreadPoolExecutor</span><span class="params">(<span class="keyword">int</span> corePoolSize,</span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="keyword">int</span> maximumPoolSize,</span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="keyword">long</span> keepAliveTime,</span></span></span><br><span class="line"><span class="function"><span class="params">                          TimeUnit unit,</span></span></span><br><span class="line"><span class="function"><span class="params">                          BlockingQueue<runnable> workQueue,</runnable></span></span></span><br><span class="line"><span class="function"><span class="params">                          ThreadFactory threadFactory,</span></span></span><br><span class="line"><span class="function"><span class="params">                          RejectedExecutionHandler handler)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (corePoolSize < <span class="number">0</span> ||</span><br><span class="line">        maximumPoolSize <= <span class="number">0</span> ||</span><br><span class="line">        maximumPoolSize < corePoolSize ||</span><br><span class="line">        keepAliveTime < <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">    <span class="keyword">if</span> (workQueue == <span class="keyword">null</span> || threadFactory == <span class="keyword">null</span> || handler == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    <span class="keyword">this</span>.acc = System.getSecurityManager() == <span class="keyword">null</span> ?</span><br><span class="line">            <span class="keyword">null</span> :</span><br><span class="line">            AccessController.getContext();</span><br><span class="line">    <span class="keyword">this</span>.corePoolSize = corePoolSize;</span><br><span class="line">    <span class="keyword">this</span>.maximumPoolSize = maximumPoolSize;</span><br><span class="line">    <span class="keyword">this</span>.workQueue = workQueue;</span><br><span class="line">    <span class="keyword">this</span>.keepAliveTime = unit.toNanos(keepAliveTime);</span><br><span class="line">    <span class="keyword">this</span>.threadFactory = threadFactory;</span><br><span class="line">    <span class="keyword">this</span>.handler = handler;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>å…¶å®ä»ä¸­ä¹Ÿå¯ä»¥çœ‹å‡ºå¯¹å„ä¸ªå‚æ•°çš„ä¸€äº›é™åˆ¶ã€‚</p>
<p><strong>corePoolSizeï¼š</strong>æ ¸å¿ƒæ± çš„å¤§å°ï¼Œè¿™ä¸ªå‚æ•°ä¸åé¢è®²è¿°çš„çº¿ç¨‹æ± çš„å®ç°åŸç†æœ‰éå¸¸å¤§çš„å…³ç³»ã€‚åœ¨åˆ›å»ºäº†çº¿ç¨‹æ± åï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œçº¿ç¨‹æ± ä¸­å¹¶æ²¡æœ‰ä»»ä½•çº¿ç¨‹ï¼Œè€Œæ˜¯ç­‰å¾…æœ‰ä»»åŠ¡åˆ°æ¥æ‰åˆ›å»ºçº¿ç¨‹å»æ‰§è¡Œä»»åŠ¡ï¼Œé™¤éè°ƒç”¨äº†<code>prestartAllCoreThreads()</code>æˆ–è€…<code>prestartCoreThread()</code>æ–¹æ³•ï¼Œä»è¿™2ä¸ªæ–¹æ³•çš„åå­—å°±å¯ä»¥çœ‹å‡ºï¼Œæ˜¯é¢„åˆ›å»ºçº¿ç¨‹çš„æ„æ€ï¼Œå³åœ¨æ²¡æœ‰ä»»åŠ¡åˆ°æ¥ä¹‹å‰å°±åˆ›å»ºcorePoolSizeä¸ªçº¿ç¨‹æˆ–è€…ä¸€ä¸ªçº¿ç¨‹ã€‚<code>é»˜è®¤æƒ…å†µä¸‹</code>ï¼Œåœ¨åˆ›å»ºäº†çº¿ç¨‹æ± åï¼Œçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°ä¸º0ï¼Œå½“æœ‰ä»»åŠ¡æ¥ä¹‹åï¼Œå°±ä¼šåˆ›å»ºä¸€ä¸ªçº¿ç¨‹å»æ‰§è¡Œä»»åŠ¡ï¼Œå½“çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°ç›®è¾¾åˆ°corePoolSizeåï¼Œå°±ä¼šæŠŠåˆ°è¾¾çš„ä»»åŠ¡æ”¾åˆ°ç¼“å­˜é˜Ÿåˆ—å½“ä¸­</p>
<p><strong>maximumPoolSizeï¼š</strong>çº¿ç¨‹æ± æœ€å¤§çº¿ç¨‹æ•°ï¼Œå®ƒè¡¨ç¤ºåœ¨çº¿ç¨‹æ± ä¸­æœ€å¤šå…è®¸åˆ›å»ºå¤šå°‘ä¸ªçº¿ç¨‹</p>
<p><strong>keepAliveTime</strong>ï¼šè¡¨ç¤ºçº¿ç¨‹æ²¡æœ‰ä»»åŠ¡æ‰§è¡Œæ—¶æœ€å¤šä¿æŒå¤šä¹…æ—¶é—´ä¼šç»ˆæ­¢ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œåªæœ‰å½“<code>çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°å¤§äºcorePoolSizeæ—¶</code>ï¼ŒkeepAliveTimeæ‰ä¼šèµ·ä½œç”¨ï¼Œç›´åˆ°çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°ä¸å¤§äºcorePoolSizeï¼šå³å½“çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°å¤§äº<code>corePoolSize</code>æ—¶ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹ç©ºé—²çš„æ—¶é—´è¾¾åˆ°keepAliveTimeï¼Œåˆ™ä¼šç»ˆæ­¢ï¼Œç›´åˆ°çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°ä¸è¶…è¿‡corePoolSizeï¼Œä½†æ˜¯å¦‚æœè°ƒç”¨äº†<code>allowCoreThreadTimeOut(boolean)</code>æ–¹æ³•ï¼Œåœ¨çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°ä¸å¤§äºcorePoolSizeæ—¶ï¼ŒkeepAliveTimeå‚æ•°ä¹Ÿä¼šèµ·ä½œç”¨ï¼Œç›´åˆ°çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°ä¸º0ï¼Œè¿™äº›å†…å®¹å…¶å®åœ¨ä¸Šé¢çš„æ·±å…¥æºç ä¸­éƒ½æœ‰è¿‡åˆ†æã€‚</p>
<p><strong>unitï¼š</strong>å‚æ•°keepAliveTimeçš„æ—¶é—´å•ä½</p>
<p><strong>workQueue</strong>ï¼šä¸€ä¸ªé˜»å¡é˜Ÿåˆ—ï¼Œç”¨æ¥å­˜å‚¨ç­‰å¾…æ‰§è¡Œçš„ä»»åŠ¡ï¼Œè¿™ä¸ªå‚æ•°çš„é€‰æ‹©ä¼šå¯¹çº¿ç¨‹æ± çš„è¿è¡Œè¿‡ç¨‹äº§ç”Ÿé‡å¤§å½±å“</p>
<p><strong>threadFactory</strong>ï¼šçº¿ç¨‹å·¥å‚ï¼Œä¸»è¦ç”¨æ¥åˆ›å»ºçº¿ç¨‹(æ ¹æ®ä¼ è¿›æ¥çš„Runnable/Callable)</p>
<p><strong>handler</strong>ï¼šè¡¨ç¤ºå½“æ‹’ç»å¤„ç†ä»»åŠ¡æ—¶çš„ç­–ç•¥ï¼Œæœ‰ä»¥ä¸‹å››ç§å–å€¼</p>
<ul>
<li><strong>ThreadPoolExecutor.AbortPolicy</strong> ä¸¢å¼ƒä»»åŠ¡å¹¶æŠ›å‡ºRejectedExecutionExceptionå¼‚å¸¸ã€‚ </li>
<li><strong>ThreadPoolExecutor.DiscardPolicy</strong> ä¹Ÿæ˜¯ä¸¢å¼ƒä»»åŠ¡ï¼Œä½†æ˜¯ä¸æŠ›å‡ºå¼‚å¸¸ã€‚ </li>
<li><strong>ThreadPoolExecutor.DiscardOldestPolicy</strong> ä¸¢å¼ƒé˜Ÿåˆ—æœ€å‰é¢çš„ä»»åŠ¡ï¼Œç„¶åé‡æ–°å°è¯•æ‰§è¡Œä»»åŠ¡ï¼ˆé‡å¤æ­¤è¿‡ç¨‹ï¼‰</li>
<li><strong>ThreadPoolExecutor.CallerRunsPolicy</strong>  ç”±è°ƒç”¨çº¿ç¨‹å¤„ç†è¯¥ä»»åŠ¡ </li>
</ul>
<h3 id="çº¿ç¨‹æ± çš„å…³é—­"><a href="#çº¿ç¨‹æ± çš„å…³é—­" class="headerlink" title="çº¿ç¨‹æ± çš„å…³é—­"></a>çº¿ç¨‹æ± çš„å…³é—­</h3><p><code>shutdown()</code>  <code>shutdownNow()</code> ï¼Œä¸Šé¢å·²ç»åˆ†æè¿‡äº†ï¼Œå°±ä¸å†è¿‡å¤šä»‹ç»äº†ã€‚</p>
<h3 id="å·¥å‚æ–¹æ³•"><a href="#å·¥å‚æ–¹æ³•" class="headerlink" title="å·¥å‚æ–¹æ³•"></a>å·¥å‚æ–¹æ³•</h3><p>ä¸Šé¢çš„æ„é€ å™¨ä¸­ä¸€å…±æœ‰7ä¸ªå‚æ•°ï¼Œå¯è§è¦æ„é€ ä¸€ä¸ªçº¿ç¨‹æ± å¹¶éé‚£ä¹ˆå®¹æ˜“ï¼Œæ‰€ä»¥jdk åœ¨<code>Executors</code> ç±»ä¸­ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€äº›å·¥å‚æ–¹æ³•ï¼Œå¯ä»¥ç›´æ¥æ„é€ ä¸€äº›ç‰¹å®šçš„çº¿ç¨‹æ± ã€‚</p>
<p><strong>newCachedThreadPool()</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title">newCachedThreadPool</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ThreadPoolExecutor(<span class="number">0</span>, Integer.MAX_VALUE,</span><br><span class="line">                                  <span class="number">60L</span>, TimeUnit.SECONDS,</span><br><span class="line">                                  <span class="keyword">new</span> SynchronousQueue<runnable>());</runnable></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>å¯ä»¥çœ‹åˆ°<code>core</code>ä¸º0ï¼Œæœ€å¤§å€¼ä¸º<code>Integer.MAX_VALUE</code>ï¼Œä»»åŠ¡é˜Ÿåˆ—ä½¿ç”¨çš„<code>SynchronousQueue</code> ï¼Œè¿™ä¸ªé˜Ÿåˆ—æ˜¯ä¸€ä¸ªå¾ˆå¥‡è‘©çš„é˜»å¡é˜Ÿåˆ—ï¼Œå®é™…ä¸Šå®ƒä¸æ˜¯ä¸€ä¸ªçœŸæ­£çš„é˜Ÿåˆ—ï¼Œæ¯ä¸ªåˆ é™¤æ“ä½œéƒ½è¦ç­‰å¾…æ’å…¥æ“ä½œï¼Œåä¹‹æ¯ä¸ªæ’å…¥æ“ä½œä¹Ÿéƒ½è¦ç­‰å¾…åˆ é™¤åŠ¨ä½œï¼Œåªæœ‰ä¸¤ä¸ªéƒ½å‡†å¤‡å¥½çš„æ—¶å€™æ‰ä¸ä¼šé˜»å¡ï¼Œæ‰€ä»¥å®ƒå†…éƒ¨ä¸ä¼šä¸ºé˜Ÿåˆ—å…ƒç´ ç»´æŠ¤ç©ºé—´ï¼Œä¹Ÿå°±æ˜¯è¯´å¹¶ä¸ä¼šç¼“å­˜ä»»åŠ¡ï¼Œä¸€æ—¦æäº¤äº†(put)ä»»åŠ¡ï¼Œè¦ä¹ˆå°±ç”±ç©ºé—²çº¿ç¨‹å»æ‰§è¡Œ(take)ï¼Œè¦ä¹ˆåˆ›å»ºä¸€æ¡æ–°çº¿ç¨‹å»æ‰§è¡Œ(take)ã€‚</p>
<p><strong>newFixedThreadPool()</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title">newFixedThreadPool</span><span class="params">(<span class="keyword">int</span> nThreads)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ThreadPoolExecutor(nThreads, nThreads,</span><br><span class="line">                                  <span class="number">0L</span>, TimeUnit.MILLISECONDS,</span><br><span class="line">                                  <span class="keyword">new</span> LinkedBlockingQueue<runnable>());</runnable></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>å¯ä»¥çœ‹åˆ°ï¼Œæœ€å¤§å€¼å’Œcoreéƒ½æ˜¯ <code>nThread</code> ï¼Œä¹Ÿå°±æ˜¯æœ€å¤š<code>nThread</code>ä¸ªçº¿ç¨‹ï¼Œé˜»å¡é˜Ÿåˆ—é‡‡ç”¨ <code>LinkedBlockQueue</code> </p>
<p><strong>newSingleThreadExecutor()</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title">newSingleThreadExecutor</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> FinalizableDelegatedExecutorService</span><br><span class="line">        (<span class="keyword">new</span> ThreadPoolExecutor(<span class="number">1</span>, <span class="number">1</span>,</span><br><span class="line">                                <span class="number">0L</span>, TimeUnit.MILLISECONDS,</span><br><span class="line">                                <span class="keyword">new</span> LinkedBlockingQueue<runnable>()));</runnable></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>ç­‰ä»·äº<code>newFixedThreadPool(1)</code> ï¼Œä½†æ˜¯è¿™é‡Œçš„è¿”å›å€¼ç»è¿‡äº†ä¸€å±‚åŒ…è£… è¿”å›çš„ä¸å†æ˜¯<code>ThreadPoolExecutor</code> ä¹Ÿå°±æ˜¯ä¸ä¼šå†æœ‰é‚£äº›æ‰©å±•çš„monitoræ–¹æ³•</p>
<blockquote>
<p>A wrapper class that exposes only the ExecutorService methods  of an ExecutorService implementation.</p>
</blockquote>
<p>ç±»ä¼¼çš„æ–¹æ³•å…¶å®è¿˜æœ‰ä¸€äº›ï¼Œåƒ<code>newWorkStealingPool</code> ç­‰ï¼Œæ„Ÿå…´è¶£å¯ä»¥è‡ªå·±å»æŸ¥ä¸€æŸ¥ã€‚</p>
<p>å…¶å®è¿™é‡Œé˜¿é‡Œå·´å·´Javaå¼€å‘è§„èŒƒå¹¶ä¸å»ºè®®ä½¿ç”¨å·¥å‚æ–¹æ³•åˆ›å»ºçº¿ç¨‹</p>
<p><img alt="mark" data-src="http://static.imlgw.top/blog/20190806/lMVPdlPqEPNO.png?imageslim" src="/img/loading.gif" class="lazyload"></p>
<p>æ‰€ä»¥å»ºè®®è¿˜æ˜¯é€šè¿‡æ„é€ å™¨çš„æ–¹å¼å»åˆ›å»ºçº¿ç¨‹ï¼Œè¿™æ ·ä¹Ÿæ›´åŠ çµæ´»æ›´åŠ å¯æ§ã€‚</p>
</body></html></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">æ–‡ç« ä½œè€…: </span><span class="post-copyright-info"><a href="mailto:undefined">imlgw</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">æ–‡ç« é“¾æ¥: </span><span class="post-copyright-info"><a href="http://imlgw.top/2019/07/30/executor-kuang-jia/">http://imlgw.top/2019/07/30/executor-kuang-jia/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">ç‰ˆæƒå£°æ˜: </span><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥è‡ª <a href="http://imlgw.top">iMlGw0</a>ï¼</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/">å¤šçº¿ç¨‹    </a><a class="post-meta__tags" href="/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/">å¹¶å‘ç¼–ç¨‹    </a></div><div class="post_share"><div class="social-share" data-image="http://static.imlgw.top/blog/20190806/wdUz2J3lFXcL.jpg?imageslim" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> æ‰“èµ<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/wechat.png" alt="å¾®ä¿¡"><div class="post-qr-code__desc">å¾®ä¿¡</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/alipay.png" alt="æ”¯ä»˜å¯¶"><div class="post-qr-code__desc">æ”¯ä»˜å¯¶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2019/08/07/zu-sai-dui-lie/"><img class="prev_cover lazyload" data-src="http://static.imlgw.top/image/featureimages/4.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">ä¸Šä¸€ç¯‡</div><div class="prev_info"><span>é˜»å¡é˜Ÿåˆ—</span></div></a></div><div class="next-post pull_right"><a href="/2019/07/24/bing-fa-gong-ju-bao/"><img class="next_cover lazyload" data-src="http://static.imlgw.top/blog/20190728/XWFUH8Oxezjr.jpg?imageslim" onerror="onerror=null;src='/img/404.jpg'"><div class="label">ä¸‹ä¸€ç¯‡</div><div class="next_info"><span>JUCå¹¶å‘å·¥å…·åŒ…</span></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> ç›¸å…³æ¨è</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2019/08/10/zi-xuan-suo-clh-suo-mcs-suo/" title="è‡ªæ—‹é”ï¼ŒCLHé”ï¼ŒMCSé”"><img class="relatedPosts_cover lazyload"data-src="http://static.imlgw.top/blog/20190810/eUpUP2rgLLol.jpg?imageslim"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2019-12-23</div><div class="relatedPosts_title">è‡ªæ—‹é”ï¼ŒCLHé”ï¼ŒMCSé”</div></div></a></div><div class="relatedPosts_item"><a href="/2019/04/22/cas-yu-yuan-zi-bian-liang/" title="CASä¸åŸå­å˜é‡"><img class="relatedPosts_cover lazyload"data-src="http://static.imlgw.top/image/20190713/wallhaven-zmpd3j.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2019-12-23</div><div class="relatedPosts_title">CASä¸åŸå­å˜é‡</div></div></a></div><div class="relatedPosts_item"><a href="/2019/04/29/volatile-guan-jian-zi/" title="Volatileå…³é”®å­—è¯¦è§£"><img class="relatedPosts_cover lazyload"data-src="http://static.imlgw.top///20190429/O1leMFc6AcR4.png?imageslim"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2019-12-23</div><div class="relatedPosts_title">Volatileå…³é”®å­—è¯¦è§£</div></div></a></div></div><div class="clear_both"></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> è¯„è®º</span></div><div class="vcomment" id="vcomment"></div><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify = false == true ? true : false;
var verify = true == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;

window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'MkcXmeDvktRNBDBrVqb9KYPH-MdYXbMMI',
  appKey:'swDnb5a9u9Ksp2Rwkdm7Qulh',
  placeholder:'ç•™ä¸‹é‚®ç®±æ‰èƒ½æ”¶åˆ°åŠæ—¶æ”¶åˆ°å›å¤~~',
  avatar:'monsterid',
  guest_info:guest_info,
  pageSize:'10',
  lang:'zh-cn',
  recordIP: true
});</script></div></div></main><footer id="footer" style="background-image: url(http://static.imlgw.top/blog/20190806/wdUz2J3lFXcL.jpg?imageslim)" data-type="photo"><div id="footer-wrap"><div class="copyright">&copy;2018 - 2019 By imlgw</div><div class="framework-info"><span>é©±åŠ¨ </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>ä¸»é¢˜ </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div><div class="icp"><a href="http://beian.miit.gov.cn/publish/query/indexFirst.action" target="_blank" rel="noopener"><span>é„‚ICPå¤‡18011208å·</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="é˜…è¯»æ¨¡å¼"></i><i class="fa fa-plus" id="font_plus" title="æ”¾å¤§å­—ä½“"></i><i class="fa fa-minus" id="font_minus" title="ç¼©å°å­—ä½“"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="ç®€ç¹è½¬æ¢" target="_self">ç°¡</a></div><div id="rightside-config-show"><div id="rightside_config" title="è®¾ç½®"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="ç›´è¾¾è¯„è®º"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="ç›®å½•" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="å›åˆ°é¡¶éƒ¨" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script id="ribbon_piao" mobile="undefined" src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/js/piao.js"></script><script src="https://cdn.jsdelivr.net/npm/activate-power-mode/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true; 
document.body.addEventListener('input', POWERMODE);
</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">æœ¬åœ°æœç´¢</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="æœç´¢æ–‡ç« "></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>ç”±</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49B1F5;">hexo-generator-search</a>
 <span>æä¾›æ”¯æŒ</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/live2d-widget@3.x/lib/L2Dwidget.min.js"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"https://cdn.jsdelivr.net/npm/live2d-widget-model-hijiki@1.0.5/assets/hijiki.model.json"},"display":{"superSample":2,"width":160,"height":320,"position":"right","hOffset":0,"vOffset":-70},"mobile":{"show":false,"scale":0.2},"log":false});</script></body></html>