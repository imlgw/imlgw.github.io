
<!DOCTYPE html>
<html lang="zh-CN">


<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#202020"/>
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>
  
  
    <meta name="keywords" content="å¤šçº¿ç¨‹,å¹¶å‘ç¼–ç¨‹," />
  

  
    <meta name="description" content="å¤§æ‚²æ— æ³ªï¼Œå¤§æ‚Ÿæ— è¨€ï¼Œå¤§ç¬‘æ— å£°ã€‚" />
  
  
  
  <link rel="icon" type="image/x-icon" href="/img/cat.ico">
  
  <title>Javaå¤šçº¿ç¨‹åŸºç¡€ [ iM1Gw0 ]</title>
  
    <!-- stylesheets list from config.yml -->
    
      <link rel="stylesheet" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css">
    
      <link rel="stylesheet" href="/css/xoxo.css">
    
  
<meta name="generator" content="Hexo 4.2.0"><link rel="stylesheet" href="/css/prism.css" type="text/css"></head>


<body>
  <div class="nav-container">
    <nav class="home-menu pure-menu pure-menu-horizontal">
  <a class="pure-menu-heading" href="/">
    
    <span class="title" style="text-transform:none">iM1Gw0</span>
  </a>

  <ul class="pure-menu-list clearfix">
      
          
            
              <li class="pure-menu-item"><a href="/" class="pure-menu-link">é¦–é¡µ</a></li>
            
          
      
          
            
              <li class="pure-menu-item pure-menu-has-children pure-menu-allow-hover">
            
              <a href="#" id="post" class="pure-menu-link">æ–‡ç« </a>
              <ul class="pure-menu-children">
              
                  
                    <li class="pure-menu-item"><a href="/categories" style="color:#202020;" class="pure-menu-link">åˆ†ç±»</a></li>
                  
              
                  
                    <li class="pure-menu-item"><a href="/archives" style="color:#202020;" class="pure-menu-link">å½’æ¡£</a></li>
                  
              
                  
                    <li class="pure-menu-item"><a href="/tags" style="color:#202020;" class="pure-menu-link">æ ‡ç­¾</a></li>
                  
              
                  
                    <li class="pure-menu-item"><a href="/music" style="color:#202020;" class="pure-menu-link">éŸ³ä¹</a></li>
                  
              
              </ul>
            </li>
          
      
          
            
              <li class="pure-menu-item pure-menu-has-children pure-menu-allow-hover">
            
              <a href="#" id="ç®—æ³•" class="pure-menu-link">ç®—æ³•</a>
              <ul class="pure-menu-children">
              
                  
                    <li class="pure-menu-item"><a href="http://imlgw.top/2019/05/04/leetcode-shu-zu/" style="color:#202020;" class="pure-menu-link">æ•°ç»„</a></li>
                  
              
                  
                    <li class="pure-menu-item"><a href="http://imlgw.top/2019/02/27/leetcode-lian-biao/" style="color:#202020;" class="pure-menu-link">é“¾è¡¨</a></li>
                  
              
                  
                    <li class="pure-menu-item"><a href="http://imlgw.top/2019/10/01/leetcode-zhan-dui-lie/" style="color:#202020;" class="pure-menu-link">æ ˆ&amp;é˜Ÿåˆ—</a></li>
                  
              
                  
                    <li class="pure-menu-item"><a href="http://imlgw.top/2019/09/15/leetcode-cha-zhao/" style="color:#202020;" class="pure-menu-link">æŸ¥æ‰¾</a></li>
                  
              
                  
                    <li class="pure-menu-item"><a href="http://imlgw.top/2019/07/20/leetcode-hua-dong-chuang-kou/" style="color:#202020;" class="pure-menu-link">æ»‘åŠ¨çª—å£</a></li>
                  
              
                  
                    <li class="pure-menu-item"><a href="http://imlgw.top/2019/09/01/leetcode-dong-tai-gui-hua/" style="color:#202020;" class="pure-menu-link">åŠ¨æ€è§„åˆ’</a></li>
                  
              
                  
                    <li class="pure-menu-item"><a href="http://imlgw.top/2019/12/06/leetcode-er-fen-cha-zhao/" style="color:#202020;" class="pure-menu-link">äºŒåˆ†æŸ¥æ‰¾</a></li>
                  
              
                  
                    <li class="pure-menu-item"><a href="http://imlgw.top/2019/11/06/leetcode-er-cha-shu/" style="color:#202020;" class="pure-menu-link">äºŒå‰æ ‘</a></li>
                  
              
                  
                    <li class="pure-menu-item"><a href="http://imlgw.top/2019/11/29/leetcode-bei-bao-wen-ti/" style="color:#202020;" class="pure-menu-link">èƒŒåŒ…é—®é¢˜</a></li>
                  
              
                  
                    <li class="pure-menu-item"><a href="http://imlgw.top/2019/10/10/leetcode-hui-su/" style="color:#202020;" class="pure-menu-link">å›æº¯</a></li>
                  
              
                  
                    <li class="pure-menu-item"><a href="http://imlgw.top/2020/01/21/leetcode-tan-xin/" style="color:#202020;" class="pure-menu-link">è´ªå¿ƒ</a></li>
                  
              
                  
                    <li class="pure-menu-item"><a href="http://imlgw.top/2020/07/03/leetcode-wei-yun-suan/" style="color:#202020;" class="pure-menu-link">ä½è¿ç®—</a></li>
                  
              
                  
                    <li class="pure-menu-item"><a href="http://imlgw.top/2020/08/28/leetcode-dan-diao-zhan/" style="color:#202020;" class="pure-menu-link">å•è°ƒæ ˆ</a></li>
                  
              
              </ul>
            </li>
          
      
          
            
              <li class="pure-menu-item"><a href="/project" class="pure-menu-link">Github</a></li>
            
          
      
          
            
              <li class="pure-menu-item"><a href="/search" class="pure-menu-link">æœç´¢</a></li>
            
          
      
          
            
              <li class="pure-menu-item"><a href="/about" class="pure-menu-link">å…³äº</a></li>
            
          
      
  </ul>
   
</nav>

  </div>

  <div class="container" id="content-outer">
    <div class="inner" id="content-inner">
      <div class="post-container">
  <article class="post" id="post">
    <header class="post-header text-center">
      <h1 class="title">
        Javaå¤šçº¿ç¨‹åŸºç¡€
      </h1>
      <span>
        
        <time class="time" datetime="2019-04-07T04:00:00.000Z">
        2019-04-07
      </time>
        
      </span>
      <span class="slash">/</span>
      <span class="post-meta">
      <span class="post-tags">
        <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" rel="tag">å¤šçº¿ç¨‹</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" rel="tag">å¹¶å‘ç¼–ç¨‹</a></li></ul>
      </span>
    </span>
      <span class="slash">/</span>
      <span class="read">
      <span id="busuanzi_value_page_pv"></span> ç‚¹å‡»
    </span>
      <span class="slash">/</span>
      <span class="read">é˜…è¯»è€—æ—¶ 100 åˆ†é’Ÿ</span>
    </header>

    <div class="post-content">
      <h2 id="1-çº¿ç¨‹ä¸è¿›ç¨‹åŒºåˆ«"><a href="#1-çº¿ç¨‹ä¸è¿›ç¨‹åŒºåˆ«" class="headerlink" title="1.çº¿ç¨‹ä¸è¿›ç¨‹åŒºåˆ«"></a>1.çº¿ç¨‹ä¸è¿›ç¨‹åŒºåˆ«</h2><p>æ¯ä¸ªæ­£åœ¨ç³»ç»Ÿä¸Šè¿è¡Œçš„ç¨‹åºéƒ½æ˜¯ä¸€ä¸ªè¿›ç¨‹ã€‚æ¯ä¸ªè¿›ç¨‹åŒ…å«ä¸€åˆ°å¤šä¸ªçº¿ç¨‹ã€‚çº¿ç¨‹æ˜¯ä¸€ç»„æŒ‡ä»¤çš„é›†åˆï¼Œæˆ–è€…æ˜¯ç¨‹åºçš„ç‰¹æ®Šæ®µï¼Œå®ƒå¯ä»¥åœ¨ç¨‹åºé‡Œç‹¬ç«‹æ‰§è¡Œã€‚ä¹Ÿå¯ä»¥æŠŠå®ƒç†è§£ä¸ºä»£ç è¿è¡Œçš„ä¸Šä¸‹æ–‡ã€‚æ‰€ä»¥çº¿ç¨‹åŸºæœ¬ä¸Šæ˜¯è½»é‡çº§çš„è¿›ç¨‹ï¼Œå®ƒè´Ÿè´£åœ¨å•ä¸ªç¨‹åºé‡Œæ‰§è¡Œå¤šä»»åŠ¡ã€‚é€šå¸¸ç”±æ“ä½œç³»ç»Ÿè´Ÿè´£å¤šä¸ªçº¿ç¨‹çš„è°ƒåº¦å’Œæ‰§è¡Œã€‚</p>
<p>ä½¿ç”¨çº¿ç¨‹å¯ä»¥æŠŠå æ®æ—¶é—´é•¿çš„ç¨‹åºä¸­çš„ä»»åŠ¡æ”¾åˆ°åå°å»å¤„ç†ï¼Œç¨‹åºçš„è¿è¡Œé€Ÿåº¦å¯èƒ½åŠ å¿«ï¼Œåœ¨ä¸€äº›ç­‰å¾…çš„ä»»åŠ¡å®ç°ä¸Šå¦‚ç”¨æˆ·è¾“å…¥ã€æ–‡ä»¶è¯»å†™å’Œç½‘ç»œæ”¶å‘æ•°æ®ç­‰ï¼Œçº¿ç¨‹å°±æ¯”è¾ƒæœ‰ç”¨äº†ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹å¯ä»¥é‡Šæ”¾ä¸€äº›çè´µçš„èµ„æºå¦‚å†…å­˜å ç”¨ç­‰ç­‰ã€‚</p>
<p>å¦‚æœæœ‰å¤§é‡çš„çº¿ç¨‹,ä¼šå½±å“æ€§èƒ½ï¼Œå› ä¸ºæ“ä½œç³»ç»Ÿéœ€è¦åœ¨å®ƒä»¬ä¹‹é—´åˆ‡æ¢ï¼Œæ›´å¤šçš„çº¿ç¨‹éœ€è¦æ›´å¤šçš„å†…å­˜ç©ºé—´ï¼Œçº¿ç¨‹çš„ä¸­æ­¢éœ€è¦è€ƒè™‘å…¶å¯¹ç¨‹åºè¿è¡Œçš„å½±å“ã€‚é€šå¸¸å—æ¨¡å‹æ•°æ®æ˜¯åœ¨å¤šä¸ªçº¿ç¨‹é—´å…±äº«çš„ï¼Œéœ€è¦é˜²æ­¢çº¿ç¨‹æ­»é”æƒ…å†µçš„å‘ç”Ÿã€‚</p>
<p>æ€»ç»“:è¿›ç¨‹æ˜¯æ‰€æœ‰çº¿ç¨‹çš„é›†åˆï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹æ˜¯è¿›ç¨‹ä¸­çš„ä¸€æ¡æ‰§è¡Œè·¯å¾„ã€‚</p>
<h2 id="2-ä¸ºä»€ä¹ˆè¦ä½¿ç”¨å¤šçº¿ç¨‹ï¼Ÿå¤šçº¿ç¨‹åº”ç”¨åœºæ™¯ï¼Ÿ"><a href="#2-ä¸ºä»€ä¹ˆè¦ä½¿ç”¨å¤šçº¿ç¨‹ï¼Ÿå¤šçº¿ç¨‹åº”ç”¨åœºæ™¯ï¼Ÿ" class="headerlink" title="2.ä¸ºä»€ä¹ˆè¦ä½¿ç”¨å¤šçº¿ç¨‹ï¼Ÿå¤šçº¿ç¨‹åº”ç”¨åœºæ™¯ï¼Ÿ"></a>2.ä¸ºä»€ä¹ˆè¦ä½¿ç”¨å¤šçº¿ç¨‹ï¼Ÿå¤šçº¿ç¨‹åº”ç”¨åœºæ™¯ï¼Ÿ</h2><p>ç­”:ä¸»è¦èƒ½ä½“ç°åˆ°å¤šçº¿ç¨‹æé«˜ç¨‹åºæ•ˆç‡ã€‚</p>
<p>ä¸¾ä¾‹: è¿…é›·å¤šçº¿ç¨‹ä¸‹è½½ã€æ•°æ®åº“è¿æ¥æ± ã€åˆ†æ‰¹å‘é€çŸ­ä¿¡ç­‰ã€‚</p>
<h2 id="3-çº¿ç¨‹åˆ›å»ºæ–¹å¼"><a href="#3-çº¿ç¨‹åˆ›å»ºæ–¹å¼" class="headerlink" title="3.çº¿ç¨‹åˆ›å»ºæ–¹å¼"></a>3.çº¿ç¨‹åˆ›å»ºæ–¹å¼</h2><h3 id="ç»§æ‰¿Threadç±»é‡å†™runæ–¹æ³•"><a href="#ç»§æ‰¿Threadç±»é‡å†™runæ–¹æ³•" class="headerlink" title="ç»§æ‰¿Threadç±»é‡å†™runæ–¹æ³•"></a>ç»§æ‰¿Threadç±»é‡å†™runæ–¹æ³•</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PlayGame</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">50</span>; i++) &#123;</span><br><span class="line">			System.out.println(<span class="string">"PlayGame"</span> + (i + <span class="number">1</span>));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//void say() &#123;&#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ListenMusic</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">50</span>; i++) &#123;</span><br><span class="line">			System.out.println(<span class="string">"ListenMusic"</span> + (i + <span class="number">1</span>));<span class="comment">//åº•å±‚æ“ä½œå±…ç„¶æ˜¯ç”¨çš„StringBuilder</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadDemo</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		Thread music = <span class="keyword">new</span> ListenMusic();</span><br><span class="line">		Thread pg = <span class="keyword">new</span> PlayGame();</span><br><span class="line">		music.start(); <span class="comment">//ä¸‰ä¸ªçº¿ç¨‹åŒæ—¶è¿è¡ŒæŠ¢å èµ„æº</span></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			pg.start();</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">50</span>; i++) &#123;</span><br><span class="line">				System.out.println(<span class="string">"    mainæ–¹æ³•:"</span> + (i + <span class="number">1</span>));</span><br><span class="line">			&#125;</span><br><span class="line">			pg.start();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			System.out.println(<span class="string">"å‡ºç°äº†IllegalThreadStateExceptionå¼‚å¸¸"</span>);	  <span class="comment">//çº¿ç¨‹åªèƒ½å¯åŠ¨ä¸€æ¬¡</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ç§æ–¹æ³•å®˜æ–¹ä¹Ÿä¸æ¨èä½¿ç”¨å› ä¸ºJavaæ˜¯å•ç»§æ‰¿çš„ç»§æ‰¿äº†Threadç±»ä¹‹åå°±ä¸èƒ½ç»§æ‰¿å…¶ä»–çš„ç±»</p>
<h3 id="å®ç°Runnableæ¥å£"><a href="#å®ç°Runnableæ¥å£" class="headerlink" title="å®ç°Runnableæ¥å£"></a>å®ç°Runnableæ¥å£</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CreateRunnable</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (inti = <span class="number">0</span>; i&lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">			System.out.println(<span class="string">"i:"</span> + i);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadDemo2</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"-----å¤šçº¿ç¨‹åˆ›å»ºå¼€å§‹-----"</span>);</span><br><span class="line">		<span class="comment">// 1.åˆ›å»ºä¸€ä¸ªçº¿ç¨‹</span></span><br><span class="line">		CreateRunnable createThread = <span class="keyword">new</span> CreateRunnable();</span><br><span class="line">		<span class="comment">// 2.å¼€å§‹æ‰§è¡Œçº¿ç¨‹ æ³¨æ„ å¼€å¯çº¿ç¨‹ä¸æ˜¯è°ƒç”¨runæ–¹æ³•ï¼Œè€Œæ˜¯startæ–¹æ³•</span></span><br><span class="line">		System.out.println(<span class="string">"-----å¤šçº¿ç¨‹åˆ›å»ºå¯åŠ¨-----"</span>);</span><br><span class="line">		Thread thread = <span class="keyword">new</span> Thread(createThread);</span><br><span class="line">		thread.start();</span><br><span class="line">		System.out.println(<span class="string">"-----å¤šçº¿ç¨‹åˆ›å»ºç»“æŸ-----"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="åŒ¿åå†…éƒ¨ç±»"><a href="#åŒ¿åå†…éƒ¨ç±»" class="headerlink" title="åŒ¿åå†…éƒ¨ç±»"></a>åŒ¿åå†…éƒ¨ç±»</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InClass</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		 Thread thread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">				<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">					<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i&lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">						System.out.println(<span class="string">"i:"</span> + i);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;);</span><br><span class="line">		thread.start();</span><br><span class="line"></span><br><span class="line">		 <span class="comment">//lambdaè¡¨è¾¾å¼è¿˜æ˜¯æ¯”è¾ƒç®€æ´</span></span><br><span class="line">		 <span class="keyword">new</span> Thread(()-&gt; &#123;<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;<span class="number">100</span>; i++) &#123;System.out.println(<span class="string">"lambda:"</span> +i);&#125;&#125;).start();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>çº¿ç¨‹åˆ›å»ºæ–¹å¼ä¸åªè¿™äº›è¿˜æœ‰å¾ˆå¤šï¼Œåé¢å†ä»‹ç»</p>
<h3 id="Thread-ç±»ä¸­çš„start-å’Œ-run-æ–¹æ³•æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ"><a href="#Thread-ç±»ä¸­çš„start-å’Œ-run-æ–¹æ³•æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ" class="headerlink" title="Thread ç±»ä¸­çš„start() å’Œ run() æ–¹æ³•æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ"></a>Thread ç±»ä¸­çš„start() å’Œ run() æ–¹æ³•æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</h3><p>è¿™ä¸ªé—®é¢˜ç»å¸¸è¢«é—®åˆ°ï¼Œä½†è¿˜æ˜¯èƒ½ä»æ­¤åŒºåˆ†å‡ºé¢è¯•è€…å¯¹Javaçº¿ç¨‹æ¨¡å‹çš„ç†è§£ç¨‹åº¦ã€‚<code>start()</code>æ–¹æ³•è¢«ç”¨æ¥å¯åŠ¨æ–°åˆ›å»ºçš„çº¿ç¨‹ï¼Œè€Œä¸”<code>start()</code>å†…éƒ¨nativeæ–¹æ³•<code>start0()</code>è°ƒç”¨äº†run()æ–¹æ³•ï¼Œè¿™å’Œç›´æ¥è°ƒç”¨<code>run()</code>æ–¹æ³•çš„æ•ˆæœä¸ä¸€æ ·ã€‚å½“ä½ è°ƒç”¨<code>run()</code>æ–¹æ³•çš„æ—¶å€™ï¼Œåªä¼šæ˜¯åœ¨åŸæ¥çš„çº¿ç¨‹ä¸­è°ƒç”¨ï¼Œæ²¡æœ‰æ–°çš„çº¿ç¨‹å¯åŠ¨ï¼Œ<code>start()</code>æ–¹æ³•æ‰ä¼šå¯åŠ¨æ–°çº¿ç¨‹</p>
<h2 id="4-Threadæ„é€ å‡½æ•°"><a href="#4-Threadæ„é€ å‡½æ•°" class="headerlink" title="4.Threadæ„é€ å‡½æ•°"></a>4.Threadæ„é€ å‡½æ•°</h2><table>
<thead>
<tr>
<th align="left"><strong>å¸¸ç”¨çº¿ç¨‹apiæ–¹æ³•</strong></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td align="left">start()</td>
<td>å¯åŠ¨çº¿ç¨‹</td>
</tr>
<tr>
<td align="left">currentThread()</td>
<td>è·å–å½“å‰çº¿ç¨‹å¯¹è±¡</td>
</tr>
<tr>
<td align="left">getID()</td>
<td>è·å–å½“å‰çº¿ç¨‹ID   Thread-ç¼–å· è¯¥ç¼–å·ä»0å¼€å§‹</td>
</tr>
<tr>
<td align="left">getName()</td>
<td>è·å–å½“å‰çº¿ç¨‹åç§°</td>
</tr>
<tr>
<td align="left">sleep(long mill)</td>
<td>ä¼‘çœ çº¿ç¨‹</td>
</tr>
<tr>
<td align="left">Stopï¼ˆï¼‰</td>
<td>åœæ­¢çº¿ç¨‹,</td>
</tr>
<tr>
<td align="left"><strong>å¸¸ç”¨çº¿ç¨‹æ„é€ å‡½æ•°</strong></td>
<td></td>
</tr>
<tr>
<td align="left">Threadï¼ˆï¼‰</td>
<td>åˆ†é…ä¸€ä¸ªæ–°çš„ Thread å¯¹è±¡</td>
</tr>
<tr>
<td align="left">Threadï¼ˆString nameï¼‰</td>
<td>åˆ†é…ä¸€ä¸ªæ–°çš„ Threadå¯¹è±¡ï¼Œå…·æœ‰æŒ‡å®šçš„ nameæ­£å¦‚å…¶åã€‚</td>
</tr>
<tr>
<td align="left">Threadï¼ˆRunnable rï¼‰</td>
<td>åˆ†é…ä¸€ä¸ªæ–°çš„ Threadå¯¹è±¡</td>
</tr>
<tr>
<td align="left">Threadï¼ˆRunable r, String nameï¼‰</td>
<td>åˆ†é…ä¸€ä¸ªæ–°çš„ Threadå¯¹è±¡ï¼Œå…·æœ‰æŒ‡å®šçš„ nameæ­£å¦‚å…¶åã€‚</td>
</tr>
<tr>
<td align="left">Thread(ThreadGroup group, Runnable target)</td>
<td>åˆ†é…ä¸€ä¸ªæ–°çš„ Threadå¯¹è±¡ï¼Œå¦‚æœä¸ä¼ <code>ThreadGroup</code>é»˜è®¤åŠ å…¥å½“å‰çº¿ç¨‹çš„<code>ThreadGroup</code>ä¸­</td>
</tr>
<tr>
<td align="left">Thread(ThreadGroup group, Runnable target, String name)</td>
<td>åˆ†é…ä¸€ä¸ªæ–°çš„ <code>Thread</code>å¯¹è±¡ï¼Œä½¿å…¶å…·æœ‰  <code>target</code>ä½œä¸ºå…¶è¿è¡Œå¯¹è±¡ï¼Œå…·æœ‰æŒ‡å®šçš„ <code>name</code>ä½œä¸ºå…¶åç§°ï¼Œå±äº  <code>group</code>å¼•ç”¨çš„çº¿ç¨‹ç»„ã€‚</td>
</tr>
<tr>
<td align="left">Thread(ThreadGroup group, Runnable target, String name,  long stackSize)</td>
<td>åˆ†é…ä¸€ä¸ªæ–°çš„ <code>Thread</code>å¯¹è±¡ï¼Œä»¥ä¾¿å®ƒå…·æœ‰  <code>target</code>ä½œä¸ºå…¶è¿è¡Œå¯¹è±¡ï¼Œå°†æŒ‡å®šçš„ <code>name</code>æ­£å¦‚å…¶åï¼Œä»¥åŠå±äºè¯¥çº¿ç¨‹ç»„ç”±ç§°ä½œ  <code>group</code> ï¼Œå¹¶å…·æœ‰æŒ‡å®šçš„ <em>å †æ ˆå¤§å°</em></td>
</tr>
</tbody></table>
<h3 id="Threadæ„é€ æ–¹æ³•çš„ä¸€äº›ç»†èŠ‚"><a href="#Threadæ„é€ æ–¹æ³•çš„ä¸€äº›ç»†èŠ‚" class="headerlink" title="Threadæ„é€ æ–¹æ³•çš„ä¸€äº›ç»†èŠ‚"></a>Threadæ„é€ æ–¹æ³•çš„ä¸€äº›ç»†èŠ‚</h3><p>ç›´æ¥ä¸Šæºç </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ThreadGroup g, Runnable target, String name,</span></span></span><br><span class="line"><span class="function"><span class="params">                  <span class="keyword">long</span> stackSize, AccessControlContext acc,</span></span></span><br><span class="line"><span class="function"><span class="params">                  <span class="keyword">boolean</span> inheritThreadLocals)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (name == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"name cannot be null"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.name = name;</span><br><span class="line"></span><br><span class="line">    Thread parent = currentThread();</span><br><span class="line">    SecurityManager security = System.getSecurityManager();</span><br><span class="line">    <span class="keyword">if</span> (g == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">/* Determine if it's an applet or not */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* If there is a security manager, ask the security manager</span></span><br><span class="line"><span class="comment">               what to do. */</span></span><br><span class="line">        <span class="keyword">if</span> (security != <span class="keyword">null</span>) &#123;</span><br><span class="line">            g = security.getThreadGroup();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* If the security doesn't have a strong opinion of the matter</span></span><br><span class="line"><span class="comment">               use the parent thread group. */</span></span><br><span class="line">        <span class="keyword">if</span> (g == <span class="keyword">null</span>) &#123;</span><br><span class="line">            g = parent.getThreadGroup();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* checkAccess regardless of whether or not threadgroup is</span></span><br><span class="line"><span class="comment">           explicitly passed in. */</span></span><br><span class="line">    g.checkAccess();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Do we have the required permissions?</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">    <span class="keyword">if</span> (security != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isCCLOverridden(getClass())) &#123;</span><br><span class="line">            security.checkPermission(SUBCLASS_IMPLEMENTATION_PERMISSION);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    g.addUnstarted();</span><br><span class="line">    <span class="keyword">this</span>.group = g;</span><br><span class="line">    <span class="comment">//è¿™é‡Œç»§æ‰¿äº†çˆ¶ç±»çš„ä¸€äº›å±æ€§</span></span><br><span class="line">    <span class="keyword">this</span>.daemon = parent.isDaemon();</span><br><span class="line">    <span class="keyword">this</span>.priority = parent.getPriority();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (security == <span class="keyword">null</span> || isCCLOverridden(parent.getClass()))</span><br><span class="line">        <span class="keyword">this</span>.contextClassLoader = parent.getContextClassLoader();</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">this</span>.contextClassLoader = parent.contextClassLoader;</span><br><span class="line">    <span class="keyword">this</span>.inheritedAccessControlContext =</span><br><span class="line">        acc != <span class="keyword">null</span> ? acc : AccessController.getContext();</span><br><span class="line">    <span class="comment">//ä¼ å…¥çš„Runnableæ¥å£</span></span><br><span class="line">    <span class="keyword">this</span>.target = target;</span><br><span class="line">    setPriority(priority);</span><br><span class="line">    <span class="keyword">if</span> (inheritThreadLocals &amp;&amp; parent.inheritableThreadLocals != <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">this</span>.inheritableThreadLocals =</span><br><span class="line">        ThreadLocal.createInheritedMap(parent.inheritableThreadLocals);</span><br><span class="line">    <span class="comment">/* Stash the specified stack size in case the VM cares */</span></span><br><span class="line">    <span class="keyword">this</span>.stackSize = stackSize;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Set thread ID */</span></span><br><span class="line">    tid = nextThreadID();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>â‘  åˆ›å»ºçš„çº¿ç¨‹ä¼šç»§æ‰¿çˆ¶çº¿ç¨‹çš„ä¸€äº›å±æ€§ï¼Œæ˜¯å¦æ˜¯å®ˆæŠ¤çº¿ç¨‹ ï¼Œå’Œä¼˜å…ˆçº§ã€‚</p>
<p>â‘¡ä½¿ç”¨Thread(Runnable r)åˆ›å»ºçº¿ç¨‹æ—¶<code>this.target = target</code>ä¼ å…¥çš„<code>Runnable</code>æ¥å£åœ¨è¿™é‡Œèµ‹å€¼ç„¶åä¼šåœ¨<code>runæ–¹æ³•</code>ä¸­è¢«è°ƒç”¨ã€‚</p>
<p>â‘¢<code>stacksize</code>è¿™ä¸ªå‚æ•°ä¼šå½±å“<code>è™šæ‹Ÿæœºæ ˆ</code>çš„å¤§å°ï¼Œè¿™ä¸ªå€¼è¶Šå¤§èƒ½å­˜æ”¾çš„<code>æ ˆå¸§</code>å°±è¶Šå¤šï¼Œå¯è¾¾åˆ°çš„é€’å½’æ·±åº¦è¶Šæ·±ï¼Œä½†æ˜¯è¿™ä¸ªå‚æ•°ä¸ä¸€å®šæœ‰æ•ˆï¼Œæœ‰çš„å¹³å°å¯èƒ½å¹¶æ²¡æœ‰æ•ˆæœï¼Œå…·ä½“çš„<code>JVM</code>åº•å±‚çš„çŸ¥è¯†ç­‰åé¢å­¦åˆ°å†æ¥ç»†åŒ–</p>
<p>â‘£ä¸€ç§å¥‡æ€ªçš„å†™æ³•ï¼Œè¿™é‡Œåªä¼šæ‰§è¡Œé‡å†™<code>Thread</code>çš„<code>run</code>æ–¹æ³•ï¼Œè¿™é‡Œä»æºç ä¸Šå¯ä»¥çœ‹å‡ºæ¥ï¼Œä¼ é€’<code>Runnable</code>æ¥å£å…¶å®æ˜¯åœ¨Threadçš„runæ–¹æ³•ä¸­è°ƒç”¨äº†<code>target</code>çš„<code>run</code>æ–¹æ³•ï¼Œå¦‚æœåŒæ—¶å†<code>ç»§æ‰¿</code>Threadç±»ï¼Œé‡å†™<code>run</code>æ–¹æ³•ï¼Œè°ƒç”¨çš„å°±ä¸å†æ˜¯Threadç±»çš„runæ–¹æ³•ï¼Œè€Œæ˜¯åŒ¿åThreadå­ç±»é‡å†™çš„runæ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Thread t = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">"Runnable"</span>);</span><br><span class="line">&#125;) &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Thread"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>â‘£çº¿ç¨‹<code>tid</code>é€šè¿‡<code>threadSeqNumber</code>ä»0è‡ªå¢çš„æ¥ï¼Œmainçº¿ç¨‹æ˜¯ç¬¬<code>10</code>ä¸ªçº¿ç¨‹å› ä¸ºä¼šæœ‰ä¸€äº›å®ˆæŠ¤çº¿ç¨‹ä¼šåœ¨mainå¯åŠ¨å‰å¯åŠ¨.</p>
<h2 id="5-å®ˆæŠ¤çº¿ç¨‹"><a href="#5-å®ˆæŠ¤çº¿ç¨‹" class="headerlink" title="5.å®ˆæŠ¤çº¿ç¨‹"></a>5.å®ˆæŠ¤çº¿ç¨‹</h2><p>Javaä¸­æœ‰ä¸¤ç§çº¿ç¨‹ï¼Œä¸€ç§æ˜¯ç”¨æˆ·çº¿ç¨‹ï¼Œå¦ä¸€ç§æ˜¯å®ˆæŠ¤çº¿ç¨‹ã€‚</p>
<p>ç”¨æˆ·çº¿ç¨‹æ˜¯æŒ‡ç”¨æˆ·è‡ªå®šä¹‰åˆ›å»ºçš„çº¿ç¨‹ï¼Œä¸»çº¿ç¨‹åœæ­¢ï¼Œç”¨æˆ·çº¿ç¨‹ä¸ä¼šåœæ­¢</p>
<ul>
<li>å®ˆæŠ¤çº¿ç¨‹é¡¾åæ€ä¹‰å½“çˆ¶çº¿ç¨‹ç»“æŸæ—¶ï¼Œå®ˆæŠ¤çº¿ç¨‹ä¹Ÿä¼šè¢«åœæ­¢ã€‚</li>
<li>JVMåªæœ‰åœ¨æœ€åä¸€ä¸ªéå®ˆæŠ¤çº¿ç¨‹ç»“æŸåæ‰ä¼šé€€å‡º</li>
<li>åœ¨çº¿ç¨‹startå‰<code>setDaemon(true)</code>æ–¹æ³•è®¾ç½®ä¸ºå®ˆæŠ¤çº¿ç¨‹ï¼Œå¦åˆ™å°±ä¼šæŠ¥é”™</li>
<li>çˆ¶çº¿ç¨‹æ˜¯å®ˆæŠ¤çº¿ç¨‹ï¼Œå­çº¿ç¨‹é»˜è®¤æ˜¯å®ˆæŠ¤çº¿ç¨‹ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Daemon</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">500</span>;i++) &#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName()+i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DaemonDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[]args)</span> </span>&#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getPriority());</span><br><span class="line">        Thread r1=<span class="keyword">new</span> Thread(<span class="keyword">new</span> Daemon(),<span class="string">"åå°çº¿ç¨‹"</span>);     <span class="comment">//è®¾ç½®è¯¥çº¿ç¨‹ä¸ºåå°çº¿ç¨‹</span></span><br><span class="line">        r1.setDaemon(<span class="keyword">true</span>);                        <span class="comment">//å‰å°çº¿ç¨‹æŒ‚æ‰åï¼Œåå°çº¿ç¨‹å°±ä¼šæŒ‚æ‰</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">50</span>;i++) &#123;                   </span><br><span class="line">            System.out.println(<span class="string">"main"</span>+i);</span><br><span class="line">            <span class="keyword">if</span>(i==<span class="number">10</span>) &#123;</span><br><span class="line">                r1.start();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"ä¸»çº¿ç¨‹æ‰§è¡Œå®Œæ¯•"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="åº”ç”¨åœºæ™¯"><a href="#åº”ç”¨åœºæ™¯" class="headerlink" title="åº”ç”¨åœºæ™¯"></a>åº”ç”¨åœºæ™¯</h3><p><code>å¿ƒè·³æ£€æµ‹</code>ï¼Œåœ¨é€šä¿¡è¿‡ç¨‹ä¸­ä¼šéœ€è¦åˆ¤æ–­å¯¹æ–¹æ˜¯å¦åœ¨çº¿ï¼Œä¼šéœ€è¦åˆ›å»ºä¸€æ¡çº¿ç¨‹å»åšè¿™äº›äº‹æƒ…ï¼Œä½†æ˜¯å¦‚æœè¿™æ ·ä¼šå¯¼è‡´<code>ä¸»çº¿ç¨‹åœæ­¢å·¥ä½œ</code>äº†ï¼Œä½†æ˜¯æ£€æµ‹å¿ƒè·³çš„çº¿ç¨‹ä»ç„¶åœ¨ç»§ç»­å·¥ä½œï¼ŒJVMå°±æ— æ³•åœä¸‹æ¥ï¼Œæ˜¾ç„¶è¿™æ ·æ—¶ä¸åˆç†çš„ï¼Œè¿™æ—¶å°±å¯ä»¥æŠŠæ£€æµ‹å¿ƒè·³çš„çº¿ç¨‹è®¾ç½®ä¸º<code>å®ˆæŠ¤çº¿ç¨‹</code>ï¼Œè¿™æ ·å½“å®ƒä¸»çº¿ç¨‹åœæ­¢å·¥ä½œæ—¶å®ƒçš„å®ˆæŠ¤çº¿ç¨‹ä¹Ÿä¼šéšä¹‹åœæ­¢ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//å¿ƒè·³æ£€æµ‹MOCK</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread t = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            Thread inThread = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                    System.out.println(<span class="string">"start heart check"</span>);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">1_00</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="comment">//å°†å­çº¿ç¨‹è®¾ç½®ä¸ºå®ˆæŠ¤çº¿ç¨‹</span></span><br><span class="line">            inThread.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">            inThread.start();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">1_000</span>);</span><br><span class="line">                System.err.println(<span class="string">"Thread finish done..."</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        t.start();</span><br><span class="line">        <span class="comment">//ä¸»çº¿ç¨‹(main)--&gt;t--&gt;inThread</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="6-çº¿ç¨‹çš„çŠ¶æ€"><a href="#6-çº¿ç¨‹çš„çŠ¶æ€" class="headerlink" title="6.çº¿ç¨‹çš„çŠ¶æ€"></a>6.çº¿ç¨‹çš„çŠ¶æ€</h2><p>çº¿ç¨‹ä»åˆ›å»ºã€è¿è¡Œåˆ°ç»“æŸæ€»æ˜¯å¤„äºä¸‹é¢äº”ä¸ªçŠ¶æ€ä¹‹ä¸€ï¼šæ–°å»ºçŠ¶æ€ã€å°±ç»ªçŠ¶æ€ã€è¿è¡ŒçŠ¶æ€ã€é˜»å¡çŠ¶æ€åŠæ­»äº¡çŠ¶æ€ã€‚</p>
<p><img src="http://static.imlgw.top///20181226/WXPYz3SiidMT.png?imageslim" alt="mark"></p>
<ul>
<li><p>æ–°å»ºçŠ¶æ€<br>å½“ç”¨newæ“ä½œç¬¦åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ—¶ï¼Œ ä¾‹å¦‚new Thread(r)ï¼Œçº¿ç¨‹è¿˜æ²¡æœ‰å¼€å§‹è¿è¡Œï¼Œæ­¤æ—¶çº¿ç¨‹å¤„åœ¨æ–°å»ºçŠ¶æ€ã€‚ å½“ä¸€ä¸ªçº¿ç¨‹å¤„äºæ–°ç”ŸçŠ¶æ€æ—¶ï¼Œç¨‹åºè¿˜æ²¡æœ‰å¼€å§‹è¿è¡Œçº¿ç¨‹ä¸­çš„ä»£ç </p>
</li>
<li><p>å°±ç»ªçŠ¶æ€<br>ä¸€ä¸ªæ–°åˆ›å»ºçš„çº¿ç¨‹å¹¶ä¸è‡ªåŠ¨å¼€å§‹è¿è¡Œï¼Œè¦æ‰§è¡Œçº¿ç¨‹ï¼Œå¿…é¡»è°ƒç”¨çº¿ç¨‹çš„start()æ–¹æ³•ã€‚å½“çº¿ç¨‹å¯¹è±¡è°ƒç”¨start()æ–¹æ³•å³å¯åŠ¨äº†çº¿ç¨‹ï¼Œstart()æ–¹æ³•åˆ›å»ºçº¿ç¨‹è¿è¡Œçš„ç³»ç»Ÿèµ„æºï¼Œå¹¶è°ƒåº¦çº¿ç¨‹è¿è¡Œrun()æ–¹æ³•ã€‚å½“start()æ–¹æ³•è¿”å›åï¼Œçº¿ç¨‹å°±å¤„äºå°±ç»ªçŠ¶æ€ã€‚<br>å¤„äºå°±ç»ªçŠ¶æ€çš„çº¿ç¨‹å¹¶ä¸ä¸€å®šç«‹å³è¿è¡Œrun()æ–¹æ³•ï¼Œçº¿ç¨‹è¿˜å¿…é¡»åŒå…¶ä»–çº¿ç¨‹ç«äº‰CPUæ—¶é—´ï¼Œåªæœ‰è·å¾—CPUæ—¶é—´æ‰å¯ä»¥è¿è¡Œçº¿ç¨‹ã€‚å› ä¸ºåœ¨å•CPUçš„è®¡ç®—æœºç³»ç»Ÿä¸­ï¼Œä¸å¯èƒ½åŒæ—¶è¿è¡Œå¤šä¸ªçº¿ç¨‹ï¼Œä¸€ä¸ªæ—¶åˆ»ä»…æœ‰ä¸€ä¸ªçº¿ç¨‹å¤„äºè¿è¡ŒçŠ¶æ€ã€‚å› æ­¤æ­¤æ—¶å¯èƒ½æœ‰å¤šä¸ªçº¿ç¨‹å¤„äºå°±ç»ªçŠ¶æ€ã€‚å¯¹å¤šä¸ªå¤„äºå°±ç»ªçŠ¶æ€çš„çº¿ç¨‹æ˜¯ç”±<code>Java</code>è¿è¡Œæ—¶ç³»ç»Ÿçš„çº¿ç¨‹è°ƒåº¦ç¨‹åº(<em>thread scheduler</em>)æ¥è°ƒåº¦çš„ã€‚</p>
</li>
<li><p>è¿è¡ŒçŠ¶æ€<br>å½“çº¿ç¨‹è·å¾—CPUæ—¶é—´åï¼Œå®ƒæ‰è¿›å…¥è¿è¡ŒçŠ¶æ€ï¼ŒçœŸæ­£å¼€å§‹æ‰§è¡Œrun()æ–¹æ³•.</p>
</li>
<li><p>é˜»å¡çŠ¶æ€<br>çº¿ç¨‹è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå¯èƒ½ç”±äºå„ç§åŸå› è¿›å…¥é˜»å¡çŠ¶æ€:<br>1&gt;çº¿ç¨‹é€šè¿‡è°ƒç”¨sleepæ–¹æ³•è¿›å…¥ç¡çœ çŠ¶æ€ï¼›<br>2&gt;çº¿ç¨‹è°ƒç”¨ä¸€ä¸ªåœ¨I/Oä¸Šè¢«é˜»å¡çš„æ“ä½œï¼Œå³è¯¥æ“ä½œåœ¨è¾“å…¥è¾“å‡ºæ“ä½œå®Œæˆä¹‹å‰ä¸ä¼šè¿”å›åˆ°å®ƒçš„è°ƒç”¨è€…ï¼›<br>3&gt;çº¿ç¨‹è¯•å›¾å¾—åˆ°ä¸€ä¸ªé”ï¼Œè€Œè¯¥é”æ­£è¢«å…¶ä»–çº¿ç¨‹æŒæœ‰ï¼›<br>4&gt;çº¿ç¨‹åœ¨ç­‰å¾…æŸä¸ªè§¦å‘æ¡ä»¶ï¼›</p>
</li>
<li><p>æ­»äº¡çŠ¶æ€</p>
<p>æœ‰ä¸¤ä¸ªåŸå› ä¼šå¯¼è‡´çº¿ç¨‹æ­»äº¡ï¼š</p>
<p>1) runæ–¹æ³•æ­£å¸¸é€€å‡ºè€Œè‡ªç„¶æ­»äº¡ï¼Œ</p>
<p>2) ä¸€ä¸ªæœªæ•è·çš„å¼‚å¸¸ç»ˆæ­¢äº†runæ–¹æ³•è€Œä½¿çº¿ç¨‹çŒæ­»ã€‚ ä¸ºäº†ç¡®å®šçº¿ç¨‹åœ¨å½“å‰æ˜¯å¦å­˜æ´»ç€ï¼ˆå°±æ˜¯è¦ä¹ˆæ˜¯å¯è¿è¡Œçš„ï¼Œè¦ä¹ˆæ˜¯è¢«é˜»å¡äº†ï¼‰ï¼Œéœ€è¦ä½¿ç”¨<code>isAlive</code>æ–¹æ³•ã€‚å¦‚æœæ˜¯å¯è¿è¡Œæˆ–è¢«é˜»å¡ï¼Œè¿™ä¸ªæ–¹æ³•è¿”å›trueï¼› å¦‚æœçº¿ç¨‹ä»æ—§æ˜¯newçŠ¶æ€ä¸”ä¸æ˜¯å¯è¿è¡Œçš„ï¼Œ æˆ–è€…çº¿ç¨‹æ­»äº¡äº†ï¼Œåˆ™è¿”å›false.</p>
</li>
</ul>
<h2 id="7-join-æ–¹æ³•"><a href="#7-join-æ–¹æ³•" class="headerlink" title="7.join()æ–¹æ³•"></a>7.join()æ–¹æ³•</h2><h3 id="æºç è§£æ"><a href="#æºç è§£æ" class="headerlink" title="æºç è§£æ"></a>æºç è§£æ</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">join</span><span class="params">(<span class="keyword">long</span> millis)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">       <span class="keyword">long</span> base = System.currentTimeMillis();</span><br><span class="line">       <span class="keyword">long</span> now = <span class="number">0</span>;</span><br><span class="line">       <span class="keyword">if</span> (millis &lt; <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"timeout value is negative"</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (millis == <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="keyword">while</span> (isAlive()) &#123;</span><br><span class="line">               wait(<span class="number">0</span>);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="keyword">while</span> (isAlive()) &#123;</span><br><span class="line">               <span class="keyword">long</span> delay = millis - now;</span><br><span class="line">               <span class="keyword">if</span> (delay &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">               &#125;</span><br><span class="line">               wait(delay);</span><br><span class="line">               now = System.currentTimeMillis() - base;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>â‘ <code>thread.join()</code>æ²¡æœ‰å‚æ•°ä¼šé»˜è®¤è°ƒç”¨<code>join(0)</code>ç„¶åå›è½®è¯¢æ£€æŸ¥è°ƒç”¨<code>join()</code>çš„çº¿ç¨‹ä¹Ÿå°±æ˜¯æ˜¯<code>thread</code>çº¿ç¨‹æ˜¯å¦<code>isAlive()</code>å¦‚æœthreadä¾ç„¶å­˜æ´»å°±å›é‡Šæ”¾<code>å½“å‰çº¿ç¨‹</code>çš„CPUæ‰§è¡Œæƒï¼Œç„¶åç»§ç»­è½®è¯¢ï¼ŒçŸ¥é“<code>thread</code>è¿›å…¥ç»ˆæ­¢çŠ¶æ€ã€‚</p>
<p>â‘¡<code>join(long millis)</code> å‚æ•°çš„ä½œç”¨å°±æ˜¯å½“å‰çº¿ç¨‹æœ€å¤šç­‰å¾…æ—¶é—´ï¼Œé™æ—¶ç­‰å¾…ï¼Œé¿å…æ— æ­¢å¢ƒçš„ç­‰å¾…ã€‚</p>
<p>â‘¢ä¸€ä¸ªçº¿ç¨‹è‡ªå·±è°ƒç”¨è‡ªå·±çš„<code>join</code>æ–¹æ³•è¯¥çº¿ç¨‹å°±å›ä¸€ç›´<code>wait</code>ä¸‹å»å› ä¸ºä»–è‡ªå·±è¦ä¸€ç›´ç­‰è‡ªå·±ğŸ˜„</p>
<h3 id="åº”ç”¨åœºæ™¯-1"><a href="#åº”ç”¨åœºæ™¯-1" class="headerlink" title="åº”ç”¨åœºæ™¯"></a>åº”ç”¨åœºæ™¯</h3><blockquote>
<p> å¤šçº¿ç¨‹åŒæ—¶é‡‡é›†æ•°æ®ï¼Œæœ€åå°†ç»Ÿè®¡çš„æ€»æ—¶é—´ç­‰ä¿¡æ¯å­˜åˆ°æ•°æ®åº“ä¸­ï¼Œå¦‚æœä¸jionå°±æ— æ³•ç»Ÿä¸€ç»“æŸçš„æ—¶é—´</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadJoin3</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> l1 = System.currentTimeMillis();</span><br><span class="line">        Thread t0 = <span class="keyword">new</span> Thread(<span class="keyword">new</span> CaptureMachine(<span class="string">"M0"</span>, <span class="number">1000</span>));</span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(<span class="keyword">new</span> CaptureMachine(<span class="string">"M1"</span>, <span class="number">2000</span>));</span><br><span class="line">        Thread t2 = <span class="keyword">new</span> Thread(<span class="keyword">new</span> CaptureMachine(<span class="string">"M2"</span>, <span class="number">4000</span>));</span><br><span class="line">        t0.start();</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">        <span class="comment">//è®©ä¸»çº¿ç¨‹ç­‰å¾…å­çº¿ç¨‹ç»“æŸç„¶åç»Ÿè®¡æœ€åæ€»ä½“ç»“æŸçš„æ—¶é—´</span></span><br><span class="line">        t0.join();</span><br><span class="line">        t1.join();</span><br><span class="line">        t2.join();</span><br><span class="line">        <span class="keyword">long</span> l = System.currentTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">"end save begin timestamp:"</span> + l1 + <span class="string">"end timestamp"</span> + l);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CaptureMachine</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String machineId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> spentTime;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CaptureMachine</span><span class="params">(String machineId, <span class="keyword">long</span> spentTime)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.machineId = machineId;</span><br><span class="line">        <span class="keyword">this</span>.spentTime = spentTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(spentTime);</span><br><span class="line">            System.out.println(machineId + <span class="string">" capture done"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="8-ä¼˜å…ˆçº§"><a href="#8-ä¼˜å…ˆçº§" class="headerlink" title="8.ä¼˜å…ˆçº§"></a>8.ä¼˜å…ˆçº§</h2><p>ç°ä»£æ“ä½œç³»ç»ŸåŸºæœ¬é‡‡ç”¨æ—¶åˆ†çš„å½¢å¼è°ƒåº¦è¿è¡Œçš„çº¿ç¨‹ï¼Œçº¿ç¨‹åˆ†é…å¾—åˆ°çš„æ—¶é—´ç‰‡çš„å¤šå°‘å†³å®šäº†çº¿ç¨‹ä½¿ç”¨å¤„ç†å™¨èµ„æºçš„å¤šå°‘ï¼Œä¹Ÿå¯¹åº”äº†çº¿ç¨‹ä¼˜å…ˆçº§è¿™ä¸ªæ¦‚å¿µã€‚åœ¨JAVAçº¿ç¨‹ä¸­ï¼Œé€šè¿‡ä¸€ä¸ªint priorityæ¥æ§åˆ¶ä¼˜å…ˆçº§ï¼ŒèŒƒå›´ä¸º1-10ï¼Œå…¶ä¸­10æœ€é«˜ï¼Œé»˜è®¤å€¼ä¸º5ã€‚ä¸‹é¢æ˜¯Demoï¼ˆåŸºäº1.8ï¼‰ä¸­å…³äºpriorityçš„ä¸€äº›é‡å’Œæ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadSimpleAPI2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Thread t0 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">                Optional.of(Thread.currentThread().getName() + <span class="string">"-index"</span> + i).ifPresent(System.out::println);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        t0.setPriority(Thread.MAX_PRIORITY);</span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">                Optional.of(Thread.currentThread().getName() + <span class="string">"-index"</span> + i).ifPresent(System.out::println);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        t1.setPriority(Thread.NORM_PRIORITY);</span><br><span class="line">        Thread t2 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">                Optional.of(Thread.currentThread().getName() + <span class="string">"-index"</span> + i).ifPresent(System.out::println);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        t2.setPriority(Thread.MIN_PRIORITY);</span><br><span class="line">        t0.start();</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="9-Interruptæ–¹æ³•"><a href="#9-Interruptæ–¹æ³•" class="headerlink" title="9.Interruptæ–¹æ³•"></a>9.Interruptæ–¹æ³•</h2><h3 id="çœ‹çœ‹æºç "><a href="#çœ‹çœ‹æºç " class="headerlink" title="çœ‹çœ‹æºç "></a>çœ‹çœ‹æºç </h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">interrupt</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span> != Thread.currentThread())</span><br><span class="line">            checkAccess();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (blockerLock) &#123;</span><br><span class="line">            Interruptible b = blocker;</span><br><span class="line">            <span class="keyword">if</span> (b != <span class="keyword">null</span>) &#123;</span><br><span class="line">                interrupt0();           <span class="comment">// Just to set the interrupt flag</span></span><br><span class="line">                b.interrupt(<span class="keyword">this</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        interrupt0();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨çŸ¥ä¹ä¸Šçœ‹è§ä¸€ä¸ªå¥½çš„å›ç­”ï¼šé¦–å…ˆï¼Œä¸€ä¸ªçº¿ç¨‹ä¸åº”è¯¥ç”±å…¶ä»–çº¿ç¨‹æ¥å¼ºåˆ¶ä¸­æ–­æˆ–åœæ­¢ï¼Œè€Œæ˜¯åº”è¯¥ç”±çº¿ç¨‹è‡ªå·±<code>è‡ªè¡Œåœæ­¢</code>ã€‚æ‰€ä»¥ï¼Œ<code>Thread.stop()</code> ,<code>Thread.suspend()</code>,<code>Thread.resume()</code>éƒ½å·²ç»è¢«åºŸå¼ƒäº†ã€‚è€Œ<code>Thread.interrupt()</code>çš„ä½œç”¨ä¹Ÿä¸æ˜¯ä¸­æ–­çº¿ç¨‹ï¼Œ<em>è€Œæ˜¯é€šçŸ¥çº¿ç¨‹è¯¥ç»“æŸäº†</em> å…·ä½“ä¸­æ–­è¿˜æ˜¯ç»§ç»­è¿è¡Œè¿˜æ˜¯ç”±è¢«é€šçŸ¥çš„çº¿ç¨‹è‡ªå·±å¤„ç†ã€‚å…·ä½“æ¥è¯´ï¼Œå½“å¯¹ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨<code>interrupt()</code>æ—¶</p>
<p>â‘ å¦‚æœçº¿ç¨‹å¤„äºé˜»å¡çŠ¶æ€(sleep,wait,joinç­‰)ï¼Œé‚£ä¹ˆçº¿ç¨‹å°†<del>ç«‹å³é€€å‡ºè¢«é˜»å¡çŠ¶æ€</del>å¹¶æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸(2019.8.10 fix)</p>
<blockquote>
<p>è¿™é‡Œå…¶å®æ˜¯æœ‰ç‚¹é—®é¢˜çš„ï¼Œåœ¨æœ‰åŒæ­¥é”å­˜åœ¨çš„æƒ…å†µä¸‹ï¼Œå¹¶ä¸ä¸€å®šä¼šç«‹å³é€€å‡ºè¢«é˜»å¡çš„çŠ¶æ€ï¼Œå³ä½¿æŠ›å‡ºå¼‚å¸¸ä¹Ÿè¦ç­‰åˆ°å†æ¬¡æ‹¿åˆ°é”ä¹‹åæ‰èƒ½æŠ›å‡ºï¼ŒåŒæ—¶ä¹Ÿä¸æ˜¯æ‰€æœ‰çš„é˜»å¡æ“ä½œéƒ½ä¼šå“åº”ä¸­æ–­ä¿¡å·ï¼Œæ¯”å¦‚IOæ“ä½œä¹‹ç±»çš„éƒ½ä¸ä¼šå“åº”ä¸­æ–­ä¿¡å·</p>
</blockquote>
<p><strong>éªŒè¯Demo</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WaitNotify</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Object object = <span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line">        Thread thread1 = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (object) &#123;</span><br><span class="line">                    System.out.println(<span class="string">"çº¿ç¨‹1 è·å–åˆ°ç›‘è§†å™¨é”"</span>);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        object.wait();</span><br><span class="line">                        System.out.println(<span class="string">"çº¿ç¨‹1 æ¢å¤å•¦ã€‚æˆ‘ä¸ºä»€ä¹ˆè¿™ä¹ˆä¹…æ‰æ¢å¤ï¼Œå› ä¸ºnotifyæ–¹æ³•è™½ç„¶æ—©å°±å‘ç”Ÿäº†ï¼Œå¯æ˜¯æˆ‘è¿˜è¦è·å–é”æ‰èƒ½ç»§ç»­æ‰§è¡Œã€‚"</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        System.out.println(<span class="string">"çº¿ç¨‹1 waitæ–¹æ³•æŠ›å‡ºäº†InterruptedExceptionå¼‚å¸¸ï¼Œå³ä½¿æ˜¯å¼‚å¸¸ï¼Œæˆ‘ä¹Ÿæ˜¯è¦è·å–åˆ°ç›‘è§†å™¨é”äº†æ‰ä¼šæŠ›å‡º"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"çº¿ç¨‹1"</span>);</span><br><span class="line">        thread1.start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (object) &#123;</span><br><span class="line">                    System.out.println(<span class="string">"çº¿ç¨‹2 æ‹¿åˆ°äº†ç›‘è§†å™¨é”ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Œå› ä¸ºçº¿ç¨‹1 åœ¨ wait æ–¹æ³•çš„æ—¶å€™ä¼šè‡ªåŠ¨é‡Šæ”¾é”"</span>);</span><br><span class="line">                    System.out.println(<span class="string">"çº¿ç¨‹2 è®¾ç½®çº¿ç¨‹1 ä¸­æ–­"</span>);</span><br><span class="line">                    thread1.interrupt();</span><br><span class="line">                    System.out.println(<span class="string">"çº¿ç¨‹2 æ‰§è¡Œå®Œäº† ä¸­æ–­ï¼Œå…ˆä¼‘æ¯3ç§’å†è¯´ã€‚"</span>);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">                        System.out.println(<span class="string">"çº¿ç¨‹2 ä¼‘æ¯å®Œå•¦ã€‚æ³¨æ„äº†ï¼Œè°ƒsleepæ–¹æ³•å’Œwaitæ–¹æ³•ä¸ä¸€æ ·ï¼Œä¸ä¼šé‡Šæ”¾ç›‘è§†å™¨é”"</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                    System.out.println(<span class="string">"çº¿ç¨‹2 ä¼‘æ¯å¤Ÿäº†ï¼Œç»“æŸæ“ä½œ"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"çº¿ç¨‹2"</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>â‘¡å¦‚æœçº¿ç¨‹å¤„äºæ­£å¸¸æ´»åŠ¨çŠ¶æ€ï¼Œé‚£ä¹ˆä¼šå°†è¯¥çº¿ç¨‹çš„<code>ä¸­æ–­æ ‡å¿—ä½</code>è®¾ç½®ä¸ºtrueï¼Œä»…æ­¤è€Œå·²ï¼Œè¢«è®¾ç½®ä¸­æ–­æ ‡å¿—çš„çº¿ç¨‹å°†ç»§ç»­æ­£å¸¸è¿è¡Œï¼Œä¸å—å½±å“ã€‚</p>
<p>â‘¢å¯¹å·²ç»ç»“æŸçš„çº¿ç¨‹è°ƒç”¨<code>interupt</code>æ²¡æœ‰ä»»ä½•æ•ˆæœ</p>
<p>ä¸Šé¢åªæ˜¯ç®€å•çš„åˆ†æï¼Œå…¶å®æƒ…å†µè¿˜æ˜¯å¾ˆå¤æ‚çš„ï¼Œåé¢å†æ¥æ€»ç»“</p>
<p><strong>å…·ä½“çš„å°æ¡ˆä¾‹</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadInterrup2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Thread main=Thread.currentThread();</span><br><span class="line"></span><br><span class="line">        Thread t=<span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>)&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        t.start();</span><br><span class="line">	</span><br><span class="line">        Thread t2 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//t.interrupt(); è¿™é‡Œæ‰“æ–­çš„æ˜¯tçº¿ç¨‹ä½†æ˜¯é˜»å¡çš„æ˜¯mainçº¿ç¨‹æ‰€ä»¥æ‰“æ–­ä¸äº†ï¼Œæ•è·ä¸åˆ°å¼‚å¸¸</span></span><br><span class="line">            main.interrupt();</span><br><span class="line">            System.out.println(<span class="string">"æ‰“æ–­ main çº¿ç¨‹"</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">        t2.start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//è¿™é‡Œé˜»å¡çš„æ˜¯mainçº¿ç¨‹</span></span><br><span class="line">            t.join();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>çœ‹æ‡‚è¿™ä¸ªå°æ¡ˆä¾‹åº”è¯¥å°±ç†è§£interruptäº†ã€‚</p>
<h3 id="å¦‚ä½•ä¼˜é›…çš„ç»“æŸçº¿ç¨‹"><a href="#å¦‚ä½•ä¼˜é›…çš„ç»“æŸçº¿ç¨‹" class="headerlink" title="å¦‚ä½•ä¼˜é›…çš„ç»“æŸçº¿ç¨‹"></a>å¦‚ä½•ä¼˜é›…çš„ç»“æŸçº¿ç¨‹</h3><p><strong>1. ä½¿ç”¨â€œå¼€å…³â€</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadCloseGraceful</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Worker worker=<span class="keyword">new</span> Worker();</span><br><span class="line">        worker.start();</span><br><span class="line">        Thread.sleep(<span class="number">10000</span>); <span class="comment">//ç­‰å¾…10s</span></span><br><span class="line">        worker.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Worker</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line">    <span class="comment">//ä¼˜é›…çš„åœæ­¢çº¿ç¨‹-----å¼€å…³</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> start = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (start)&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.start=<span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ä¸ºäº†åŠæ—¶çš„æ„ŸçŸ¥åˆ°å¼€å…³çš„å˜åŒ– startéœ€è¦å£°æ˜ä¸º volatileï¼ˆåé¢è®²Volatileçš„æ—¶å€™ä¼šè¯´åˆ°ï¼‰</p>
</blockquote>
<p><strong>2. è½®è¯¢ä¸­æ–­æ ‡å¿—ä½</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadCloseGraceful2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Worker2 worker2 = <span class="keyword">new</span> Worker2();</span><br><span class="line">        worker2.start();</span><br><span class="line">        Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">        worker2.interrupt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Worker2</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line">    <span class="comment">//ä¼˜é›…çš„åœæ­¢çº¿ç¨‹2-----æ‰“æ–­</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>)&#123;</span><br><span class="line">            <span class="comment">/*try &#123;</span></span><br><span class="line"><span class="comment">                Thread.sleep(1);</span></span><br><span class="line"><span class="comment">            &#125; catch (InterruptedException e) &#123;</span></span><br><span class="line"><span class="comment">                e.printStackTrace();</span></span><br><span class="line"><span class="comment">                break; //return ä¼šç›´æ¥é€€å‡º</span></span><br><span class="line"><span class="comment">            &#125;*/</span></span><br><span class="line">            <span class="comment">//ä»£ç æœ‰å¯èƒ½åœ¨æ‰§è¡ŒisInterruptedä¹‹å‰å°±Blockäº†</span></span><br><span class="line">            <span class="keyword">if</span>(isInterrupted())&#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//-----------</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>3. åˆ©ç”¨å®ˆæŠ¤çº¿ç¨‹</strong></p>
<p>ä¸Šé¢çš„ä»£ç å·²ç»æåˆ°äº†ï¼Œæœ‰å¯èƒ½åœ¨è½®è¯¢<code>å¼€å…³</code> æˆ–è€… è½®è¯¢<code>ä¸­æ–­æ ‡å¿—ä½</code>ä¹‹å‰å°±å µå¡äº†ï¼Œè¿™æ—¶ä¹Ÿä¸èƒ½ä¸€ç›´ç­‰è¯¥ä¸‹å»æ‰€ä»¥å°±éœ€è¦å¼ºåˆ¶ç»“æŸçº¿ç¨‹çš„æ–¹æ³•ï¼Œ<code>ï¼ˆå½“ç„¶ä¸ä¼šæ˜¯stopï¼‰</code> è¿™é‡Œå°±å¯ä»¥åˆ©ç”¨å®ˆæŠ¤çº¿ç¨‹çš„ç‰¹æ€§å»å®Œæˆè¿™ä»¶äº‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadService</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span>  Thread executeThread;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>  <span class="keyword">volatile</span>  <span class="keyword">boolean</span> finished=<span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Runnable task)</span></span>&#123;</span><br><span class="line">        executeThread =<span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="comment">//å­çº¿ç¨‹</span></span><br><span class="line">            Thread t=<span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">                task.run();</span><br><span class="line">            &#125;);</span><br><span class="line">            t.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">            t.start();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                t.join(); <span class="comment">//è¿™é‡Œé˜»å¡çš„æ˜¯executeThread</span></span><br><span class="line">                finished=<span class="keyword">true</span>;</span><br><span class="line">                <span class="comment">//åˆ°è¿™é‡Œè¯´æ˜executeThreadå·²ç»ä¸é˜»å¡äº†,å­çº¿ç¨‹å·²ç»æ‰§è¡Œå®Œäº†ï¼Œæ²¡æœ‰è¶…æ—¶</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                System.out.println(<span class="string">"TLEï¼ŒexecuteThread execution was interrupted"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        executeThread.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">(<span class="keyword">long</span> mills)</span></span>&#123;</span><br><span class="line">        <span class="keyword">long</span> base=System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">while</span> (!finished)&#123; <span class="comment">//è½®è¯¢æ£€æŸ¥æ ‡å¿—ä½ï¼Œçœ‹æ˜¯å¦å·²ç»ç»“æŸ</span></span><br><span class="line">            <span class="keyword">if</span>(System.currentTimeMillis()-base&gt;=mills)&#123;</span><br><span class="line">                <span class="comment">//è¶…æ—¶äº†æ²¡æœ‰å®Œæˆ</span></span><br><span class="line">                System.out.println(<span class="string">"TLE, will end it now"</span>);</span><br><span class="line">                executeThread.interrupt(); <span class="comment">//æ‰“æ–­executeThread</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//æ²¡è¶…æ—¶</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                executeThread.sleep(<span class="number">10</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                System.out.println(<span class="string">"executeThread was interrupted when shutdown"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//æ ‡å¿—ä½å¤åŸ</span></span><br><span class="line">        finished=<span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å°†å¾…æ‰§è¡Œçš„<code>task</code>ä¼ é€’åˆ°<code>ThreadService</code>ä¸­ç„¶åä¼šåˆ›å»ºä¸€ä¸ª<code>executeThread</code>çš„çº¿ç¨‹ï¼Œåœ¨çº¿ç¨‹ä¸­åˆ›å»ºä¸€ä¸ªå­çº¿ç¨‹å»æ‰§è¡Œ<code>task</code>çš„<code>run</code>æ–¹æ³•ç„¶åå°†å­çº¿ç¨‹è®¾ç½®ä¸º<code>executeThread</code>çš„å®ˆæŠ¤çº¿ç¨‹ç„¶å<code>join</code>é˜»å¡<code>executeThread</code>çº¿ç¨‹ï¼ŒåŒæ—¶ä¼šè°ƒç”¨<code>ThreadService</code>çš„<code>shutdown</code>æ–¹æ³•ä¼ å…¥ä¸€ä¸ªæœ€é•¿ç­‰å¾…æ—¶é—´ç„¶å<code>è½®è¯¢æ ‡å¿—ä½</code>æ£€æŸ¥æ˜¯å¦ç»“æŸï¼Œå¦‚æœè¶…æ—¶å°±ä¼šæ‰“æ–­<code>executeThread</code>è¿›è€Œç»“æŸ<code>executeThread</code>çš„å­çº¿ç¨‹ä¹Ÿå°±æ˜¯<code>task</code></p>
<h3 id="Thread-interrupted"><a href="#Thread-interrupted" class="headerlink" title="Thread.interrupted()"></a>Thread.interrupted()</h3><p>è¿™ä¸ªæ–¹æ³•å’Œ<code>isInterrupt()</code>ç±»ä¼¼ä½†æ˜¯ä»–ä¼šæ¸…é™¤ä¸­æ–­æ ‡å¿—ä½ä¸º<code>false</code>æ–¹ä¾¿ä¹‹åçš„ä¸­æ–­æ“ä½œè€Œä¸”è¿™ä¸ªæ˜¯<code>é™æ€æ–¹æ³•</code>ï¼Œæ‰€ä»¥ä½ ç”¨çº¿ç¨‹å®ä¾‹å»è°ƒç”¨è¿™ä¸ªæ–¹æ³•æ²¡æœ‰ä»»ä½•æ„ä¹‰ï¼Œå®ƒè¿™é‡Œæ˜¯ç”¨æ¥åˆ¤æ–­<strong>å½“å‰æ‰§è¡Œçº¿ç¨‹</strong>æ˜¯å¦ <code>interrupt</code> ï¼Œå¹¶ä¸”è®¾ç½®ä¸­æ–­æ ‡å¿—ä½ä¸º<code>false</code></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Tests whether the current thread has been interrupted.  The</span><br><span class="line"> * <span class="tag">&lt;<span class="name">i</span>&gt;</span>interrupted status<span class="tag">&lt;/<span class="name">i</span>&gt;</span> of the thread is cleared by this method.  In</span><br><span class="line"> * other words, if this method were to be called twice in succession, the</span><br><span class="line"> * second call would return false (unless the current thread were</span><br><span class="line"> * interrupted again, after the first call had cleared its interrupted</span><br><span class="line"> * status and before the second call had examined it).</span><br><span class="line"> *</span><br><span class="line"> * <span class="tag">&lt;<span class="name">p</span>&gt;</span>A thread interruption ignored because a thread was not alive</span><br><span class="line"> * at the time of the interrupt will be reflected by this method</span><br><span class="line"> * returning false.</span><br><span class="line"> *</span><br><span class="line"> * @return  <span class="tag">&lt;<span class="name">code</span>&gt;</span>true<span class="tag">&lt;/<span class="name">code</span>&gt;</span> if the current thread has been interrupted;</span><br><span class="line"> *          <span class="tag">&lt;<span class="name">code</span>&gt;</span>false<span class="tag">&lt;/<span class="name">code</span>&gt;</span> otherwise.</span><br><span class="line"> * @see #isInterrupted()</span><br><span class="line"> * @revised 6.0</span><br><span class="line"> */</span><br></pre></td></tr></table></figure>

<p>åŒæ—¶åœ¨æŠ›å‡º<code>InterruptedException</code> ä¹‹åä¸­æ–­çŠ¶æ€ä¹Ÿä¼šè¢«è‡ªåŠ¨æ¸…é™¤ä¸ºfalse</p>
<blockquote>
<p>if any thread has interrupted the current thread. The <i>interrupted status</i> of the current thread is cleared when this exception is thrown.     â€”-Thread.sleepæ³¨é‡Š</p>
</blockquote>
<h2 id="10-Yieldæ–¹æ³•"><a href="#10-Yieldæ–¹æ³•" class="headerlink" title="10.Yieldæ–¹æ³•"></a>10.Yieldæ–¹æ³•</h2><p>Thread.yield()æ–¹æ³•çš„ä½œç”¨ï¼šæš‚åœå½“å‰æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹ï¼Œå¹¶æ‰§è¡Œå…¶ä»–çº¿ç¨‹ã€‚ï¼ˆå¯èƒ½æ²¡æœ‰æ•ˆæœï¼‰<br>yield()è®©å½“å‰æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹å›åˆ°å¯è¿è¡ŒçŠ¶æ€ï¼Œä»¥å…è®¸å…·æœ‰ç›¸åŒä¼˜å…ˆçº§çš„å…¶ä»–çº¿ç¨‹è·å¾—è¿è¡Œçš„æœºä¼šã€‚å› æ­¤ï¼Œä½¿ç”¨yield()çš„ç›®çš„æ˜¯è®©å…·æœ‰ç›¸åŒä¼˜å…ˆçº§çš„çº¿ç¨‹ä¹‹é—´èƒ½å¤Ÿé€‚å½“çš„è½®æ¢æ‰§è¡Œã€‚ä½†æ˜¯ï¼Œå®é™…ä¸­æ— æ³•ä¿è¯yield()è¾¾åˆ°è®©æ­¥çš„ç›®çš„ï¼Œå› ä¸ºï¼Œè®©æ­¥çš„çº¿ç¨‹å¯èƒ½è¢«çº¿ç¨‹è°ƒåº¦ç¨‹åºå†æ¬¡é€‰ä¸­ã€‚<br>ç»“è®ºï¼šå¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œyield()å°†å¯¼è‡´çº¿ç¨‹ä»è¿è¡ŒçŠ¶æ€è½¬åˆ°å¯è¿è¡ŒçŠ¶æ€ï¼Œä½†æœ‰å¯èƒ½æ²¡æœ‰æ•ˆæœã€‚</p>
<h2 id="11-Synchronizedå…³é”®å­—"><a href="#11-Synchronizedå…³é”®å­—" class="headerlink" title="11.Synchronizedå…³é”®å­—"></a>11.Synchronizedå…³é”®å­—</h2><h3 id="çº¿ç¨‹å®‰å…¨é—®é¢˜"><a href="#çº¿ç¨‹å®‰å…¨é—®é¢˜" class="headerlink" title="çº¿ç¨‹å®‰å…¨é—®é¢˜"></a>çº¿ç¨‹å®‰å…¨é—®é¢˜</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TicketRunnable</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> MAX_NO = <span class="number">500</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> index = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (index &gt; MAX_NO) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">5</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">"ç¬¬ï¼š"</span> + index++);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç”¨è¿™ä¸ªåˆ›å»ºå¤šä¸ª<code>Thread</code>ç„¶åè¿è¡Œ</p>
<blockquote>
<p>äºŒå·çª—å£ç¬¬ï¼š497<br>ä¸‰å·çª—å£ç¬¬ï¼š499<br>ä¸€å·çª—å£ç¬¬ï¼š498<br>ä¸€å·çª—å£ç¬¬ï¼š500<br>äºŒå·çª—å£ç¬¬ï¼š<code>502</code><br>ä¸‰å·çª—å£ç¬¬ï¼š<code>501</code></p>
</blockquote>
<p>å¯ä»¥çœ‹å‡ºæ‰“å°å‡ºäº†501ï¼Œ502æ˜æ˜¾ä¸å¯¹ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ç§é—®é¢˜å‘¢ï¼Ÿå…¶å®ä»”ç»†æƒ³æƒ³ä¹Ÿå¾ˆå®¹æ˜“ç†è§£</p>
<p><img src="http://static.imlgw.top///20190326/zSGNeiCW2zc1.png?imageslim" alt="mark"></p>
<p>å½“ä¸¤ä¸ªçº¿ç¨‹å¦‚å›¾æ‰€ç¤ºçš„æƒ…å†µï¼Œ2å·çº¿ç¨‹<code>index=500</code>ç„¶å<code>index++</code>ç„¶å 1å·çº¿ç¨‹è¯»å–åˆ°<code>index</code>çš„å€¼å°±ä¼šäº§ç”Ÿè¿™ä¸ªé—®é¢˜ã€‚</p>
<h3 id="åŒæ­¥ä»£ç å—"><a href="#åŒæ­¥ä»£ç å—" class="headerlink" title="åŒæ­¥ä»£ç å—"></a>åŒæ­¥ä»£ç å—</h3><p><strong>è§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TicketRunnable</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> MAX_NO = <span class="number">500</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> index = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object MONITOR = <span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (MONITOR) &#123;</span><br><span class="line">                <span class="comment">//å•çº¿ç¨‹</span></span><br><span class="line">                <span class="keyword">if</span> (index &gt; MAX_NO) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">5</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">"ç¬¬ï¼š"</span> + index++);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ©ç”¨<code>MONITOR</code>å¯¹è±¡ä½œä¸ºåŒæ­¥é”åŒæ­¥ä¹‹åçš„éƒ¨åˆ†å°±ç›¸å½“äºå•çº¿ç¨‹ï¼Œ<code>MONITOR</code>é”å¯¹è±¡ä¸€èˆ¬è®¾ç½®ä¸º<code>final</code>çš„é¿å…åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å¯¹<code>MONITOR</code>å¯¹è±¡è¿›è¡Œæ”¹å˜è€Œäº§ç”Ÿæ— æ³•é¢„æ–™çš„åæœ</p>
<h3 id="åŒæ­¥æ–¹æ³•"><a href="#åŒæ­¥æ–¹æ³•" class="headerlink" title="åŒæ­¥æ–¹æ³•"></a>åŒæ­¥æ–¹æ³•</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SynchronizeRunnable</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> MAX_NO = <span class="number">500</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> index = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span>  <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//thisé”</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ticket()) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">boolean</span> <span class="title">ticket</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//synchronized (this) &#123;</span></span><br><span class="line">            <span class="comment">//1.getFiled</span></span><br><span class="line">            <span class="keyword">if</span> (index &gt; MAX_NO) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">5</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// getFiled index</span></span><br><span class="line">            <span class="comment">// index=index+1</span></span><br><span class="line">            <span class="comment">// putFiled index</span></span><br><span class="line">            <span class="comment">//åŒæ­¥ä»£ç å—å°±æ˜¯ä¿æŠ¤å…±äº«æ•°æ®index, MAX_NOä¸æ˜¯,ä»–æ˜¯åªè¯»æ•°æ®</span></span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">"ç¬¬ï¼š"</span> + index++);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">       <span class="comment">// &#125;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é»˜è®¤åŠ çš„æ˜¯<code>this</code>é”</p>
<p><strong>è¯æ˜thisé”çš„å­˜åœ¨</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SynchronizedThis</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ThisLock thisLock = <span class="keyword">new</span> ThisLock();</span><br><span class="line">        Thread thread = <span class="keyword">new</span> Thread(() -&gt; thisLock.m1(), <span class="string">"Thread0"</span>);</span><br><span class="line">        thread.start();</span><br><span class="line">        Thread thread1 = <span class="keyword">new</span> Thread(() -&gt; thisLock.m2(), <span class="string">"Thread1"</span>);</span><br><span class="line">        thread1.start();</span><br><span class="line">        Thread thread2 = <span class="keyword">new</span> Thread(() -&gt; thisLock.m3(), <span class="string">"Thread2"</span>);</span><br><span class="line">        thread2.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ThisLock</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object LOCK = <span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">m1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">10_000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">m2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">10_000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">m3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (LOCK) &#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName());</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">10_000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œä¸Šé¢çš„ä»£ç ä¼šå‘ç°<code>Thread0</code>å’Œ<code>Thread2</code>ä¼šå…ˆæ‰“å°å‡ºæ¥å› ä¸ºä»–ä»¬ä¸æ˜¯åŒä¸€ä¸ªé”ä¸ç”¨ç­‰å¾…å¯¹æ–¹ï¼Œè€Œ<code>Thread1</code>ä¼šç­‰å¾…ä¸€æ®µæ—¶é—´åæ‰ä¼šæ‰§è¡Œå› ä¸ºå®ƒéœ€è¦ç­‰å¾…<code>Thread0</code>é‡Šæ”¾é”è€Œè¿™ä¸ªé”åªèƒ½æ˜¯<code>thisé”</code></p>
<p><strong>è¯æ˜classé”çš„å­˜åœ¨</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SynchronizedClass</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Thread thread0 = <span class="keyword">new</span> Thread(() -&gt; ClassLock.m1(), <span class="string">"Thread0"</span>);</span><br><span class="line">        thread0.start();</span><br><span class="line">        Thread thread1 = <span class="keyword">new</span> Thread(() -&gt; ClassLock.m2(), <span class="string">"Thread1"</span>);</span><br><span class="line">        thread1.start();</span><br><span class="line">        Thread thread2 = <span class="keyword">new</span> Thread(() -&gt; ClassLock.m3(), <span class="string">"Thread2"</span>);</span><br><span class="line">        thread2.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClassLock</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (ClassLock<span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"static"</span> + Thread.currentThread().getName());</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">10_000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">m1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">10_000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">m2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">10_000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">m3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">10_000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œä¸Šé¢çš„ä»£ç ä¼šå‘ç°æœ€å¼€å§‹åªæœ‰ä¸€ä¸ªçº¿ç¨‹ä¼šå»æ‰§è¡Œé™æ€ä»£ç å¿«ï¼Œåœ¨é™æ€ä»£ç å¿«æ‰§è¡Œå®Œä¹‹å<code>Thread2</code>ä¼šå’Œå¦ä¸€ä¸ªçº¿ç¨‹ä¸€èµ·æ‰§è¡Œï¼Œè¯´æ˜ä¸€å¼€å§‹<code>Thread2</code>å›å’Œå…¶ä¸­ä¸€ä¸ªçº¿ç¨‹æŠ¢<code>Classé”</code>æ‰§è¡Œé™æ€ä»£ç å—ï¼ˆé™æ€ä»£ç å—åªä¼šæ‰§è¡Œä¸€æ¬¡ï¼‰</p>
<h3 id="æ­»é”"><a href="#æ­»é”" class="headerlink" title="æ­»é”"></a>æ­»é”</h3><blockquote>
<p>ä¸€ä¸ªçº¿ç¨‹å¯ä»¥æŒæœ‰å¤šä¸ªé”ï¼Œè€Œè¿™æ ·å°±å¯èƒ½ä¼šå¯¼è‡´<code>æ­»é”</code>çš„äº§ç”Ÿ</p>
</blockquote>
<p><strong>æ­»é”ç¤ºä¾‹</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Service1</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span>  <span class="keyword">final</span> Object LOCK=<span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Service2 service2;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span>  <span class="keyword">void</span> <span class="title">s1</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (LOCK)&#123;</span><br><span class="line">            System.out.println(<span class="string">"s1=============="</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">s2</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (LOCK)&#123;</span><br><span class="line">            System.out.println(<span class="string">"s2=============="</span>);</span><br><span class="line">            service2.m2();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setService2</span><span class="params">(Service2 service2)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.service2 = service2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">---------------------------------------------------</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Service2</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Service1 service1;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Service2</span><span class="params">(Service1 service1)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.service1 = service1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>  <span class="keyword">final</span>  Object LOCK=<span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span>  <span class="keyword">void</span>  <span class="title">m1</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (LOCK)&#123;</span><br><span class="line">            System.out.println(<span class="string">"m1"</span>);</span><br><span class="line">            service1.s1();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span>  <span class="keyword">void</span>  <span class="title">m2</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (LOCK)&#123;</span><br><span class="line">            System.out.println(<span class="string">"m2"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">-------------------------------------------------</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DeadLockTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Service1 service1=<span class="keyword">new</span> Service1();</span><br><span class="line">        Service2 service2 =<span class="keyword">new</span> Service2(service1);</span><br><span class="line">        service1.setService2(service2);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>)&#123;</span><br><span class="line">                service2.m1();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>)&#123;</span><br><span class="line">                service1.s2();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œä¸Šé¢ä»£ç å°±ä¼šå‘ç°åœ¨è¿è¡Œä¸€æ®µæ—¶é—´åä¸¤ä¸ªçº¿ç¨‹éƒ½<code>é˜»å¡</code>äº†ï¼Œè¿™å°±æ˜¯<code>æ­»é”</code></p>
<ul>
<li><code>jps</code>&amp;<code>jstack</code>  åˆ†ææ­»é”</li>
</ul>
<p><img src="http://static.imlgw.top///20190328/BG9eU9Rq8ae0.png?imageslim" alt="mark"></p>
<p>ä¸¤ä¸ªçº¿ç¨‹éƒ½éœ€è¦å¯¹æ–¹æ‰‹ä¸Šçš„çš„é”ï¼Œé™·å…¥åƒµæŒçŠ¶æ€ï¼Œå°±ä¼šäº§ç”Ÿæ­»é”ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨<code>jconsole</code>å›¾å½¢åŒ–ç•Œé¢æ¥åˆ†æ</p>
<h2 id="12-çº¿ç¨‹é—´é€šè®¯"><a href="#12-çº¿ç¨‹é—´é€šè®¯" class="headerlink" title="12.çº¿ç¨‹é—´é€šè®¯"></a>12.çº¿ç¨‹é—´é€šè®¯</h2><p>åœ¨Javaå¹³å°ä¸­ï¼ŒObject.wait()/notify() ç­‰æ–¹æ³•å¯ç”¨äºå®ç°çº¿ç¨‹çš„ç­‰å¾…å’Œé€šçŸ¥ï¼Œwaitå°†å½“å‰çº¿ç¨‹æš‚åœç”Ÿå‘½å‘¨æœŸå˜ä¸º <strong>WAITING</strong> ï¼Œè€Œnotify() åˆ™å¯ä»¥å”¤é†’ä¸€ä¸ªè¢«æš‚åœçš„çº¿ç¨‹ä»è€Œå®ç°é€šçŸ¥ï¼Œä¸€èˆ¬æ¥è¯´wait() ä»£ç æ¨¡æ¿ç±»ä¼¼ä¸‹é¢</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">synchronized</span>(someObj)&#123;</span><br><span class="line">    <span class="keyword">while</span>(ä¿æŠ¤æ¡ä»¶ä¸æˆç«‹)&#123;</span><br><span class="line">        <span class="comment">//ç­‰å¾…</span></span><br><span class="line">        someObj.wait();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ä¿æŠ¤æ¡ä»¶æ»¡è¶³</span></span><br><span class="line">    doAction();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è€Œ<code>notify()</code> å¯¹åº”ä»£ç æ¨¡æ¿å¦‚ä¸‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">synchronized</span>(someObj)&#123;</span><br><span class="line">    <span class="comment">//æ›´æ–°ç­‰å¾…çº¿ç¨‹çš„ä¿æŠ¤æ¡ä»¶è®¾è®¡çš„å…±äº«å˜é‡</span></span><br><span class="line">    updateSharedDate();</span><br><span class="line">    <span class="comment">//å”¤é†’å…¶ä»–çº¿ç¨‹</span></span><br><span class="line">    someObj,notify();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹"><a href="#ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹" class="headerlink" title="ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹"></a>ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹</h3><p><strong>é”™è¯¯ç¤ºä¾‹</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProduceConsumerVersion1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ProduceConsumerVersion1 pc = <span class="keyword">new</span> ProduceConsumerVersion1();</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                pc.produce();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"Produce"</span>).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                pc.consumer();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"Consumer"</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object LOCK = <span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">produce</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (LOCK) &#123;</span><br><span class="line">            System.out.println(<span class="string">"Produce-&gt;"</span> + (i++));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">consumer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (LOCK) &#123;</span><br><span class="line">            System.out.println(<span class="string">"Consumer-&gt;"</span> + (i));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ç§æ¨¡å‹å½“ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…å¯åŠ¨åä¼šå‘ç°ä¸¤ä¸ªçº¿ç¨‹æ— æ³•åä½œï¼Œç”Ÿäº§è€…ä¸æ–­ç”Ÿäº§ï¼Œæ¶ˆè´¹è€…<code>ä¸æ¶ˆè´¹</code>æˆ–è€…<code>é‡å¤æ¶ˆè´¹</code></p>
<p><strong>å•ç”Ÿäº§è€…&amp;å•æ¶ˆè´¹è€…</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProduceConsumerVersion2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ProduceConsumerVersion2 pc = <span class="keyword">new</span> ProduceConsumerVersion2();</span><br><span class="line">        Stream.of(<span class="string">"Produce1"</span>).forEach(n -&gt; &#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                    pc.produce();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, n).start();</span><br><span class="line">        &#125;);</span><br><span class="line">        Stream.of(<span class="string">"Consumer1"</span>).forEach(n -&gt; &#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                    pc.consumer();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, n).start();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object LOCK = <span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> isProduced = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">produce</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (LOCK) &#123;</span><br><span class="line">            <span class="keyword">if</span> (isProduced) &#123;</span><br><span class="line">                <span class="comment">//å·²ç»ç”Ÿäº§äº†</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    LOCK.wait();<span class="comment">//ç­‰å¾…æ¶ˆè´¹è€…å”¤é†’</span></span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">"--&gt;"</span> + (++i));<span class="comment">//produce</span></span><br><span class="line">            isProduced = <span class="keyword">true</span>;</span><br><span class="line">            LOCK.notify();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">consumer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (LOCK) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!isProduced) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    LOCK.wait();<span class="comment">//ç­‰å¾…ç”Ÿäº§è€…å”¤é†’</span></span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">"--&gt;"</span> + (i));<span class="comment">//consumer</span></span><br><span class="line">            isProduced = <span class="keyword">false</span>;</span><br><span class="line">            LOCK.notify();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>wait()ï¼š</strong> å½“å‰çº¿ç¨‹<code>é‡Šæ”¾é”</code>è¿›å…¥è¯¥é”å¯¹è±¡çš„<code>ç­‰å¾…é˜Ÿåˆ—</code> </p>
<blockquote>
<p>Causes the current thread to wait until another thread invokes the</p>
<p>{@link java.lang.Object#notify()} method or the</p>
<p>{@link java.lang.Object#notifyAll()} method for this object.</p>
<p>In other words, this method behaves exactly as if it simply</p>
<p>performs the call {@code <code>wait(0)</code>}.</p>
<p>The current thread <code>must own this object&#39;s monitor.</code> The thread</p>
<p><code>releases</code> ownership of this monitor and waits until another thread</p>
<p>notifies threads waiting on this objectâ€™s monitor to wake up</p>
<p>either through a call to the {@code notify} method or the</p>
<p>{@code notifyAll} method. The thread then waits until it can</p>
<p>re-obtain ownership of the monitor and resumes execution.</p>
</blockquote>
<p><strong>wait(long timeout)ï¼š</strong><code>wait()</code>çš„é‡è½½æ–¹æ³•å¾ˆå®¹æ˜“æƒ³åˆ°æ˜¯å¹²å•¥çš„âœ”</p>
<blockquote>
<p>Causes the current thread to wait until either another thread invokes the</p>
<p>{@link java.lang.Object#notify()} method or the</p>
<p>{@link java.lang.Object#notifyAll()} method for this object, or a</p>
<p><code>specified amount of time has elapsed.</code></p>
<p>The current thread must own this objectâ€™s monitor.</p>
<p>@throws  <code>IllegalArgumentException</code>  if the value of timeout is negative.</p>
</blockquote>
<p><strong>notify()ï¼š</strong> å”¤é†’è¯¥<code>é”å¯¹è±¡</code>çš„<code>ç­‰å¾…é˜Ÿåˆ—</code>çš„çº¿ç¨‹ï¼Œå”¤é†’æ–¹æ³•ä¸åŒçš„è™šæ‹Ÿæœºå®ç°ä¸åŒæœ‰çš„å¯èƒ½æ˜¯<code>FCFS</code>æœ‰çš„å¯èƒ½æ˜¯<code>SJF</code> ç­‰ç­‰â€¦.æ‰€ä»¥å”¤é†’çš„æ˜¯é‚£ä¸ªçº¿ç¨‹æ˜¯æ— æ³•ç¡®å®šçš„</p>
<blockquote>
<p>Wakes up a single thread that is <code>waiting on this object&#39;s</code></p>
<p><code>monitor</code>. If any threads are waiting on this object, one of them</p>
<p>is chosen to be awakened. <code>The choice is arbitrary and occurs at</code></p>
<p><code>the discretion of the implementation</code>. A thread waits on an objectâ€™s</p>
<p>monitor by calling one of the {@code wait} methods.</p>
<p>The awakened thread will not be able to proceed until the current</p>
<p>thread <code>relinquishes</code> the lock on this object. The awakened thread will</p>
<p>compete in the usual manner with any other threads that might be</p>
<p>actively competing to synchronize on this object; for example, the</p>
<p>awakened thread enjoys no reliable privilege or disadvantage in being</p>
<p>the next thread to lock this object.</p>
</blockquote>
<p>ç”Ÿäº§è€…ç”Ÿäº§ä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹ä¸€ä¸ªï¼Œæ²¡æ¯›ç—…ï¼Œä½†æ˜¯ä¸Šé¢çš„ä»£ç ä»…ä»…é€‚ç”¨äº<code>å•ç”Ÿäº§è€…&amp;æ¶ˆè´¹è€…</code>å¯¹äºå¤šä¸ªç”Ÿäº§è€…æ¶ˆè´¹è€…å°±ä¼šæœ‰çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œå…·ä½“é—®é¢˜å¦‚ä¸‹</p>
<p><strong>æµ‹è¯•å¤šæ¶ˆè´¹è€…&amp;ç”Ÿäº§è€…</strong></p>
<p>æ²¿ç”¨ä¸Šé¢single p&amp;cçš„ä»£ç ï¼Œæµ‹è¯•å¤šæ¶ˆè´¹è€…å’Œç”Ÿäº§è€…</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    ProduceConsumerVersion3 pc = <span class="keyword">new</span> ProduceConsumerVersion3();</span><br><span class="line">    Stream.of(<span class="string">"Produce1"</span>, <span class="string">"Produce2"</span>, <span class="string">"Produce3"</span>, <span class="string">"Produce4"</span>).forEach(n -&gt; &#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                pc.produce();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, n).start();</span><br><span class="line">    &#125;);</span><br><span class="line">    Stream.of(<span class="string">"Consumer1"</span>, <span class="string">"Consumer2"</span>, <span class="string">"Consumer3"</span>).forEach(n -&gt; &#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                pc.consumer();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, n).start();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œä¼šå‘ç°ç¨‹åºè¿›å…¥<code>â€æ­»é”â€œ</code>çŠ¶æ€ï¼Œç”¨<code>jps&amp;jstack</code>åˆ†æ</p>
<p><img src="http://static.imlgw.top///20190328/pzXBY0ertEVV.png?imageslim" alt="mark"></p>
<p>ç¨‹åºå¹¶æ²¡æœ‰å‘ç°æ­»é”âï¼Œè¿™å°±æ˜¯å¤šç”Ÿäº§è€…å¤šæ¶ˆè´¹è€…ä¼šäº§ç”Ÿçš„<code>å‡æ­»</code>çŠ¶æ€ï¼Œå®é™…ä¸Šæ˜¯æ‰€æœ‰çš„çº¿ç¨‹éƒ½è¿›å…¥äº†<code>wait()</code>çŠ¶æ€éƒ½æ”¾å¼ƒäº†<code>CPU</code>çš„æ‰§è¡Œæƒ</p>
<p><strong>å‡æ­»åŸå› åˆ†æ</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Produce1--&gt;<span class="number">1</span>	notify C1 wait</span><br><span class="line">Consumer1--&gt;<span class="number">1</span>	notify P1 wait</span><br><span class="line">Produce1--&gt;<span class="number">2</span>    notify C2 wait</span><br><span class="line">Consumer2--&gt;<span class="number">2</span>   notify P2 wait</span><br><span class="line">Produce2--&gt;<span class="number">3</span>	notify P1 wait ---&gt; Produce1--&gt;wait</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢æ˜¯å…¶ä¸­ä¸€ç§æƒ…å†µï¼Œå¤§è‡´åˆ†æä¸‹ï¼šå‰ä¸¤æ¬¡ç”Ÿäº§æ¶ˆè´¹éƒ½æ­£å¸¸ä¸€ä¸ª<code>æ¶ˆè´¹è€…</code>å”¤é†’ä¸€ä¸ª<code>ç”Ÿäº§è€…</code>ï¼Œå‰ä¸¤æ¬¡æ‰§è¡Œå®Œä¹‹å<code>P1 C1 C2</code>éƒ½è¿›å…¥<code>wait</code>çŠ¶æ€ç„¶åç¬¬ä¸‰æ¬¡ç”Ÿäº§çš„æ—¶å€™<code>P2</code>å”¤é†’äº†ä¸€ä¸ªä¸è¯¥å”¤é†’çš„äººğŸ˜‚ å”¤é†’äº†<code>P1</code>ç„¶å<code>wait</code>äº†ï¼Œ<code>P1</code>é†’æ¥åå‘ç°å·²ç»ç”Ÿäº§äº†ç„¶åä¹Ÿ<code>wait</code>å»äº†ï¼Œè‡³æ­¤æ‰€æœ‰çš„çº¿ç¨‹å…¨éƒ¨è¿›å…¥<code>wait</code>çŠ¶æ€å°±é€ æˆäº†å‡æ­»ã€‚è¿™ä¸ªé—®é¢˜è®°å¾—å¤§ä¸€çš„æ—¶å€™è¿˜é—®è¿‡è€å¸ˆå½“æ—¶ç‰¹åˆ«çº ç»“ä¸ºå•¥ä¼šæ­»é”ï¼Œç°åœ¨çœ‹çœ‹å…¶å®ä¹Ÿæ²¡å•¥ï¼Œä¸»è¦å°±æ˜¯<code>notify</code>å”¤é†’çš„çº¿ç¨‹æ˜¯ä¸ç¡®å®šçš„ï¼Œæ˜¯ç”±<code>JVM</code>å†³å®šçš„æ¯ç§<code>JDK</code>çš„å®ç°ä¹Ÿä¸å¤ªä¸€æ ·ï¼Œæ— æ³•ä¿è¯æ¶ˆè´¹è€…ä¸€å®šå”¤é†’ç”Ÿäº§è€…ï¼Œåä¹‹äº¦ç„¶ã€‚</p>
<p><strong>å¤šç”Ÿäº§è€…&amp;å¤šæ¶ˆè´¹è€…</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.stream.Stream;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProduceConsumerVersion3</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ProduceConsumerVersion3 pc = <span class="keyword">new</span> ProduceConsumerVersion3();</span><br><span class="line">        Stream.of(<span class="string">"Produce1"</span>, <span class="string">"Produce2"</span>, <span class="string">"Produce3"</span>, <span class="string">"Produce4"</span>).forEach(n -&gt; &#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                    pc.produce();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, n).start();</span><br><span class="line">        &#125;);</span><br><span class="line">        Stream.of(<span class="string">"Consumer1"</span>, <span class="string">"Consumer2"</span>, <span class="string">"Consumer3"</span>).forEach(n -&gt; &#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                    pc.consumer();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, n).start();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object LOCK = <span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> isProduced = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">produce</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (LOCK) &#123;</span><br><span class="line">            <span class="keyword">while</span> (isProduced) &#123;</span><br><span class="line">                <span class="comment">//å·²ç»ç”Ÿäº§äº†</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    LOCK.wait(); <span class="comment">//åŠ å…¥LOCKé”çš„waité˜Ÿåˆ—</span></span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">"--&gt;"</span> + (++i));<span class="comment">//produce</span></span><br><span class="line">            isProduced = <span class="keyword">true</span>;</span><br><span class="line">            LOCK.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">consumer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (LOCK) &#123;</span><br><span class="line">            <span class="keyword">while</span> (!isProduced) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    LOCK.wait();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">"--&gt;"</span> + (i));<span class="comment">//consumer</span></span><br><span class="line">            isProduced = <span class="keyword">false</span>;</span><br><span class="line">            LOCK.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>notifyAll()ï¼š</strong>å”¤é†’å½“å‰é”å¯¹è±¡ç­‰å¾…é˜Ÿåˆ—ä¸Šçš„<code>æ‰€æœ‰</code>çº¿ç¨‹</p>
<blockquote>
<p>Wakes up <code>all threads</code> that are waiting on <code>this object&#39;s monitor</code>. A</p>
<p>thread waits on an objectâ€™s monitor by calling one of the</p>
<p>{@code wait} methods.</p>
<p>The awakened threads will not be able to proceed until the current</p>
<p>thread relinquishes the lock on this object. The awakened threads</p>
<p>will <code>compete in the usual manner</code> with any other threads that might</p>
<p>be actively competing to synchronize on this object; for example,</p>
<p>the awakened threads enjoy <code>no reliable privilege or disadvantage</code> in</p>
<p>being the next thread to lock this object.</p>
</blockquote>
<p>â‘  ä¸ºäº†è§£å†³ä¸Šé¢çš„<code>å‡æ­»</code>é—®é¢˜è¿™é‡Œä½¿ç”¨äº†<code>notifyAll()</code>æ¥å”¤é†’<code>ç­‰å¾…é˜Ÿåˆ—</code>çš„çº¿ç¨‹ï¼Œçœ‹åå­—å°±çŸ¥é“è¿™ä¸ªæ–¹æ³•ä¼šå”¤é†’æ‰€æœ‰çš„çº¿ç¨‹ï¼Œé‚£ä¹ˆä¸Šé¢çš„å‡æ­»é—®é¢˜å°±è‡ªç„¶è§£å†³äº†ã€‚</p>
<p>â‘¡ è¿˜æœ‰ä¸€ç‚¹ä¸åŒçš„æ˜¯è¿™é‡Œåˆ¤æ–­ç”Ÿäº§çŠ¶æ€æ—¶ç”¨çš„æ˜¯<code>while</code>è€Œä¸æ˜¯<code>if</code>ä¸ºä»€ä¹ˆä¸ç”¨<code>if</code>? å…¶å®ä¹Ÿå¾ˆå¥½ç†è§£å¦‚æœæœ‰å¤šä¸ªç”Ÿäº§è€…æˆ–è€…æ¶ˆè´¹è€…åŒæ—¶åœ¨<code>ç­‰å¾…é˜Ÿåˆ—</code>ä¸­ï¼Œç„¶åå…¶ä¸­ä¸€ä¸ªæŠ¢åˆ°é”åæ‰§è¡Œï¼Œæ‰§è¡Œå®Œç”Ÿäº§åå”¤é†’äº†æ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹ï¼Œå‡è®¾å”¤é†’çš„æ˜¯<code>ç”Ÿäº§è€…</code>çš„è¯ï¼Œå› ä¸ºæ˜¯<code>ifè¯­å¥</code>æ§åˆ¶çš„è¢«å”¤é†’çš„ç”Ÿäº§è€…æŠ¢åˆ°é”ä¹‹åå°±ç›´æ¥é¡ºç€æ‰§è¡Œä¸‹å»äº†ï¼Œå°±ç›´æ¥å»ç”Ÿäº§äº†ï¼Œå°±ä¼šé€ æˆ<code>é‡å¤çš„ç”Ÿäº§</code>å½“ç„¶ç”¨<code>else</code>è¯­å¥è²Œä¼¼å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½†æ˜¯é‚£ä¼šå½±å“æ•ˆç‡ï¼ˆä¸ªäººæ„Ÿè§‰ï¼‰ï¼Œè€Œä¸”å¾ˆåˆ«æ‰­ï¼ˆè¢«å”¤é†’äº†ç›´æ¥é€€å‡ºï¼Ÿï¼Ÿï¼Ÿï¼‰. æ‰€ä»¥è¿™é‡Œç”¨<code>while</code>æ¥è¿›è¡Œ<code>äºŒæ¬¡æ£€æµ‹</code>é¿å…è¿™ç§æƒ…å†µï¼Œè¿™ç§whileå¾ªç¯ä¹Ÿè¢«ç§°ä¸º<code>è‡ªæ—‹é”</code> è¿™ä¸€å—åé¢çš„æ–‡ç« ä¼šå†è¯¦ç»†çš„è®²ã€‚</p>
<h3 id="ä¸ºä»€ä¹ˆwaitå’Œnotifyå¿…é¡»åœ¨åŒæ­¥æ–¹æ³•æˆ–åŒæ­¥å—ä¸­è°ƒç”¨ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆwaitå’Œnotifyå¿…é¡»åœ¨åŒæ­¥æ–¹æ³•æˆ–åŒæ­¥å—ä¸­è°ƒç”¨ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆwaitå’Œnotifyå¿…é¡»åœ¨åŒæ­¥æ–¹æ³•æˆ–åŒæ­¥å—ä¸­è°ƒç”¨ï¼Ÿ"></a>ä¸ºä»€ä¹ˆwaitå’Œnotifyå¿…é¡»åœ¨åŒæ­¥æ–¹æ³•æˆ–åŒæ­¥å—ä¸­è°ƒç”¨ï¼Ÿ</h3><p>è¿™æ˜¯<code>é˜¿é‡Œå·´å·´</code>çš„ä¸€é“é¢è¯•é¢˜</p>
<p>â‘  é¦–å…ˆä»è¯­æ³•å±‚é¢è®²ï¼Œå¦‚æœä¸åœ¨åŒæ­¥æ–¹æ³•å’ŒåŒæ­¥ä»£ç å—ä¸­è°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯è¯´æ²¡æœ‰åŠ é”ï¼Œè‡ªç„¶å°±ä¸ç”¨è°ˆæ˜¯ä¸æ˜¯<code>é”å¯¹è±¡çš„æŒæœ‰è€…</code> ï¼Œå°±ä¼šæŠ¥<code>IllegalMonitorStateException</code>.</p>
<blockquote>
<p>@throws  <code>IllegalMonitorStateException</code>  if the current thread is not</p>
<p>the owner of the objectâ€™s monitor.</p>
</blockquote>
<p>â‘¡è®¾æƒ³ä¸‹å¦‚æœä¸åŠ é”å¯ä»¥ç›´æ¥è°ƒç”¨ï¼Œå°±ä¼šäº§ç”Ÿæ‰€è°“çš„<code>ç«æ€æ¡ä»¶</code>ï¼Œå‡è®¾<code>wait()</code>,<code>notify()</code>,<code>notifyAll()</code>æ–¹æ³•ä¸éœ€è¦åŠ é”å°±èƒ½å¤Ÿè¢«è°ƒç”¨ã€‚æ­¤æ—¶æ¶ˆè´¹è€…çº¿ç¨‹è°ƒç”¨<code>wait()</code>æ­£åœ¨è¿›å…¥çŠ¶æ€å˜é‡çš„ç­‰å¾…é˜Ÿåˆ—(è¯‘è€…æ³¨:å¯èƒ½è¿˜æœªè¿›å…¥)ã€‚åœ¨åŒä¸€æ—¶åˆ»ï¼Œç”Ÿäº§è€…çº¿ç¨‹è°ƒç”¨<code>notify()</code>æ–¹æ³•æ‰“ç®—å‘æ¶ˆè´¹è€…çº¿ç¨‹é€šçŸ¥çŠ¶æ€æ”¹å˜ã€‚é‚£ä¹ˆæ­¤æ—¶æ¶ˆè´¹è€…çº¿ç¨‹å°†é”™è¿‡è¿™ä¸ªé€šçŸ¥å¹¶ä¸€ç›´é˜»å¡ã€‚å› æ­¤ï¼Œå¯¹è±¡çš„<code>wait()</code>,<code>notify()</code>,<code>notifyAll()</code>æ–¹æ³•å¿…é¡»åœ¨è¯¥å¯¹è±¡çš„åŒæ­¥æ–¹æ³•æˆ–åŒæ­¥ä»£ç å—ä¸­è¢«äº’æ–¥åœ°è°ƒç”¨ã€‚</p>
<blockquote>
<p>è®¡ç®—çš„æ­£ç¡®æ€§å–å†³äºå¤šä¸ªçº¿ç¨‹çš„äº¤æ›¿æ‰§è¡Œæ—¶åºæ—¶å°±ä¼šäº§ç”Ÿç«æ€æ¡ä»¶</p>
</blockquote>
<h3 id="wait-åè¢«å”¤é†’ä¼šæ€ä¹ˆæ ·ï¼Ÿ"><a href="#wait-åè¢«å”¤é†’ä¼šæ€ä¹ˆæ ·ï¼Ÿ" class="headerlink" title="wait()åè¢«å”¤é†’ä¼šæ€ä¹ˆæ ·ï¼Ÿ"></a>wait()åè¢«å”¤é†’ä¼šæ€ä¹ˆæ ·ï¼Ÿ</h3><p>ä¸Šé¢è¯´åˆ°è¢«å”¤é†’åä¼šå»æŠ¢é”ï¼Œä½†æ˜¯è¿™é‡Œæœ‰äººå¯èƒ½ä¼šæœ‰ç–‘é—®ï¼Œå»æŠ¢é”ä¼šä¸ä¼šå›åˆ°åŒæ­¥çš„èµ·ç‚¹å»äº‰æŠ¢é”ï¼Œç„¶åæŠŠwaitå‰çš„é€»è¾‘å†æ‰§è¡Œä¸€éï¼Ÿè¿™é‡Œè‚¯å®šäº‹ä¸ä¼šçš„ï¼Œç¡®å®æ˜¯è¦æŠ¢é”ä½†æ˜¯ä¼šæœ‰è®°å½•ä¼šç»§ç»­é¡ºç€waitæ–¹æ³•èµ°ä¸‹å»ã€‚</p>
<h3 id="notifyå’Œä¸­æ–­çš„ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„ç°è±¡"><a href="#notifyå’Œä¸­æ–­çš„ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„ç°è±¡" class="headerlink" title="notifyå’Œä¸­æ–­çš„ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„ç°è±¡"></a>notifyå’Œä¸­æ–­çš„ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„ç°è±¡</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NotifyInter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">int</span> a = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Object object = <span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line">        NotifyInter waitNotify = <span class="keyword">new</span> NotifyInter();</span><br><span class="line"></span><br><span class="line">        Thread thread1 = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">synchronized</span> (object) &#123;</span><br><span class="line">                    System.out.println(<span class="string">"çº¿ç¨‹1 è·å–åˆ°ç›‘è§†å™¨é”"</span>);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        object.wait();</span><br><span class="line">                        System.out.println(<span class="string">"çº¿ç¨‹1 æ­£å¸¸æ¢å¤å•¦ã€‚ä½†æ˜¯ isInterrupt = "</span>+ Thread.currentThread().isInterrupted());</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        System.out.println(<span class="string">"çº¿ç¨‹1 waitæ–¹æ³•æŠ›å‡ºäº†InterruptedExceptionå¼‚å¸¸"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"çº¿ç¨‹1"</span>);</span><br><span class="line">        thread1.start();</span><br><span class="line"></span><br><span class="line">        Thread thread2 = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">synchronized</span> (object) &#123;</span><br><span class="line">                    System.out.println(<span class="string">"çº¿ç¨‹2 è·å–åˆ°ç›‘è§†å™¨é”"</span>);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        object.wait();</span><br><span class="line">                        System.out.println(<span class="string">"çº¿ç¨‹2 æ­£å¸¸æ¢å¤å•¦ã€‚"</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        System.out.println(<span class="string">"çº¿ç¨‹2 waitæ–¹æ³•æŠ›å‡ºäº†InterruptedExceptionå¼‚å¸¸"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"çº¿ç¨‹2"</span>);</span><br><span class="line">        thread2.start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¿™é‡Œè®© thread1 å’Œ thread2 å…ˆèµ·æ¥ï¼Œç„¶åå†èµ·åé¢çš„ thread3</span></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (object) &#123;</span><br><span class="line">                    System.out.println(<span class="string">"çº¿ç¨‹3 æ‹¿åˆ°äº†ç›‘è§†å™¨é”ã€‚"</span>);</span><br><span class="line">                    System.out.println(<span class="string">"çº¿ç¨‹3 è®¾ç½®çº¿ç¨‹1ä¸­æ–­"</span>);</span><br><span class="line">                    thread1.interrupt(); <span class="comment">// 1</span></span><br><span class="line">                    <span class="comment">//waitNotify.a = 1; // è¿™è¡Œæ˜¯ä¸ºäº†ç¦æ­¢ä¸Šä¸‹çš„ä¸¤è¡Œä¸­æ–­å’Œnotifyä»£ç é‡æ’åº</span></span><br><span class="line">                    System.out.println(<span class="string">"çº¿ç¨‹3 è°ƒç”¨notify"</span>);</span><br><span class="line">                    object.notify(); <span class="comment">//2</span></span><br><span class="line">                    System.out.println(<span class="string">"çº¿ç¨‹3 è°ƒç”¨å®Œnotifyåï¼Œä¼‘æ¯ä¸€ä¼š"</span>);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    &#125;</span><br><span class="line">                    System.out.println(<span class="string">"çº¿ç¨‹3 ä¼‘æ¯å¤Ÿäº†ï¼Œç»“æŸåŒæ­¥ä»£ç å—"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"çº¿ç¨‹3"</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¤šæ‰§è¡Œå‡ æ¬¡å¯èƒ½å°±å¯èƒ½ä¼šå‘ç”Ÿå¦‚ä¸‹æƒ…å†µï¼Œçº¿ç¨‹1è¢«æ‰“æ–­åå±…ç„¶æ­£å¸¸çš„è¿”å›äº†ï¼ï¼ï¼ï¼çº¿ç¨‹2è¢«é˜»å¡ä½äº†</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">çº¿ç¨‹<span class="number">1</span> è·å–åˆ°ç›‘è§†å™¨é”</span><br><span class="line">çº¿ç¨‹<span class="number">2</span> è·å–åˆ°ç›‘è§†å™¨é”</span><br><span class="line">çº¿ç¨‹<span class="number">3</span> æ‹¿åˆ°äº†ç›‘è§†å™¨é”ã€‚</span><br><span class="line">çº¿ç¨‹<span class="number">3</span> è®¾ç½®çº¿ç¨‹<span class="number">1</span>ä¸­æ–­</span><br><span class="line">çº¿ç¨‹<span class="number">3</span> è°ƒç”¨notify</span><br><span class="line">çº¿ç¨‹<span class="number">3</span> è°ƒç”¨å®Œnotifyåï¼Œä¼‘æ¯ä¸€ä¼š</span><br><span class="line">çº¿ç¨‹<span class="number">3</span> ä¼‘æ¯å¤Ÿäº†ï¼Œç»“æŸåŒæ­¥ä»£ç å—</span><br><span class="line">çº¿ç¨‹<span class="number">1</span> æ­£å¸¸æ¢å¤å•¦ã€‚ä½†æ˜¯ isInterrupt = <span class="keyword">true</span></span><br></pre></td></tr></table></figure>

<p>å…¶å®è¿™é‡Œä¸»è¦é—®é¢˜å°±æ˜¯ <code>notify()</code> å’Œ<code>interrupt()</code> æ‰§è¡Œé¡ºåºçš„é—®é¢˜</p>
<ul>
<li><p>å¦‚æœå…ˆè¢«æ‰“æ–­ï¼Œé‚£ä¹ˆåç»­çš„notifyä¼šè¿™ä¸ªçº¿ç¨‹æ— æ•ˆï¼Œä¾ç„¶ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå¦‚æœè¿™æ˜¯è¯¥é”å®ä¾‹ä¸Šä»ç„¶æœ‰å…¶ä»–çº¿ç¨‹å¤„äºwaitçŠ¶æ€ï¼Œé‚£ä¹ˆè¿™ä¸ªnotifyä¼šå”¤é†’å…¶ä¸­çš„ä¸€ä¸ªï¼Œä¸èƒ½è™šå‘ï¼Œå…·ä½“å¯ä»¥å‚è€ƒ <a href="https://docs.oracle.com/javase/specs/jls/se8/html/jls-17.html#jls-17.2.4" target="_blank" rel="noopener">Javaè¯­è¨€è§„èŒƒæ–‡æ¡£17.2.4</a></p>
<blockquote>
<p>The above specifications allow us to determine several properties having to do with the interaction of waits, notification, and interruption.</p>
<p>If a thread is both notified and interrupted while waiting, it may either:</p>
<ul>
<li>return normally from <code>wait</code>, while still having a pending interrupt (in other words, a call to <code>Thread.interrupted</code> would return true)</li>
<li>return from <code>wait</code> by throwing an <code>InterruptedException</code></li>
</ul>
<p>The thread may not reset its interrupt status and return normally from the call to <code>wait</code>.</p>
<p>Similarly, notifications cannot be lost due to interrupts. Assume that a set <em>s</em> of threads is in the wait set of an object <em>m</em>, and another thread performs a <code>notify</code> on <em>m</em>. Then either:</p>
<ul>
<li>at least one thread in <em>s</em> must return normally from <code>wait</code>, or</li>
<li>all of the threads in <em>s</em> must exit <code>wait</code> by throwing <code>InterruptedException</code></li>
</ul>
<p>Note that if a thread is both interrupted and woken via <code>notify</code>, and that thread returns from <code>wait</code> by throwing an <code>InterruptedException</code>, then some other thread in the wait set must be notified.</p>
</blockquote>
</li>
<li><p>å¦‚æœå…ˆè¢«notify()ï¼Œé‚£ä¹ˆçº¿ç¨‹ä¼šä»waitä¸­é†’æ¥ï¼Œç„¶åä¸­æ–­ï¼Œè®¾ç½®ä¸­æ–­æ ‡å¿—ä½ä¸º trueï¼Œä½†ä¸ä¼šåœ¨è¿™ä¸ªwaitä¸ŠæŠ›å‡ºå¼‚å¸¸ï¼Œè€Œä¼šå½±å“åé¢çš„é˜»å¡æ“ä½œï¼Œå…·ä½“å¯ä»¥çœ‹ä¸‹é¢çš„Demo</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NotifyInter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">int</span> a = <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Object object = <span class="keyword">new</span> Object();</span><br><span class="line">        NotifyInter waitNotify = <span class="keyword">new</span> NotifyInter();</span><br><span class="line">        Thread thread1 = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (object) &#123;</span><br><span class="line">                    System.out.println(<span class="string">"çº¿ç¨‹1 è·å–åˆ°ç›‘è§†å™¨é”"</span>);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        object.wait();</span><br><span class="line">                        System.out.println(<span class="string">"çº¿ç¨‹1 æ­£å¸¸æ¢å¤å•¦ã€‚ä½†æ˜¯ isInterrupt = "</span>+ Thread.currentThread().isInterrupted());</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        System.out.println(<span class="string">"çº¿ç¨‹1 waitæ–¹æ³•æŠ›å‡ºäº†InterruptedExceptionå¼‚å¸¸"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                        System.out.println(<span class="string">"åœ¨sleepä¸­è¢«ä¸­æ–­"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"çº¿ç¨‹1"</span>);</span><br><span class="line">        thread1.start();</span><br><span class="line">        <span class="comment">// è¿™é‡Œè®© thread1 å’Œ thread2 å…ˆèµ·æ¥ï¼Œç„¶åå†èµ·åé¢çš„ thread3</span></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (object) &#123;</span><br><span class="line">                    System.out.println(<span class="string">"çº¿ç¨‹3 æ‹¿åˆ°äº†ç›‘è§†å™¨é”ã€‚"</span>);</span><br><span class="line">                    System.out.println(<span class="string">"çº¿ç¨‹3 è®¾ç½®çº¿ç¨‹1ä¸­æ–­"</span>);</span><br><span class="line">                    object.notify(); <span class="comment">//2</span></span><br><span class="line">                    waitNotify.a = <span class="number">1</span>; <span class="comment">// è¿™è¡Œæ˜¯ä¸ºäº†ç¦æ­¢ä¸Šä¸‹çš„ä¸¤è¡Œä¸­æ–­å’Œnotifyä»£ç é‡æ’åº</span></span><br><span class="line">                    thread1.interrupt(); <span class="comment">// 1</span></span><br><span class="line">                    System.out.println(<span class="string">"çº¿ç¨‹3 è°ƒç”¨notify"</span>);</span><br><span class="line">                    System.out.println(<span class="string">"çº¿ç¨‹3 è°ƒç”¨å®Œnotifyåï¼Œä¼‘æ¯ä¸€ä¼š"</span>);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    &#125;</span><br><span class="line">                    System.out.println(<span class="string">"çº¿ç¨‹3 ä¼‘æ¯å¤Ÿäº†ï¼Œç»“æŸåŒæ­¥ä»£ç å—"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"çº¿ç¨‹3"</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="wait-å’Œsleep-çš„åŒºåˆ«"><a href="#wait-å’Œsleep-çš„åŒºåˆ«" class="headerlink" title="wait()å’Œsleep()çš„åŒºåˆ«"></a>wait()å’Œsleep()çš„åŒºåˆ«</h3><p>è¿™ä¹Ÿæ˜¯ä¸€é“é¢è¯•å¸¸é—®çš„é¢˜</p>
<p>â‘  é¦–å…ˆ<code>sleep()</code>æ˜¯çº¿ç¨‹Threadçš„é™æ€æ–¹æ³•ï¼Œ<code>wait()</code>æ˜¯<code>Object</code>ç±»çš„å®ä¾‹æ–¹æ³•</p>
<p>â‘¡<code>sleep()</code>ä¸ä¼šé‡Šæ”¾é”å¯¹è±¡ï¼Œ<code>wait()</code>ä¼šé‡Šæ”¾é”å¯¹è±¡ï¼Œè¿™ä¸€ç‚¹æ¯”è¾ƒé‡è¦</p>
<p>â‘¢ æ‰¿æ¥ç¬¬äºŒç‚¹ï¼Œ<code>wait()</code>ä¼šé‡Šæ”¾é”ï¼Œä½†æ˜¯è¦æ˜¯ä½ æ²¡æœ‰é”å‘¢ï¼Ÿå…¶å®å°±æ˜¯ä¸Šé¢è¯­æ³•å±‚é¢è¯´åˆ°çš„ï¼Œæ‰€ä»¥è°ƒç”¨<code>wait()</code>å¿…é¡»è¦<code>æŒæœ‰</code>é”å¯¹è±¡å¦åˆ™å°±ä¼šæŠ¥<code>IllegalMonitorStateException</code></p>
<p>â‘£<code>sleep()</code>ä¸éœ€è¦è¢«å”¤é†’<code>timeout</code>åä¼šè‡ªåŠ¨é†’æ¥ï¼Œè€Œ<code>wait()</code>éœ€è¦è¢«å…¶ä»–çº¿ç¨‹å”¤é†’ï¼ˆ<code>wait(long time)</code>é™¤å¤–ï¼‰</p>
<h3 id="çº¿ç¨‹é€šè®¯ç»¼åˆæ¡ˆä¾‹"><a href="#çº¿ç¨‹é€šè®¯ç»¼åˆæ¡ˆä¾‹" class="headerlink" title="çº¿ç¨‹é€šè®¯ç»¼åˆæ¡ˆä¾‹"></a>çº¿ç¨‹é€šè®¯ç»¼åˆæ¡ˆä¾‹</h3><p>æ§åˆ¶åŒä¸€æ—¶é—´æ‰§è¡ŒåŒä¸€æ–¹æ³•çº¿ç¨‹çš„æ•°é‡</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ControlThreadNum</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> LinkedList THREADS = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> MAX_THREAD = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">        List&lt;Thread&gt; worker = <span class="keyword">new</span> ArrayList();</span><br><span class="line">        <span class="comment">//åˆ›å»ºäº†åä¸ªçº¿ç¨‹ï¼Œä½†æ˜¯æ§åˆ¶æ¯æ¬¡æœ€å¤šåŒæ—¶è¿è¡Œçš„åªæœ‰5ä¸ª</span></span><br><span class="line">        Arrays.asList(<span class="string">"M1"</span>, <span class="string">"M2"</span>, <span class="string">"M3"</span>, <span class="string">"M4"</span>, <span class="string">"M5"</span>, <span class="string">"M6"</span>, <span class="string">"M7"</span>, <span class="string">"M8"</span>, <span class="string">"M9"</span>, <span class="string">"M10"</span>).stream().map(ControlThreadNum::captureThread).forEach(t -&gt; &#123;</span><br><span class="line">            t.start();</span><br><span class="line">            worker.add(t);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">//mainçº¿ç¨‹ç­‰å¾…workerçš„çº¿ç¨‹éƒ½æ‰§è¡Œå®Œ</span></span><br><span class="line">        worker.stream().forEach(thread -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                thread.join();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        Optional.of(<span class="string">"All capture is done"</span>).ifPresent(System.out::println);</span><br><span class="line">        Optional.of(System.currentTimeMillis() - start).ifPresent(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Thread <span class="title">captureThread</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            Optional.of(<span class="string">"Thread "</span> + Thread.currentThread().getName() + <span class="string">"  is begin"</span>).ifPresent(System.out::println);</span><br><span class="line">            <span class="keyword">synchronized</span> (THREADS) &#123;</span><br><span class="line">                <span class="keyword">while</span> (THREADS.size() &gt;= MAX_THREAD) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        THREADS.wait();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//THREADS åªæ˜¯ç”¨æ¥æ§åˆ¶æ•°é‡&amp;é” å…ƒç´ æ˜¯ä»€ä¹ˆå¹¶ä¸é‡è¦</span></span><br><span class="line">                THREADS.addLast(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//åˆ°è¿™é‡Œæ˜¯å¹¶è¡Œ</span></span><br><span class="line">            Optional.of(<span class="string">"Thread "</span> + Thread.currentThread().getName() + <span class="string">"  is running"</span>).ifPresent(System.out::println);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">10000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">synchronized</span> (THREADS) &#123;</span><br><span class="line">                Optional.of(<span class="string">"Thread "</span> + Thread.currentThread().getName() + <span class="string">"  is end"</span>).ifPresent(System.out::println);</span><br><span class="line">                THREADS.removeLast();</span><br><span class="line">                THREADS.notifyAll();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œä¸€å¼€å§‹ä¸€å…±åˆ›å»ºäº†10ä¸ªçº¿ç¨‹ï¼Œä½†æ˜¯æ‰§è¡Œçš„æ—¶å€™ä¼šæ§åˆ¶<code>running</code>çš„ä¸ªæ•°å°äº5ä¸ªï¼Œ<code>runnning</code>çº¿ç¨‹ä¸ªæ•°ç”¨ä¸€ä¸ª<code>LinkList</code>è®°å½•ï¼Œè‹¥<code>size()&gt;=5</code>å°±è¿›å…¥<code>wait</code>ç„¶åå¦‚æœæœ‰çº¿ç¨‹<code>end</code>å°±ä¼š<code>notifyAll</code>å”¤é†’è¿›å…¥ç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Thread M2  is begin</span><br><span class="line">Thread M3  is begin</span><br><span class="line">Thread M2  is running</span><br><span class="line">Thread M1  is begin</span><br><span class="line">Thread M1  is running</span><br><span class="line">Thread M3  is running</span><br><span class="line">Thread M4  is begin</span><br><span class="line">Thread M4  is running</span><br><span class="line">Thread M5  is begin</span><br><span class="line">Thread M6  is begin</span><br><span class="line">Thread M5  is running</span><br><span class="line">Thread M7  is begin</span><br><span class="line">Thread M8  is begin</span><br><span class="line">Thread M9  is begin</span><br><span class="line">Thread M10  is begin</span><br><span class="line">Thread M3  is `end`</span><br><span class="line">Thread M10  is running</span><br><span class="line">Thread M5  is `end`</span><br><span class="line">Thread M1  is `end`</span><br><span class="line">Thread M2  is `end`</span><br><span class="line">Thread M4  is `end`</span><br><span class="line">Thread M6  is running</span><br><span class="line">Thread M7  is running</span><br><span class="line">Thread M9  is running</span><br><span class="line">Thread M8  is running</span><br><span class="line">Thread M10  is end</span><br><span class="line">Thread M8  is end</span><br><span class="line">Thread M9  is end</span><br><span class="line">Thread M7  is end</span><br><span class="line">Thread M6  is end</span><br><span class="line">All capture is done</span><br><span class="line"><span class="number">20124</span></span><br></pre></td></tr></table></figure>

<p>è¿™æ ·å°±æ˜¯å…¶å®å°±æ˜¯ä¸ºäº†æé«˜æ•ˆç‡ï¼Œçº¿ç¨‹å¹¶ä¸æ˜¯è¶Šå¤šè¶Šå¥½ï¼Œçº¿ç¨‹åˆ›å»ºå¤ªå¤šï¼Œå°±ä¼šè¾¾åˆ°ç“¶é¢ˆï¼Œæ•ˆç‡åè€Œä¼šé™ä½ï¼Œå› ä¸ºæ—¶é—´éƒ½æ¶ˆè€—åœ¨äº†<code>çº¿ç¨‹åˆ‡æ¢</code>ä¸Šäº†ï¼Œå½“ç„¶è¿™æ˜¯åœ¨æ²¡æœ‰<code>çº¿ç¨‹æ± </code>çš„æƒ…å†µä¸‹ï¼Œåé¢ç”¨<code>çº¿ç¨‹æ± </code>å°±ä¸ä¼šè¿™ä¹ˆéº»çƒ¦äº†ã€‚</p>
<h3 id="wait-notifyçš„å¼€é”€åŠé—®é¢˜"><a href="#wait-notifyçš„å¼€é”€åŠé—®é¢˜" class="headerlink" title="wait()/notifyçš„å¼€é”€åŠé—®é¢˜"></a>wait()/notifyçš„å¼€é”€åŠé—®é¢˜</h3><p><strong>è¿‡æ—©å”¤é†’</strong> </p>
<p> æ¯”å¦‚ç”Ÿäº§è€…æ¶ˆè´¹è€…é—®é¢˜ä¸­ç”Ÿäº§è€…ç”Ÿäº§åå”¤é†’äº†ç”Ÿäº§è€…ï¼Œå…¶å®å°±æ˜¯è¿‡æ—©å”¤é†’äº†ï¼Œè¿‡æ—©å”¤é†’ä½¿å¾—é‚£äº›æœ¬æ¥æ— é¡»è¢«å”¤é†’çš„ç­‰å¾…çº¿ç¨‹ä¹Ÿè¢«å”¤é†’äº†ï¼Œä»è€Œé€ æˆèµ„æºæµªè´¹ã€‚è¿™å°±å¥½æ¯”ä½ åœ¨äººç¾¤é‡Œå¤§å–Šä¸€å£°â€œç¾å¥³â€ï¼Œä¾¿ä¼šæœ‰è®¸å¤šè‡ªæˆ‘æ„Ÿè§‰è‰¯å¥½çš„å¥³æ€§å›å¤´ä¸€æ ·â€”â€”å°½ç®¡ä½ è¦å–Šçš„ä»…ä»…æ˜¯å…¶ä¸­æŸä¸€ä¸ªäººï¼Œä½†å¤§å®¶å´éƒ½ä»¥ä¸ºä½ æ˜¯åœ¨å–Šè‡ªå·±ã€‚è¿‡æ—©å”¤é†’é—®é¢˜å¯ä»¥åˆ©ç”¨JDK<br>1.5å¼•å…¥çš„<code>java.util.concurrent.locks.Condition</code>æ¥å£æ¥è§£å†³ï¼Œåé¢çš„æ–‡ç« ä¼šè®²åˆ°ã€‚</p>
<p><strong>ä¿¡å·ä¸¢å¤±</strong></p>
<p>ä¿¡å·ä¸¢å¤±ï¼ˆMissed Signalï¼‰é—®é¢˜ã€‚å¦‚æœç­‰å¾…çº¿ç¨‹åœ¨æ‰§è¡Œ<code>Object.wait()</code>å‰æ²¡æœ‰å…ˆåˆ¤æ–­ä¿æŠ¤æ¡ä»¶æ˜¯å¦å·²ç„¶æˆç«‹ï¼Œé‚£ä¹ˆæœ‰å¯èƒ½å‡ºç°è¿™ç§æƒ…å½¢â€”â€”é€šçŸ¥çº¿ç¨‹åœ¨è¯¥ç­‰å¾…çº¿ç¨‹è¿›äººä¸´ç•ŒåŒºä¹‹å‰å°±å·²ç»æ›´æ–°äº†ç›¸å…³å…±äº«å˜é‡ï¼Œä½¿å¾—ç›¸åº”çš„ä¿æŠ¤æ¡ä»¶æˆç«‹å¹¶è¿›è¡Œäº†é€šçŸ¥ï¼Œä½†æ˜¯æ­¤æ—¶ç­‰å¾…çº¿ç¨‹è¿˜æ²¡æœ‰è¢«æš‚åœï¼Œè‡ªç„¶ä¹Ÿå°±æ— æ‰€è°“å”¤é†’äº†ã€‚è¿™å°±å¯èƒ½é€ æˆç­‰å¾…çº¿ç¨‹ç›´æ¥æ‰§è¡Œ<code>Object.wait()</code>è€Œè¢«æš‚åœçš„æ—¶å€™ï¼Œè¯¥çº¿ç¨‹ç”±äºæ²¡æœ‰å…¶ä»–çº¿ç¨‹è¿›è¡Œé€šçŸ¥è€Œä¸€ç›´å¤„äºç­‰å¾…çŠ¶æ€ã€‚è¿™ç§ç°è±¡å°±ç›¸å½“äºç­‰å¾…çº¿ç¨‹é”™è¿‡äº†ä¸€ä¸ªæœ¬æ¥â€œå‘é€â€ç»™å®ƒçš„â€œä¿¡å·â€ï¼Œå› æ­¤è¢«ç§°ä¸ºä¿¡å·ä¸¢å¤±ï¼ˆMissed Signalï¼‰ã€‚åªè¦å°†å¯¹ä¿æŠ¤æ¡ä»¶çš„åˆ¤æ–­å’Œ<code>Object.wait()</code>è°ƒç”¨æ”¾åœ¨ä¸€ä¸ªå¾ªç¯è¯­å¥ä¹‹ä¸­å°±å¯ä»¥é¿å…ä¸Šè¿°åœºæ™¯çš„ä¿¡å·ä¸¢å¤±ã€‚ä¿¡å·ä¸¢å¤±çš„å¦å¤–ä¸€ä¸ªè¡¨ç°æ˜¯åœ¨åº”è¯¥è°ƒç”¨<code>Object.notifyAll()</code> çš„åœ°æ–¹å´è°ƒç”¨äº†<code>Object.notify()</code>ã€‚æ¯”å¦‚ï¼Œå¯¹äºä½¿ç”¨åŒä¸€ä¸ªä¿æŠ¤æ¡ä»¶çš„å¤šä¸ªç­‰å¾…çº¿ç¨‹ï¼Œå¦‚æœé€šçŸ¥çº¿ç¨‹åœ¨ä¾¦æµ‹åˆ°è¿™ä¸ªä¿æŠ¤æ¡ä»¶æˆç«‹åè°ƒç”¨çš„æ˜¯<code>Object.notify()</code>ï¼Œé‚£ä¹ˆè¿™äº›ç­‰å¾…çº¿ç¨‹æœ€å¤šåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿè¢«å”¤é†’ï¼Œç”šè‡³ä¸€ä¸ªä¹Ÿæ²¡æœ‰è¢«å”¤é†’â€”â€”è¢«å”¤é†’çš„çº¿ç¨‹æ˜¯<code>Object.notify()</code>æ‰€å±å¯¹è±¡ä¸Šä½¿ç”¨å…¶ä»–ä¿æŠ¤æ¡ä»¶çš„ä¸€ä¸ªç­‰å¾…çº¿ç¨‹ï¼ä¹Ÿå°±æ˜¯è¯´ï¼Œå°½ç®¡é€šçŸ¥çº¿ç¨‹åœ¨è°ƒç”¨<code>Object.notify()</code>å‰å¯èƒ½è€ƒè™‘ï¼ˆåˆ¤æ–­ï¼‰äº†æŸä¸ªç‰¹å®šçš„ä¿æŠ¤æ¡ä»¶æ˜¯å¦æˆç«‹ï¼Œä½†æ˜¯<code>Object.notify()</code>æœ¬èº«åœ¨å…¶å”¤é†’çº¿ç¨‹æ—¶æ˜¯ä¸è€ƒè™‘ä»»ä½•ä¿æŠ¤æ¡ä»¶çš„ï¼è¿™å°±å¯èƒ½ä½¿å¾—é€šçŸ¥çº¿ç¨‹æ‰§è¡Œ<code>Object.notify()</code>è¿›è¡Œçš„é€šçŸ¥å¯¹äºä½¿ç”¨ç›¸åº”ä¿æŠ¤æ¡ä»¶çš„ç­‰å¾…çº¿ç¨‹æ¥è¯´ä¸¢å¤±äº†ã€‚è¿™ç§æƒ…å½¢ä¸‹ï¼Œé¿å…ä¿¡å·ä¸¢å¤±çš„ä¸€ä¸ªæ–¹æ³•æ˜¯åœ¨å¿…è¦çš„æ—¶å€™ä½¿ç”¨<code>Object.notifyAll()</code>æ¥é€šçŸ¥ã€‚æ€»çš„æ¥è¯´ï¼Œä¿¡å·ä¸¢å¤±æœ¬è´¨ä¸Šæ˜¯ä¸€ç§ä»£ç é”™è¯¯ï¼Œè€Œä¸æ˜¯Javaæ ‡å‡†åº“APIè‡ªèº«çš„é—®é¢˜ã€‚</p>
<p><strong>æ¬ºéª—æ€§å”¤é†’</strong></p>
<p>ç”±äºè«åå…¶å¦™çš„åŸå› ï¼Œçº¿ç¨‹æœ‰å¯èƒ½åœ¨æ²¡æœ‰è°ƒç”¨è¿‡<code>notify()</code>å’Œ<code>notifyAll()</code>çš„æƒ…å†µä¸‹é†’æ¥ã€‚è¿™å°±æ˜¯æ‰€è°“çš„å‡å”¤é†’ï¼ˆspurious wakeupsï¼‰ï¼Œæ— ç«¯ç«¯åœ°é†’è¿‡æ¥äº†ï¼Œç„¶è€Œæ­¤æ—¶å¯èƒ½ä¿æŠ¤æ¡ä»¶å¹¶æ²¡æœ‰æˆç«‹ã€‚è¿™ä¸ªé—®é¢˜çš„è§£å†³åŒæ ·æ˜¯è®² ä¿æŠ¤æ¡ä»¶å’Œwaitæ”¾åœ¨ä¸´ç•ŒåŒºå†…åŒä¸€ä¸ªå¾ªç¯ä½“å†…å°±å¯ä»¥äº†ã€‚</p>
<p><strong>ä¸Šä¸‹æ–‡åˆ‡æ¢</strong></p>
<p>â€‹    é¦–å…ˆï¼Œç­‰å¾…çº¿ç¨‹æ‰§è¡Œ<code>Object.wait()</code>è‡³å°‘ä¼šå¯¼è‡´è¯¥çº¿ç¨‹å¯¹ç›¸åº”å¯¹è±¡å†…éƒ¨é”çš„ä¸¤æ¬¡ç”³è¯·ä¸é‡Šæ”¾ã€‚é€šçŸ¥çº¿ç¨‹åœ¨æ‰§è¡Œ<code>Object.notify()/notifyAll()</code>æ—¶éœ€è¦æŒæœ‰ç›¸åº”å¯¹è±¡çš„å†…éƒ¨é”ï¼Œå› æ­¤<code>Object.notify()/notifyAll()</code>è°ƒç”¨ä¼šå¯¼è‡´ä¸€æ¬¡é”çš„ç”³è¯·ã€‚è€Œé”çš„ç”³è¯·ä¸é‡Šæ”¾å¯èƒ½å¯¼è‡´ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚</p>
<p>â€‹    å…¶æ¬¡ï¼Œç­‰å¾…çº¿ç¨‹ä»è¢«æš‚åœåˆ°å”¤é†’è¿™ä¸ªè¿‡ç¨‹æœ¬èº«å°±ä¼šå¯¼è‡´ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚</p>
<p>â€‹    å†æ¬¡ï¼Œè¢«å”¤é†’çš„ç­‰å¾…çº¿ç¨‹åœ¨ç»§ç»­è¿è¡Œæ—¶éœ€è¦å†æ¬¡ç”³è¯·ç›¸åº”å¯¹è±¡çš„å†…éƒ¨é”ï¼Œæ­¤æ—¶ç­‰å¾…çº¿ç¨‹å¯èƒ½éœ€è¦å’Œç›¸åº”å¯¹è±¡çš„å…¥å£é›†ä¸­çš„å…¶ä»–çº¿ç¨‹ä»¥åŠå…¶ä»–æ–°æ¥çš„æ´»è·ƒçº¿ç¨‹ï¼ˆå³ç”³è¯·ç›¸åº”çš„å†…éƒ¨é”ä¸”å¤„äºRUNNABLEçŠ¶æ€çš„çº¿ç¨‹ï¼‰äº‰ç”¨ç›¸åº”çš„å†…éƒ¨é”ï¼Œè€Œè¿™åˆå¯èƒ½å¯¼è‡´ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚<br>æœ€åï¼Œè¿‡æ—©å”¤é†’é—®é¢˜ä¹Ÿä¼šå¯¼è‡´é¢å¤–çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œè¿™æ˜¯å› ä¸ºè¢«è¿‡æ—©å”¤é†’çš„çº¿ç¨‹ä»ç„¶éœ€è¦ç»§ç»­ç­‰å¾…ï¼Œå³å†æ¬¡ç»å†è¢«æš‚åœå’Œå”¤é†’çš„è¿‡ç¨‹ã€‚</p>
<p><a href="http://ifeve.com/thread-signaling/" target="_blank" rel="noopener">æ›´å¤šå‚è€ƒ</a></p>
<h2 id="13-æ‰‹å†™ä¸€ä¸ªBooleanLock"><a href="#13-æ‰‹å†™ä¸€ä¸ªBooleanLock" class="headerlink" title="13.æ‰‹å†™ä¸€ä¸ªBooleanLock"></a>13.æ‰‹å†™ä¸€ä¸ªBooleanLock</h2><p><code>Synchronized</code>çš„ç¼ºç‚¹å…¶å®å¾ˆæ˜æ˜¾ï¼Œå½“å¤šä¸ªçº¿ç¨‹ç«äº‰é”çš„æ—¶å€™ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹æŠ¢åˆ°é”åå…¶ä»–çš„çº¿ç¨‹åªèƒ½å‚»å‚»çš„ç­‰ç€ï¼Œè¿™æ ·ä¼šå½±å“æ•ˆç‡ï¼Œæ‰€ä»¥è¿™é‡Œå¯ä»¥è‡ªå·±ç®€å•æ‰‹å†™ä¸€ä¸ªé™åˆ¶ç­‰å¾…æ—¶é—´çš„é”ã€‚</p>
<h3 id="LOCKæ¥å£"><a href="#LOCKæ¥å£" class="headerlink" title="LOCKæ¥å£"></a>LOCKæ¥å£</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Lock</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">TimeOutException</span> <span class="keyword">extends</span> <span class="title">Exception</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">TimeOutException</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">lock</span><span class="params">(<span class="keyword">long</span> time)</span> <span class="keyword">throws</span> InterruptedException,TimeOutException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">unLock</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Collection&lt;Thread&gt; <span class="title">getBlockThread</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®šä¹‰äº†ä¸€ä¸ª<code>TimeOutException</code></p>
<h3 id="BooleanLockå®ç°ç±»"><a href="#BooleanLockå®ç°ç±»" class="headerlink" title="BooleanLockå®ç°ç±»"></a>BooleanLockå®ç°ç±»</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BooleanLock</span> <span class="keyword">implements</span> <span class="title">Lock</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//false indicated free</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> initValue;</span><br><span class="line">    <span class="comment">//åŠ é”çš„çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">private</span> Thread lockedThread;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Collection&lt;Thread&gt; blockThreadCollection = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BooleanLock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.initValue = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (initValue) &#123;</span><br><span class="line">            blockThreadCollection.add(Thread.currentThread());</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">" is wait"</span>);</span><br><span class="line">            <span class="keyword">this</span>.wait();</span><br><span class="line">        &#125;</span><br><span class="line">        blockThreadCollection.remove(Thread.currentThread());</span><br><span class="line">        <span class="keyword">this</span>.initValue = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">this</span>.lockedThread = Thread.currentThread();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">(<span class="keyword">long</span> time)</span> <span class="keyword">throws</span> InterruptedException, TimeOutException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (time &lt;= <span class="number">0</span>) lock();</span><br><span class="line">        <span class="keyword">long</span> remainTime=time;</span><br><span class="line">        <span class="keyword">long</span> endTime=System.currentTimeMillis()+time;</span><br><span class="line">        <span class="keyword">while</span> (initValue)&#123;</span><br><span class="line">            <span class="keyword">if</span>(remainTime&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> TimeOutException(<span class="string">"time is out"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            blockThreadCollection.add(Thread.currentThread());</span><br><span class="line">            <span class="keyword">this</span>.wait(time);</span><br><span class="line">            remainTime=endTime-System.currentTimeMillis();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.initValue=<span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">this</span>.lockedThread=Thread.currentThread();</span><br><span class="line">        blockThreadCollection.remove(Thread.currentThread());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">unLock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//åˆ¤æ–­æ˜¯ä¸æ˜¯åŠ é”çš„çº¿ç¨‹</span></span><br><span class="line">        <span class="keyword">if</span> (lockedThread == Thread.currentThread()) &#123;</span><br><span class="line">            <span class="keyword">this</span>.initValue = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">this</span>.notifyAll();</span><br><span class="line">            Optional.of(Thread.currentThread().getName() + <span class="string">"  release the lock monitor"</span>).ifPresent(System.out::println);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Collection&lt;Thread&gt; <span class="title">getBlockThread</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Collections.unmodifiableCollection(blockThreadCollection);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="æµ‹è¯•BooleanLockçš„æ•ˆæœ"><a href="#æµ‹è¯•BooleanLockçš„æ•ˆæœ" class="headerlink" title="æµ‹è¯•BooleanLockçš„æ•ˆæœ"></a>æµ‹è¯•BooleanLockçš„æ•ˆæœ</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LockTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> BooleanLock booleanLock = <span class="keyword">new</span> BooleanLock();</span><br><span class="line">        Stream.of(<span class="string">"t0"</span>, <span class="string">"t1"</span>, <span class="string">"t2"</span>).forEach(name -&gt; &#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    booleanLock.lock(<span class="number">10</span>);</span><br><span class="line">                    Optional.of(Thread.currentThread().getName() + <span class="string">" get the lock"</span>).ifPresent(System.out::println);</span><br><span class="line">                    doSomething();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Lock.TimeOutException e) &#123;</span><br><span class="line">                    System.out.println(Thread.currentThread().getName()+<span class="string">" Time out"</span>);</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    booleanLock.unLock();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, name).start();</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">//mainçº¿ç¨‹é‡Šæ”¾é”ï¼Œä¸åº”è¯¥ï¼Œè°åŠ çš„é”åº”è¯¥ç”±è°å»é‡Šæ”¾é”</span></span><br><span class="line">        <span class="comment">//booleanLock.unLock();</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">doSomething</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Optional.of(Thread.currentThread().getName() + <span class="string">" is working..."</span>).ifPresent(System.out::println);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œè®¾ç½®åœ¨æŠ¢ä¸åˆ°é”çš„æ—¶å€™ï¼Œåªç­‰å¾…<code>10ms</code>ï¼Œç„¶å<code>doSomething</code>ä¼š<code>sleep</code>5000msï¼Œæ‰€ä»¥åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥æŠ¢åˆ°é”åé¢çš„éƒ½ä¼šè¶…æ—¶ throw <code>TimeOutException</code>å…¸å‹çš„<code>é™æ—¶ç­‰å¾…</code>æ¨¡å‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">t0 get the lock</span><br><span class="line">t0 is working...</span><br><span class="line">`base_thread_study.chaper10.Lock$TimeOutException: time is out`</span><br><span class="line">	at base_thread_study.chaper10.BooleanLock.lock(BooleanLock.java:<span class="number">41</span>)</span><br><span class="line">	at base_thread_study.chaper10.LockTest.lambda$<span class="keyword">null</span>$<span class="number">0</span>(LockTest.java:<span class="number">12</span>)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:<span class="number">748</span>)</span><br><span class="line">`base_thread_study.chaper10.Lock$TimeOutException: time is out`</span><br><span class="line">	at base_thread_study.chaper10.BooleanLock.lock(BooleanLock.java:<span class="number">41</span>)</span><br><span class="line">	at base_thread_study.chaper10.LockTest.lambda$<span class="keyword">null</span>$<span class="number">0</span>(LockTest.java:<span class="number">12</span>)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:<span class="number">748</span>)</span><br><span class="line">t2 Time out</span><br><span class="line">t1 Time out</span><br><span class="line">t0  release the lock monitor</span><br></pre></td></tr></table></figure>

<h2 id="14-ç»™åº”ç”¨ç¨‹åºæ³¨å…¥é’©å­Hook"><a href="#14-ç»™åº”ç”¨ç¨‹åºæ³¨å…¥é’©å­Hook" class="headerlink" title="14.ç»™åº”ç”¨ç¨‹åºæ³¨å…¥é’©å­Hook"></a>14.ç»™åº”ç”¨ç¨‹åºæ³¨å…¥é’©å­Hook</h2><p>å…³äº<code>Hook</code>æ˜¯ä»€ä¹ˆå°±ä¸å¤šä»‹ç»äº†ï¼Œè¿™é‡Œçš„é’©å­å’Œ<code>git</code>,<code>svn</code>é‡Œé¢çš„æ˜¯ä¸€æ ·çš„ï¼Œç±»ä¼¼çš„åœ¨ä½¿ç”¨<code>Tomcat</code>ç­‰æœåŠ¡çš„æ—¶å€™ï¼Œåœ¨ä½ å…³é—­å®ƒä¹‹åå®ƒä»ç„¶ä¼šæ‰“å°æ—¥å¿—å’Œé‡Šæ”¾ä¸€äº›èµ„æºï¼Œè¿™å°±æ˜¯<code>Hook</code>çš„ä¸€ç§ï¼Œå½“ç„¶<code>Hook</code>æœ‰å¤šç§ï¼Œè¿™åªæ˜¯å…¶ä¸­ä¸€ç§ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExitCap</span></span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String []arg)</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i=<span class="number">0</span>;</span><br><span class="line">	Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">   	    System.out.println(<span class="string">"The test app will shutdown"</span>);</span><br><span class="line">	    notifyAndRelease();</span><br><span class="line">	&#125;));</span><br><span class="line">	<span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">		<span class="keyword">try</span>&#123;</span><br><span class="line">		Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">		System.out.println(<span class="string">"i am working"</span>);</span><br><span class="line">		&#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">		 <span class="comment">//donothing</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(i&gt;<span class="number">10</span>)&#123;</span><br><span class="line">		   <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException();</span><br><span class="line">		&#125;</span><br><span class="line">		i++;    </span><br><span class="line">	&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">notifyAndRelease</span><span class="params">()</span></span>&#123;</span><br><span class="line">	System.out.println(<span class="string">"notify to admin"</span>);</span><br><span class="line">    	</span><br><span class="line">	<span class="keyword">try</span>&#123;</span><br><span class="line">	Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">	&#125;<span class="keyword">catch</span>(Exception e)&#123;&#125;</span><br><span class="line">	</span><br><span class="line">	System.out.println(<span class="string">"release the resources(socker. file, connection.)"</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">try</span>&#123;</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;&#125;</span><br><span class="line">	</span><br><span class="line">	System.out.println(<span class="string">"release and notify done"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œæ˜¯åœ¨<code>Linux</code>ä¸Šè¿›è¡Œçš„æµ‹è¯•ï¼Œå› ä¸ºæ•ˆæœæ¯”è¾ƒæ˜æ˜¾ï¼Œé¡ºä¾¿ä¹Ÿç†Ÿæ‚‰ä¸‹<code>Linux</code>çš„å‘½ä»¤ï¼Œå¯ä»¥çœ‹åˆ°ä¸Šé¢çš„é’©å­å°±æ˜¯é€šè¿‡<code>Runtime.getRuntime().addShutdownHook()</code>æ³¨å…¥äº†ä¸€ä¸ª<code>Thread</code>è¿›å»çš„ï¼Œè¿™æ ·å°±ä¼šæ£€æµ‹åˆ°ç¨‹åºçš„é€€å‡ºå¹¶è§¦å‘<code>Hook</code>åšä¸€äº›é‡Šæ”¾èµ„æºä¹‹ç±»çš„å·¥ä½œã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">i am working</span><br><span class="line">i am working</span><br><span class="line">i am working</span><br><span class="line">i am working</span><br><span class="line">i am working</span><br><span class="line">i am working</span><br><span class="line">i am working</span><br><span class="line">i am working</span><br><span class="line">i am working</span><br><span class="line">i am working</span><br><span class="line">i am working</span><br><span class="line">Exception in thread <span class="string">"main"</span> java.lang.RuntimeException</span><br><span class="line">	at base_thread_study.chaper10.ExitCap.main(ExitCap.java:<span class="number">18</span>)</span><br><span class="line">i am working</span><br><span class="line">`The test app will shutdown`</span><br><span class="line">`notify to admin`</span><br><span class="line">`<span class="function">release the <span class="title">resources</span><span class="params">(socker. file, connection.)</span>`</span></span><br><span class="line"><span class="function">`release and notify done`</span></span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢æ˜¯åœ¨æ­£å¸¸æƒ…å†µä¸‹ç»ˆæ­¢çº¿ç¨‹æ¯”å¦‚ <code>å¼‚å¸¸</code>ï¼Œ<code>ctrl C</code>æˆ–è€… <code>kill pid</code>å¦‚æœä½¿ç”¨ <code>kill -9 pid</code>å°±ä¸ä¼šè§¦å‘é’©å­ï¼Œå¼ºåˆ¶åœæ­¢ï¼Œæ‰€ä»¥ä¸€èˆ¬ä¸å»ºè®®ç”¨<code>kill -9</code></p>
<h2 id="15-æ•è·çº¿ç¨‹çš„Runtimeå¼‚å¸¸"><a href="#15-æ•è·çº¿ç¨‹çš„Runtimeå¼‚å¸¸" class="headerlink" title="15.æ•è·çº¿ç¨‹çš„Runtimeå¼‚å¸¸"></a>15.æ•è·çº¿ç¨‹çš„Runtimeå¼‚å¸¸</h2><p>åœ¨Javaå¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œæ‰€æœ‰çº¿ç¨‹éƒ½ä¸å…è®¸æŠ›å‡ºæœªæ•è·çš„<code>checked exception</code>(æ¯”å¦‚sleepçš„InterruptException)ï¼Œä¹Ÿå°±æ˜¯å„ä¸ªçº¿ç¨‹å¿…é¡»è‡ªå·±æŠŠè‡ªå·±çš„<code>checked exception</code>å¤„ç†æ‰ï¼Œä½†æ˜¯å¦‚æœæ˜¯<code>unchecked exception</code>å‘¢ï¼Ÿä¸»è¦å°±æ˜¯æŒ‡<code>RuntimeException</code>æ­¤ç±»å¼‚å¸¸æŠ›å‡ºæ—¶è¯¥çº¿ç¨‹ä¼š<code>shutdown</code>ä½†æ˜¯å…¶å®ƒçº¿ç¨‹ä¸å—å½±å“ä¹Ÿæ— æ³•æ„ŸçŸ¥åˆ°è¿™ä¸ªå¼‚å¸¸ï¼Œå°±åƒä¸‹é¢çš„ä¾‹å­</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadException</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Thread thread = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            thread=<span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">                <span class="keyword">int</span> res=<span class="number">1</span>/<span class="number">0</span>;</span><br><span class="line">            &#125;);</span><br><span class="line">            thread.start();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            System.out.println(<span class="string">"æ•è·åˆ°å¼‚å¸¸"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ§åˆ¶å°è¾“å‡º<code>mainçº¿ç¨‹</code>å¹¶æ²¡æœ‰æ•è·åˆ°å¼‚å¸¸ï¼Œå…¶å®è¿™ä¹Ÿæ˜¯ä¸€ç§å¾ˆå¥½çš„ç†å¿µï¼Œæ¯ä¸ªçº¿ç¨‹çš„äº‹æƒ…åº”è¯¥ç”±çº¿ç¨‹è‡ªå·±å»å¤„ç†ä¸åº”è¯¥ç”±å…¶ä»–çº¿ç¨‹å»å¹²æ‰°ï¼Œæ­£å¦‚<code>stop/resume/suspend</code>è¿™äº›æ–¹æ³•è¢«å¼ƒç”¨çš„åŸå› ã€‚ä½†æ˜¯è¿™äº›å¼‚å¸¸å¦‚æœä¸å»å¤„ç†å¯èƒ½ä¼šå¯¼è‡´ä¸€äº›ä¸¥é‡çš„åæœï¼ŒJDK1.5ä¹‹åå®˜æ–¹ä¹Ÿæä¾›äº†APIå»å¤„ç†çº¿ç¨‹çš„å¼‚å¸¸ã€‚setDefaultUncaughtExceptionHandler()å’ŒsetUncaughtExceptionHandler()å‰è€…æ˜¯<code>Thread</code>çš„é™æ€æ–¹æ³•ï¼Œç”¨äºç»™æ‰€æœ‰çš„çº¿ç¨‹è®¾ç½®é»˜è®¤çš„å¼‚å¸¸å¤„ç†ï¼Œåè€…æ˜¯å®ä¾‹æ–¹æ³•ï¼Œé’ˆå¯¹æ¯ä¸ªçº¿ç¨‹ä¼šç»™æ¯ä¸ªçº¿ç¨‹åŠ ä¸Šä¸€ä¸ªå¼‚å¸¸å¤„ç†å™¨ï¼Œå¦‚ä¸‹Demo</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadException</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> A = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> B = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Thread thread = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">              <span class="keyword">int</span> res = A / B;</span><br><span class="line">            &#125;</span><br><span class="line">        );</span><br><span class="line">        <span class="comment">//æœ€å¥½åœ¨startå‰è®¾ç½®å¼‚å¸¸å¤„ç†å™¨ï¼Œæ”¾åœ¨åé¢å¯èƒ½ä¼šèµ·ä¸åˆ°ä½œç”¨ã€‚</span></span><br><span class="line">        thread.setUncaughtExceptionHandler((t, e) -&gt; &#123;</span><br><span class="line">            System.out.println(t.getName());</span><br><span class="line">            System.out.println(e);</span><br><span class="line">        &#125;);</span><br><span class="line">        thread.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>Thread-0</code><br><code>java.lang.ArithmeticException: / by zero</code></p>
</blockquote>
<p>å¯ä»¥çœ‹åˆ°å·²ç»æ•è·åˆ°äº†è¿™ä¸ªå¼‚å¸¸ï¼Œå½“çº¿ç¨‹é‡åˆ°æœªæ•è·çš„å¼‚å¸¸è€Œç»“æŸæ—¶ä¼šè°ƒç”¨<code>UncaughtExceptionHandler</code> å¤„ç†ä¸€äº›â€åäº‹â€å’Œé‡Šæ”¾ä¸€äº›å®è´µçš„èµ„æºï¼Œ<code>setUncaughtExceptionHandler</code>å»ºè®®æ”¾åœ¨çº¿ç¨‹startä¹‹å‰ï¼Œä¸ç„¶å¯èƒ½èµ·ä¸åˆ°ä½œç”¨ã€‚</p>
<h2 id="16-ThreadGroupçº¿ç¨‹ç»„"><a href="#16-ThreadGroupçº¿ç¨‹ç»„" class="headerlink" title="16.ThreadGroupçº¿ç¨‹ç»„"></a>16.ThreadGroupçº¿ç¨‹ç»„</h2><h3 id="è·å–çº¿ç¨‹ç»„ä¿¡æ¯"><a href="#è·å–çº¿ç¨‹ç»„ä¿¡æ¯" class="headerlink" title="è·å–çº¿ç¨‹ç»„ä¿¡æ¯"></a>è·å–çº¿ç¨‹ç»„ä¿¡æ¯</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadGroupAPI</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ThreadGroup tgp = <span class="keyword">new</span> ThreadGroup(<span class="string">"TGP1"</span>);</span><br><span class="line">        Thread t = <span class="keyword">new</span> Thread(tgp, <span class="string">"t0"</span>) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        System.out.println(getThreadGroup().getName());</span><br><span class="line">                        System.out.println(getThreadGroup().getParent());</span><br><span class="line">                        <span class="comment">//å¯ä»¥è®¿é—®ï¼Œæ–‡æ¡£ä¸Šè¯´ä¸è¡Œ</span></span><br><span class="line">                        System.out.println(getThreadGroup().getParent().activeCount());</span><br><span class="line">                        Thread.sleep(<span class="number">10000</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        t.start();</span><br><span class="line"></span><br><span class="line">        ThreadGroup tgp2 = <span class="keyword">new</span> ThreadGroup(<span class="string">"TGP2"</span>);</span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(tgp2, <span class="string">"t0"</span>) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                System.out.println(tgp.getName());</span><br><span class="line">                System.out.println(tgp.activeCount());</span><br><span class="line">                Thread[] threads=<span class="keyword">new</span> Thread[tgp.activeCount()];</span><br><span class="line">                tgp.enumerate(threads);</span><br><span class="line">                <span class="comment">//ä¹Ÿå¯ä»¥è®¿é—®</span></span><br><span class="line">                Arrays.asList(threads).forEach(System.out::println);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        t1.start();</span><br><span class="line">        <span class="comment">//System.out.println(tgp2.getName());</span></span><br><span class="line">        <span class="comment">//System.out.println(tgp2.getParent().getName());</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ–‡æ¡£ä¸Šè¯´çš„ä¸èƒ½è®¿é—®å…¶ä»–çº¿ç¨‹ç»„çš„ä¿¡æ¯ï¼Œè¿™é‡Œæµ‹è¯•çš„å‡ ä¸ªéƒ½å¯ä»¥ï¼Œå¯èƒ½æè¿°æœ‰ç‚¹é—®é¢˜ï¼Œ<code>çº¿ç¨‹ç»„</code>çš„åˆ›å»ºç±»ä¼¼äº<code>çº¿ç¨‹</code>çš„åˆ›å»ºï¼Œå¦‚æœæ²¡æœ‰æ˜¾ç¤ºçš„æŒ‡å®šçº¿ç¨‹ç»„éƒ½ä¼šé»˜è®¤åŠ åˆ°çˆ¶çº¿ç¨‹çš„çº¿ç¨‹ç»„ä¸­ã€‚</p>
<h3 id="æ‰“æ–­çº¿ç¨‹ç»„interrupt"><a href="#æ‰“æ–­çº¿ç¨‹ç»„interrupt" class="headerlink" title="æ‰“æ–­çº¿ç¨‹ç»„interrupt()"></a>æ‰“æ–­çº¿ç¨‹ç»„interrupt()</h3><blockquote>
<p>Interrupts all threads in this thread group.</p>
<p>First, the <code>checkAccess</code> method of this thread group is</p>
<p>called with no arguments; this may result in a security exception.</p>
<p>This method then calls the <code>interrupt</code> method on all the</p>
<p>threads in this thread group and in <code>all of its subgroups.</code></p>
</blockquote>
<p>æ‰“æ–­è¯¥çº¿ç¨‹ç»„é‡Œé¢æ‰€æœ‰çš„çº¿ç¨‹ï¼ŒåŒ…æ‹¬å­çº¿ç¨‹ç»„çš„çº¿ç¨‹ã€‚</p>
<h3 id="çº¿ç¨‹ç»„setDaemon"><a href="#çº¿ç¨‹ç»„setDaemon" class="headerlink" title="çº¿ç¨‹ç»„setDaemon()"></a>çº¿ç¨‹ç»„setDaemon()</h3><p>å’Œçº¿ç¨‹çš„<code>setDaemon</code>ä¸ä¸€æ ·ã€‚</p>
<blockquote>
<p>Changes the daemon status of this thread group.</p>
<p>First, the <code>checkAccess</code> method of this thread group is</p>
<p>called with no arguments; this may result in a security exception.</p>
<p>A daemon thread group is <code>automatically</code> <code>destroyed</code> when its last</p>
<p>thread is stopped or its <code>last thread group is destroyed</code>.</p>
</blockquote>
<p>å½“æœ€åä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œæ¯•åè‡ªåŠ¨é”€æ¯çº¿ç¨‹ç»„ï¼Œå½“ç„¶ä¸å…¶å¯¹åº”çš„ä¹Ÿæœ‰æ‰‹åŠ¨é”€æ¯çš„æ–¹æ³•<code>destroy()</code>è¿™ä¸ªæ–¹æ³•å¦‚æœçº¿ç¨‹æ²¡æ‰§è¡Œå®Œæ¯•å°±è°ƒç”¨ä¼šæŠ›<code>IllegalThreadStateException</code>ï¼Œå…¶ä»–çš„æ–¹æ³•è¯¦ç»†å¯ä»¥å‚è€ƒæ–‡æ¡£ã€‚</p>
<h2 id="17-çº¿ç¨‹æ± "><a href="#17-çº¿ç¨‹æ± " class="headerlink" title="17.çº¿ç¨‹æ± "></a>17.çº¿ç¨‹æ± </h2><h3 id="ä¸ºä»€ä¹ˆè¦ä½¿ç”¨çº¿ç¨‹æ± "><a href="#ä¸ºä»€ä¹ˆè¦ä½¿ç”¨çº¿ç¨‹æ± " class="headerlink" title="ä¸ºä»€ä¹ˆè¦ä½¿ç”¨çº¿ç¨‹æ± "></a>ä¸ºä»€ä¹ˆè¦ä½¿ç”¨çº¿ç¨‹æ± </h3><p> åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹å¼€é”€å¤§ï¼Œåˆ©ç”¨å¥½çº¿ç¨‹æ± å¯ä»¥é¿å…cpuèŠ±è´¹ä¸å¿…è¦çš„æ—¶é—´åœ¨è¿™ä¸Šé¢ï¼Œä»è€Œä¸“æ³¨äºå…·ä½“çš„ä»»åŠ¡:)</p>
<p>åŸºæœ¬çš„çº¿ç¨‹æ± åŒ…æ‹¬ä¸‹é¢å‡ éƒ¨åˆ†ï¼š</p>
<p>â‘ ä»»åŠ¡é˜Ÿåˆ—</p>
<p>â‘¡æ‹’ç»ç­–ç•¥(æŠ›å‡ºå¼‚å¸¸ï¼Œç›´æ¥ä¸¢å¼ƒï¼Œé˜»å¡ï¼Œä¸´æ—¶é˜Ÿåˆ—)</p>
<p>â‘¢<code>init</code>(<code>min</code>)åˆå§‹å¤§å°</p>
<p>â‘£<code>active</code>ä¸­é—´å¸¸æ€å¤§å°</p>
<p>â‘¤<code>max</code>æœ€å¤§ä¸ªæ•°ï¼Œè¶…è¿‡å°±ä¼šåŠ åˆ°ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œä»»åŠ¡é˜Ÿåˆ—ä¹Ÿæ»¡å°±ä¼šæ‰§è¡Œæ‹’ç»ç­–ç•¥</p>
<blockquote>
<p>min&lt;=active&lt;=max</p>
</blockquote>
<h3 id="æ‰‹å†™çº¿ç¨‹æ± "><a href="#æ‰‹å†™çº¿ç¨‹æ± " class="headerlink" title="æ‰‹å†™çº¿ç¨‹æ± "></a>æ‰‹å†™çº¿ç¨‹æ± </h3><h4 id="ä¸´æ—¶é˜Ÿåˆ—"><a href="#ä¸´æ—¶é˜Ÿåˆ—" class="headerlink" title="ä¸´æ—¶é˜Ÿåˆ—"></a>ä¸´æ—¶é˜Ÿåˆ—</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleThreadPool</span> </span>&#123;</span><br><span class="line">    <span class="comment">//çº¿ç¨‹æ± å¤§å°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> size;</span><br><span class="line">    <span class="comment">//é»˜è®¤å¤§å°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> DEFAULT_SIZE = <span class="number">10</span>;</span><br><span class="line">	<span class="comment">//ä»»åŠ¡é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> LinkedList&lt;Runnable&gt; TASK_QUEUE = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">	<span class="comment">//çº¿ç¨‹åºå·</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">int</span> seq = <span class="number">0</span>;</span><br><span class="line">	<span class="comment">//çº¿ç¨‹ç»„</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> ThreadGroup GROUP = <span class="keyword">new</span> ThreadGroup(<span class="string">"Pool_Group"</span>);</span><br><span class="line">	<span class="comment">//çº¿ç¨‹å‰ç¼€å</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String THREAD_PREFIX = <span class="string">"SIMPLE_THREAD_POOL-"</span>;</span><br><span class="line">	<span class="comment">//çº¿ç¨‹é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> List&lt;MyThread&gt; THREAD_QUEUE = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SimpleThreadPool</span><span class="params">(<span class="keyword">int</span> size)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.size = size;</span><br><span class="line">        init();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SimpleThreadPool</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(DEFAULT_SIZE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">            createThreadQueue();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//æš´éœ²å¯¹å¤–çš„æ¥å£ï¼Œæäº¤ä»»åŠ¡é˜Ÿåˆ—</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">submit</span><span class="params">(Runnable runnable)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (TASK_QUEUE) &#123;</span><br><span class="line">            TASK_QUEUE.addLast(runnable);</span><br><span class="line">            <span class="comment">//å”¤é†’çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹</span></span><br><span class="line">            TASK_QUEUE.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createThreadQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        MyThread thread = <span class="keyword">new</span> MyThread(GROUP, THREAD_PREFIX + (seq++));</span><br><span class="line">        thread.start();</span><br><span class="line">        THREAD_QUEUE.add(thread);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">enum</span> ThreadState &#123;</span><br><span class="line">        FREE, RUNNING, BLOCKED, DEAD</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//åŒ…è£…çš„çº¿ç¨‹ç±»</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">volatile</span> ThreadState threadState = ThreadState.FREE;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> ThreadState <span class="title">getThreadState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.threadState;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MyThread</span><span class="params">(ThreadGroup group, String name)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(group, name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            OUTER:</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">this</span>.threadState != ThreadState.DEAD) &#123;</span><br><span class="line">                <span class="comment">//å½“å‰çº¿ç¨‹æ²¡æœ‰dead</span></span><br><span class="line">                Runnable runnable;</span><br><span class="line">                <span class="keyword">synchronized</span> (TASK_QUEUE) &#123;</span><br><span class="line">                    <span class="keyword">while</span> (TASK_QUEUE.isEmpty()) &#123;</span><br><span class="line">                        <span class="comment">//ä»»åŠ¡é˜Ÿåˆ—ä¸ºç©ºï¼Œå…¨å‘˜wait</span></span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="keyword">this</span>.threadState = ThreadState.BLOCKED;</span><br><span class="line">                            TASK_QUEUE.wait();</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                            System.out.println(<span class="string">"break"</span>);</span><br><span class="line">                            <span class="keyword">break</span> OUTER;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    runnable = TASK_QUEUE.removeFirst();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//è¿™é‡Œåº”è¯¥å¹¶è¡Œ</span></span><br><span class="line">                Optional.of(runnable).ifPresent(t -&gt; &#123;</span><br><span class="line">                    <span class="keyword">this</span>.threadState = ThreadState.RUNNING;</span><br><span class="line">                    t.run();</span><br><span class="line">                    <span class="keyword">this</span>.threadState = ThreadState.FREE;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.threadState = ThreadState.DEAD;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€å¼€å§‹å®ç°çš„æ—¶å€™<code>synchronized</code>çš„èŒƒå›´å¤ªå¤§ï¼Œå°†å…·ä½“çš„æ‰§è¡Œ<code>run</code>çš„è¿‡ç¨‹ä¹ŸåŒæ­¥äº†èµ·æ¥ï¼Œè¿™æ˜æ˜¾æ˜¯æœ‰é—®é¢˜çš„ï¼Œåªéœ€è¦åŒæ­¥å…±äº«å˜é‡å°±å¯ä»¥äº†ï¼ŒåŒæ­¥äº†åé¢çš„ä»£ç é‚£å°±è·Ÿå•çº¿ç¨‹ä¸€æ ·äº†ã€‚</p>
<h4 id="å…³é—­çº¿ç¨‹æ± -amp-æ‹’ç»ç­–ç•¥"><a href="#å…³é—­çº¿ç¨‹æ± -amp-æ‹’ç»ç­–ç•¥" class="headerlink" title="å…³é—­çº¿ç¨‹æ± &amp;æ‹’ç»ç­–ç•¥"></a>å…³é—­çº¿ç¨‹æ± &amp;æ‹’ç»ç­–ç•¥</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleThreadPool</span> </span>&#123;</span><br><span class="line">    <span class="comment">//çº¿ç¨‹æ± å¤§å°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> size;</span><br><span class="line">	<span class="comment">//ä»»åŠ¡é˜Ÿåˆ—å¤§å°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> queueSize;</span><br><span class="line">	<span class="comment">//é»˜è®¤çº¿ç¨‹æ± å¤§å°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> DEFAULT_SIZE = <span class="number">10</span>;</span><br><span class="line">	<span class="comment">//çº¿ç¨‹æ± ä¸­çº¿ç¨‹ç¼–å·</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">int</span> seq = <span class="number">0</span>;</span><br><span class="line">	<span class="comment">//é»˜è®¤ä»»åŠ¡é˜Ÿåˆ—çš„å¤§å°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> DEFAULT_TASK_QUEUE_SIZE = <span class="number">2000</span>;</span><br><span class="line">	<span class="comment">//çº¿ç¨‹ç»„</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> ThreadGroup GROUP = <span class="keyword">new</span> ThreadGroup(<span class="string">"Pool_Group"</span>);</span><br><span class="line">	<span class="comment">//çº¿ç¨‹åå‰ç¼€</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String THREAD_PREFIX = <span class="string">"SIMPLE_THREAD_POOL-"</span>;</span><br><span class="line">	<span class="comment">//ä»»åŠ¡é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> LinkedList&lt;Runnable&gt; TASK_QUEUE = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">	<span class="comment">//çº¿ç¨‹é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> List&lt;MyThread&gt; THREAD_QUEUE = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">	<span class="comment">//æ‹’ç»ç­–ç•¥</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DiscardPolicy discardPolicy;</span><br><span class="line">	<span class="comment">//çº¿ç¨‹æ¬¡æ˜¯å¦é”€æ¯</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> destroy = <span class="keyword">false</span>;</span><br><span class="line">	<span class="comment">//é»˜è®¤çš„æ‹’ç»ç­–ç•¥ï¼ˆæŠ›å¼‚å¸¸ï¼‰</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> DiscardPolicy DEFAULT_DISCARD_POLICY = () -&gt; &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> DiscardException(<span class="string">"Discard this Task!!!!(Default Policy)"</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SimpleThreadPool</span><span class="params">(<span class="keyword">int</span> size, <span class="keyword">int</span> queueSize, DiscardPolicy discardPolicy)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.size = size;</span><br><span class="line">        <span class="keyword">this</span>.queueSize = queueSize;</span><br><span class="line">        <span class="keyword">this</span>.discardPolicy = discardPolicy;</span><br><span class="line">        init();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SimpleThreadPool</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(DEFAULT_SIZE, DEFAULT_TASK_QUEUE_SIZE, DEFAULT_DISCARD_POLICY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">            createThreadQueue();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">submit</span><span class="params">(Runnable runnable)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (destroy) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"The Pool is shutdown , you can't submit now ! !"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">synchronized</span> (TASK_QUEUE) &#123;</span><br><span class="line">            <span class="keyword">if</span> (TASK_QUEUE.size() &gt; queueSize) &#123;</span><br><span class="line">                discardPolicy.discard();</span><br><span class="line">            &#125;</span><br><span class="line">            TASK_QUEUE.addLast(runnable);</span><br><span class="line">            <span class="comment">//å”¤é†’çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹</span></span><br><span class="line">            TASK_QUEUE.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">//åˆ¤æ–­ä»»åŠ¡é˜Ÿåˆ—æ˜¯å¦ä¸ºç©º</span></span><br><span class="line">        <span class="keyword">while</span> (!TASK_QUEUE.isEmpty()) &#123;</span><br><span class="line">            Thread.sleep(<span class="number">50</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> initVal = THREAD_QUEUE.size();</span><br><span class="line">        <span class="keyword">while</span> (initVal &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (MyThread thread : THREAD_QUEUE) &#123;</span><br><span class="line">                <span class="keyword">if</span> (thread.getThreadState() == ThreadState.BLOCKED) &#123;</span><br><span class="line">                    thread.close();</span><br><span class="line">                    thread.interrupt();</span><br><span class="line">                    initVal--;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">10</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.destroy = <span class="keyword">true</span>;</span><br><span class="line">        System.out.println(<span class="string">"My Thread pool is shutdown"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.destroy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createThreadQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        MyThread thread = <span class="keyword">new</span> MyThread(GROUP, THREAD_PREFIX + (seq++));</span><br><span class="line">        thread.start();</span><br><span class="line">        THREAD_QUEUE.add(thread);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">enum</span> ThreadState &#123;</span><br><span class="line">        FREE, RUNNING, BLOCKED, DEAD</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DiscardException</span> <span class="keyword">extends</span> <span class="title">RuntimeException</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DiscardException</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@FunctionalInterface</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DiscardPolicy</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">discard</span><span class="params">()</span> <span class="keyword">throws</span> DiscardException</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">volatile</span> ThreadState threadState = ThreadState.FREE;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> ThreadState <span class="title">getThreadState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.threadState;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MyThread</span><span class="params">(ThreadGroup group, String name)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(group, name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            OUTER:</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">this</span>.threadState != ThreadState.DEAD) &#123;</span><br><span class="line">                Runnable runnable;</span><br><span class="line">                <span class="keyword">synchronized</span> (TASK_QUEUE) &#123;</span><br><span class="line">                    <span class="keyword">while</span> (TASK_QUEUE.isEmpty()) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="keyword">this</span>.threadState = ThreadState.BLOCKED;</span><br><span class="line">                            TASK_QUEUE.wait();</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                            System.out.println(Thread.currentThread().getName() + <span class="string">" is dead"</span>);</span><br><span class="line">                            <span class="keyword">break</span> OUTER;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    runnable = TASK_QUEUE.removeFirst();</span><br><span class="line">                &#125;</span><br><span class="line">                Optional.of(runnable).ifPresent(t -&gt; &#123;</span><br><span class="line">                    <span class="keyword">this</span>.threadState = ThreadState.RUNNING;</span><br><span class="line">                    t.run();</span><br><span class="line">                    <span class="keyword">this</span>.threadState = ThreadState.FREE;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.threadState = ThreadState.DEAD;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>shutdown</code>æ–¹æ³•å®ç°</li>
</ul>
<p>â‘ å…ˆè½®è¯¢ä»»åŠ¡é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºï¼Œä¸ä¸ºç©ºå°±ä¼šè®©<code>å½“å‰çº¿ç¨‹</code>ç­‰å¾…<code>çº¿ç¨‹é˜Ÿåˆ—</code>çš„çº¿ç¨‹æ‰§è¡Œå®Œæ‰€æœ‰ä»»åŠ¡ã€‚</p>
<p>â‘¡å½“ä»»åŠ¡é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œéå†<code>çº¿ç¨‹é˜Ÿåˆ—</code>ï¼Œç„¶åæ‰“æ–­<code>BLOCK</code>çš„çº¿ç¨‹å¹¶ä¸”è®¾ç½®ä¸º<code>DEAD</code>çŠ¶æ€è·³å‡ºå¾ªç¯ï¼Œå› ä¸º<code>ä»»åŠ¡é˜Ÿåˆ—</code>ä¸ºç©º<code>çº¿ç¨‹é˜Ÿåˆ—</code>é‡Œé¢çš„çº¿ç¨‹éƒ½ä¼šåœ¨<code>TASK_QUEUE</code>ä¸Šé¢<code>BLOCK</code>ä½ï¼Œä½†æ˜¯ä¹Ÿå­˜åœ¨ç‰¹æ®Šæƒ…å†µï¼Œå¯èƒ½æŸä¸ªçº¿ç¨‹åˆšæ‹¿åˆ°æœ€åä¸€ä¸ªä»»åŠ¡ï¼Œè¿™ç§æƒ…å†µæˆ‘ä»¬å¯ä»¥ç¨å¾®ç­‰ä¸€ä¸‹ï¼Œç­‰å®ƒ<code>BLOCK</code>ï¼Œæ¯•ç«Ÿè¿™æ˜¯ä¸ª<code>lg(N)-lg(N2)</code>çš„æ–¹æ³•</p>
<p>â‘¢è®¾ç½®<code>destory</code>çŠ¶æ€ä¸ºtrueï¼Œç„¶ååœ¨<code>submit</code>çš„æ—¶å€™ä¼šæ ¹æ®è¿™ä¸ªå˜é‡æ¥åˆ¤æ–­æ˜¯å¦å·²ç»é”€æ¯ï¼Œå¦‚æœå·²ç»é”€æ¯å°±ä¼šæŠ›å‡ºä¸€ä¸ª<code>RunntimeException</code></p>
<ul>
<li><code>æ‹’ç»ç­–ç•¥</code>å®ç°</li>
</ul>
<p>è¿™é‡Œå®ç°äº†ä¸€ä¸ªÂ·é»˜è®¤çš„æ‹’ç»ç­–ç•¥ï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼Œåœ¨submitçš„æ—¶å€™åˆ¤æ–­ä»»åŠ¡é˜Ÿåˆ—æ˜¯ä¸æ˜¯æ»¡çš„ï¼Œå¦‚æœæ»¡äº†å°±ç›´æ¥æŠ›å¼‚å¸¸ï¼Œè¿™é‡Œå¦‚æœç”¨è¿™ç§æ–¹å¼æ‹’ç»ï¼Œä¸€ä½†å‡ºç°å¼‚å¸¸<code>å½“å‰çº¿ç¨‹</code>å°±ä¼š<code>ç›´æ¥ç»“æŸ</code>å¯èƒ½å°±æ— æ³•å…³é—­è¿æ¥æ± ã€‚</p>
<h4 id="è‡ªåŠ¨æ‰©å®¹-amp-é—²æ—¶å›æ”¶"><a href="#è‡ªåŠ¨æ‰©å®¹-amp-é—²æ—¶å›æ”¶" class="headerlink" title="è‡ªåŠ¨æ‰©å®¹&amp;é—²æ—¶å›æ”¶"></a>è‡ªåŠ¨æ‰©å®¹&amp;é—²æ—¶å›æ”¶</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleThreadPool</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    <span class="comment">//çº¿ç¨‹æ± å¤§å°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> size;</span><br><span class="line">    <span class="comment">//çº¿ç¨‹å¤§å°å˜åŒ–å€¼</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> min;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> active;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> max;</span><br><span class="line">    <span class="comment">//é»˜è®¤å€¼</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> MIN = <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> ACTIVE = <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> MAX = <span class="number">12</span>;</span><br><span class="line">    <span class="comment">//ä»»åŠ¡é˜Ÿåˆ—å¤§å°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> queueSize;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getMin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> min;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getActive</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> active;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getMax</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> max;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//çº¿ç¨‹æ± ä¸­çº¿ç¨‹ç¼–å·</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">int</span> seq = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//é»˜è®¤ä»»åŠ¡é˜Ÿåˆ—çš„å¤§å°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> DEFAULT_TASK_QUEUE_SIZE = <span class="number">2000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//çº¿ç¨‹ç»„</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> ThreadGroup GROUP = <span class="keyword">new</span> ThreadGroup(<span class="string">"Pool_Group"</span>);</span><br><span class="line">    <span class="comment">//çº¿ç¨‹åå‰ç¼€</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String THREAD_PREFIX = <span class="string">"SIMPLE_THREAD_POOL-"</span>;</span><br><span class="line">    <span class="comment">//ä»»åŠ¡é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> LinkedList&lt;Runnable&gt; TASK_QUEUE = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">    <span class="comment">//çº¿ç¨‹é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> List&lt;MyThread&gt; THREAD_QUEUE = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="comment">//æ‹’ç»ç­–ç•¥</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DiscardPolicy discardPolicy;</span><br><span class="line">    <span class="comment">//çº¿ç¨‹æ± æ˜¯å¦é”€æ¯</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> destroy = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">//é»˜è®¤çš„æ‹’ç»ç­–ç•¥ï¼ˆæŠ›å¼‚å¸¸ï¼‰</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> DiscardPolicy DEFAULT_DISCARD_POLICY = () -&gt; &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> DiscardException(<span class="string">"Discard this Task!!!!(Default Policy)"</span>);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SimpleThreadPool</span><span class="params">(<span class="keyword">int</span> min, <span class="keyword">int</span> active, <span class="keyword">int</span> max, <span class="keyword">int</span> queueSize, DiscardPolicy discardPolicy)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.queueSize = queueSize;</span><br><span class="line">        <span class="keyword">this</span>.discardPolicy = discardPolicy;</span><br><span class="line">        <span class="keyword">this</span>.min = min;</span><br><span class="line">        <span class="keyword">this</span>.active = active;</span><br><span class="line">        <span class="keyword">this</span>.max = max;</span><br><span class="line">        init();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SimpleThreadPool</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(MIN, ACTIVE, MAX, DEFAULT_TASK_QUEUE_SIZE, DEFAULT_DISCARD_POLICY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//çº¿ç¨‹æ± çš„çº¿ç¨‹ï¼Œç»´æŠ¤æ•´ä¸ªçº¿ç¨‹</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (!destroy) &#123;</span><br><span class="line">            System.err.printf(<span class="string">"Pool#min:%d,active:%d,max:%d,currentSize:%d,taskRemain:%d\n"</span>,</span><br><span class="line">                    <span class="keyword">this</span>.min, <span class="keyword">this</span>.active, <span class="keyword">this</span>.max, <span class="keyword">this</span>.size, TASK_QUEUE.size());</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">                <span class="keyword">if</span> (TASK_QUEUE.size() &gt; active &amp;&amp; size &lt; active) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = size; i &lt; active; i++) &#123;</span><br><span class="line">                        createThreadQueue();</span><br><span class="line">                    &#125;</span><br><span class="line">                    System.out.println(<span class="string">"increment to active success"</span>);</span><br><span class="line">                    <span class="keyword">this</span>.size = active;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (TASK_QUEUE.size() &gt; max &amp;&amp; size &lt; MAX) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = size; i &lt; max; i++) &#123;</span><br><span class="line">                        createThreadQueue();</span><br><span class="line">                    &#125;</span><br><span class="line">                    System.out.println(<span class="string">"increment to max success"</span>);</span><br><span class="line">                    <span class="keyword">this</span>.size = max;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (TASK_QUEUE.isEmpty() &amp;&amp; size &gt; active) &#123;</span><br><span class="line">                    System.out.println(<span class="string">"==================reduce================="</span>);</span><br><span class="line">                    <span class="comment">//é˜²æ­¢å¹¶å‘ä¿®æ”¹ï¼Œåœ¨shutdownçš„æ—¶å€™reduce</span></span><br><span class="line">                    <span class="keyword">synchronized</span> (THREAD_QUEUE) &#123;</span><br><span class="line">                        <span class="keyword">int</span> release = size - active;</span><br><span class="line">                        <span class="comment">//Itertorå¯ä»¥åœ¨éå†çš„è¿‡ç¨‹ä¸­remove</span></span><br><span class="line">                        <span class="keyword">for</span> (Iterator&lt;MyThread&gt; it = THREAD_QUEUE.iterator(); it.hasNext(); ) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (release &lt;= <span class="number">0</span>)</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            MyThread mt = it.next();</span><br><span class="line">                            <span class="comment">//å¦‚æœè¯¥çº¿ç¨‹åœ¨å·¥ä½œå°±ä¸è¦æ‰“æ–­å®ƒ</span></span><br><span class="line">                            <span class="keyword">if</span>(mt.getThreadState()==ThreadState.RUNNING)&#123;</span><br><span class="line">                                <span class="keyword">continue</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            mt.close();</span><br><span class="line">                            mt.interrupt();</span><br><span class="line">                            it.remove();</span><br><span class="line">                            release--;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">this</span>.size = active;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">/*    for (int i = 0; i &lt; size; i++) &#123;</span></span><br><span class="line"><span class="comment">            createThreadQueue();</span></span><br><span class="line"><span class="comment">        &#125;*/</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.min; i++) &#123;</span><br><span class="line">            createThreadQueue();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.size = min;</span><br><span class="line">        <span class="keyword">this</span>.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">submit</span><span class="params">(Runnable runnable)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (destroy) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"The Pool is shutdown , you can't submit now ! !"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">synchronized</span> (TASK_QUEUE) &#123;</span><br><span class="line">            <span class="keyword">if</span> (TASK_QUEUE.size() &gt; queueSize) &#123;</span><br><span class="line">                discardPolicy.discard();</span><br><span class="line">            &#125;</span><br><span class="line">            TASK_QUEUE.addLast(runnable);</span><br><span class="line">            <span class="comment">//å”¤é†’çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹</span></span><br><span class="line">            TASK_QUEUE.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (!TASK_QUEUE.isEmpty()) &#123;</span><br><span class="line">            Thread.sleep(<span class="number">50</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> initVal = THREAD_QUEUE.size();</span><br><span class="line">        <span class="keyword">synchronized</span> (THREAD_QUEUE) &#123;</span><br><span class="line">            <span class="keyword">while</span> (initVal &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (MyThread thread : THREAD_QUEUE) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (thread.getThreadState() == ThreadState.BLOCKED) &#123;</span><br><span class="line">                        <span class="comment">//è®¾ç½®ä¸ºDEADçŠ¶æ€</span></span><br><span class="line">                        thread.close();</span><br><span class="line">                        thread.interrupt();</span><br><span class="line">                        initVal--;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">10</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.destroy = <span class="keyword">true</span>;</span><br><span class="line">        System.out.println(<span class="string">"My Thread pool is shutdown"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.destroy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createThreadQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        MyThread thread = <span class="keyword">new</span> MyThread(GROUP, THREAD_PREFIX + (seq++));</span><br><span class="line">        thread.start();</span><br><span class="line">        THREAD_QUEUE.add(thread);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">enum</span> ThreadState &#123;</span><br><span class="line">        FREE, RUNNING, BLOCKED, DEAD</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DiscardException</span> <span class="keyword">extends</span> <span class="title">RuntimeException</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DiscardException</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@FunctionalInterface</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DiscardPolicy</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">discard</span><span class="params">()</span> <span class="keyword">throws</span> DiscardException</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">volatile</span> ThreadState threadState = ThreadState.FREE;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> ThreadState <span class="title">getThreadState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.threadState;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MyThread</span><span class="params">(ThreadGroup group, String name)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(group, name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            OUTER:</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">this</span>.threadState != ThreadState.DEAD) &#123;</span><br><span class="line">                Runnable runnable;</span><br><span class="line">                <span class="keyword">synchronized</span> (TASK_QUEUE) &#123;</span><br><span class="line">                    <span class="keyword">while</span> (TASK_QUEUE.isEmpty()) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="keyword">this</span>.threadState = ThreadState.BLOCKED;</span><br><span class="line">                            TASK_QUEUE.wait();</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                            System.out.println(Thread.currentThread().getName() + <span class="string">" is dead"</span>);</span><br><span class="line">                            <span class="keyword">break</span> OUTER;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    runnable = TASK_QUEUE.removeFirst();</span><br><span class="line">                &#125;</span><br><span class="line">                Optional.of(runnable).ifPresent(t -&gt; &#123;</span><br><span class="line">                    <span class="keyword">this</span>.threadState = ThreadState.RUNNING;</span><br><span class="line">                    t.run();</span><br><span class="line">                    <span class="keyword">this</span>.threadState = ThreadState.FREE;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.threadState = ThreadState.DEAD;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç›¸æ¯”ä¸Šé¢å›ºå®šçš„sizeè¿™ä¸ªç‰ˆæœ¬</p>
<p>â‘  å¢åŠ äº†ä¸‰ä¸ªå­—æ®µç”¨äºåŠ¨æ€çš„æ‰©å®¹ï¼Œå› ä¸ºéœ€è¦ç®¡ç†è¿™äº›çº¿ç¨‹ï¼Œæ‰€ä»¥å°†æ•´ä¸ªçº¿ç¨‹æ± ä¹Ÿç»§æ‰¿äº†<code>Thread</code>å¹¶å®ç°äº†runæ–¹æ³•ï¼Œä¸»è¦å°±æ˜¯åˆ¤æ–­<code>TASK_QUEUE.size() &gt; active &amp;&amp; size &lt; active</code>å½“å‰ä»»åŠ¡é˜Ÿåˆ—ä»»åŠ¡å¤šäº<code>active</code>å¹¶ä¸”å½“å‰çº¿ç¨‹é˜Ÿåˆ—çº¿ç¨‹æ•°å°äº<code>active</code>ï¼Œå°±å¯ä»¥æ‰©å®¹åˆ°activeï¼ŒmaxåŒç†</p>
<p>â‘¡<code>TASK_QUEUE.isEmpty() &amp;&amp; size &gt; active</code> é—²æ—¶å›æ”¶ï¼Œä»»åŠ¡é˜Ÿåˆ—æ²¡æœ‰ä»»åŠ¡ï¼Œä½†æ˜¯çº¿ç¨‹é˜Ÿåˆ—çº¿ç¨‹è¿˜å¾ˆå¤šï¼Œæµªè´¹äº†èµ„æºï¼Œæ‰€ä»¥éœ€è¦<code>reduce</code>ä¸€äº›ç©ºé—²çš„çº¿ç¨‹ã€‚è¿™é‡Œæœ‰ä¸¤ä¸ªå°ç»†èŠ‚ï¼Œ1.åœ¨reduceå’Œshutdownçš„æ—¶å€™éœ€è¦åŒæ­¥<code>çº¿ç¨‹é˜Ÿåˆ—</code>ä¸ç„¶åœ¨<code>reduce</code>çš„æ—¶å€™<code>shutdown</code>ä¼šäº§ç”Ÿ<code>å¹¶å‘ä¿®æ”¹å¼‚å¸¸</code>ï¼ˆä¸€ä¸ªåœ¨éå†ï¼Œä¸€ä¸ªåœ¨removeï¼‰ã€‚</p>
<h3 id="æµ‹è¯•çº¿ç¨‹æ± "><a href="#æµ‹è¯•çº¿ç¨‹æ± " class="headerlink" title="æµ‹è¯•çº¿ç¨‹æ± "></a>æµ‹è¯•çº¿ç¨‹æ± </h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadPoolTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        SimpleThreadPool threadPool= <span class="keyword">new</span> SimpleThreadPool();</span><br><span class="line">        IntStream.rangeClosed(<span class="number">0</span>, <span class="number">40</span>)</span><br><span class="line">                .forEach(i -&gt; &#123;</span><br><span class="line">                    threadPool.submit(() -&gt; &#123;</span><br><span class="line">                        System.out.println(<span class="string">"The task "</span> + i + <span class="string">"  runnable by thread "</span> + Thread.currentThread().getName() + <span class="string">" start"</span>);</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                            e.printStackTrace();</span><br><span class="line">                        &#125;</span><br><span class="line">                        System.out.println(<span class="string">"The task "</span> + i + <span class="string">"  runnable by thread "</span> + Thread.currentThread().getName() + <span class="string">" end"</span>);</span><br><span class="line">                    &#125;);</span><br><span class="line">                    System.out.println(<span class="string">"submit "</span> + i);</span><br><span class="line">                &#125;);</span><br><span class="line">        threadPool.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul>
<li>ã€ŠJavaå¤šçº¿ç¨‹ç¼–ç¨‹å®æˆ˜æŒ‡å—ã€‹ </li>
<li><a href="http://ifeve.com" target="_blank" rel="noopener">å¹¶å‘ç¼–ç¨‹ç½‘</a></li>
<li><a href="https://docs.oracle.com/javase/specs/jls/se8/html/jls-17.html#jls-17.2.4" target="_blank" rel="noopener">Javaè¯­è¨€è§„èŒƒ</a></li>
</ul>

    </div>

  </article>
  <div class="toc-container">
    
  <div id="toc" class="toc-article">
    <strong class="toc-title">ç›®å½•</strong>
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-çº¿ç¨‹ä¸è¿›ç¨‹åŒºåˆ«"><span class="toc-text">1.çº¿ç¨‹ä¸è¿›ç¨‹åŒºåˆ«</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-ä¸ºä»€ä¹ˆè¦ä½¿ç”¨å¤šçº¿ç¨‹ï¼Ÿå¤šçº¿ç¨‹åº”ç”¨åœºæ™¯ï¼Ÿ"><span class="toc-text">2.ä¸ºä»€ä¹ˆè¦ä½¿ç”¨å¤šçº¿ç¨‹ï¼Ÿå¤šçº¿ç¨‹åº”ç”¨åœºæ™¯ï¼Ÿ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-çº¿ç¨‹åˆ›å»ºæ–¹å¼"><span class="toc-text">3.çº¿ç¨‹åˆ›å»ºæ–¹å¼</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ç»§æ‰¿Threadç±»é‡å†™runæ–¹æ³•"><span class="toc-text">ç»§æ‰¿Threadç±»é‡å†™runæ–¹æ³•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#å®ç°Runnableæ¥å£"><span class="toc-text">å®ç°Runnableæ¥å£</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#åŒ¿åå†…éƒ¨ç±»"><span class="toc-text">åŒ¿åå†…éƒ¨ç±»</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Thread-ç±»ä¸­çš„start-å’Œ-run-æ–¹æ³•æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ"><span class="toc-text">Thread ç±»ä¸­çš„start() å’Œ run() æ–¹æ³•æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-Threadæ„é€ å‡½æ•°"><span class="toc-text">4.Threadæ„é€ å‡½æ•°</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Threadæ„é€ æ–¹æ³•çš„ä¸€äº›ç»†èŠ‚"><span class="toc-text">Threadæ„é€ æ–¹æ³•çš„ä¸€äº›ç»†èŠ‚</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-å®ˆæŠ¤çº¿ç¨‹"><span class="toc-text">5.å®ˆæŠ¤çº¿ç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#åº”ç”¨åœºæ™¯"><span class="toc-text">åº”ç”¨åœºæ™¯</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-çº¿ç¨‹çš„çŠ¶æ€"><span class="toc-text">6.çº¿ç¨‹çš„çŠ¶æ€</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-join-æ–¹æ³•"><span class="toc-text">7.join()æ–¹æ³•</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#æºç è§£æ"><span class="toc-text">æºç è§£æ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#åº”ç”¨åœºæ™¯-1"><span class="toc-text">åº”ç”¨åœºæ™¯</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-ä¼˜å…ˆçº§"><span class="toc-text">8.ä¼˜å…ˆçº§</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-Interruptæ–¹æ³•"><span class="toc-text">9.Interruptæ–¹æ³•</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#çœ‹çœ‹æºç "><span class="toc-text">çœ‹çœ‹æºç </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#å¦‚ä½•ä¼˜é›…çš„ç»“æŸçº¿ç¨‹"><span class="toc-text">å¦‚ä½•ä¼˜é›…çš„ç»“æŸçº¿ç¨‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Thread-interrupted"><span class="toc-text">Thread.interrupted()</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-Yieldæ–¹æ³•"><span class="toc-text">10.Yieldæ–¹æ³•</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-Synchronizedå…³é”®å­—"><span class="toc-text">11.Synchronizedå…³é”®å­—</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#çº¿ç¨‹å®‰å…¨é—®é¢˜"><span class="toc-text">çº¿ç¨‹å®‰å…¨é—®é¢˜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#åŒæ­¥ä»£ç å—"><span class="toc-text">åŒæ­¥ä»£ç å—</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#åŒæ­¥æ–¹æ³•"><span class="toc-text">åŒæ­¥æ–¹æ³•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#æ­»é”"><span class="toc-text">æ­»é”</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-çº¿ç¨‹é—´é€šè®¯"><span class="toc-text">12.çº¿ç¨‹é—´é€šè®¯</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹"><span class="toc-text">ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ä¸ºä»€ä¹ˆwaitå’Œnotifyå¿…é¡»åœ¨åŒæ­¥æ–¹æ³•æˆ–åŒæ­¥å—ä¸­è°ƒç”¨ï¼Ÿ"><span class="toc-text">ä¸ºä»€ä¹ˆwaitå’Œnotifyå¿…é¡»åœ¨åŒæ­¥æ–¹æ³•æˆ–åŒæ­¥å—ä¸­è°ƒç”¨ï¼Ÿ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#wait-åè¢«å”¤é†’ä¼šæ€ä¹ˆæ ·ï¼Ÿ"><span class="toc-text">wait()åè¢«å”¤é†’ä¼šæ€ä¹ˆæ ·ï¼Ÿ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#notifyå’Œä¸­æ–­çš„ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„ç°è±¡"><span class="toc-text">notifyå’Œä¸­æ–­çš„ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„ç°è±¡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#wait-å’Œsleep-çš„åŒºåˆ«"><span class="toc-text">wait()å’Œsleep()çš„åŒºåˆ«</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#çº¿ç¨‹é€šè®¯ç»¼åˆæ¡ˆä¾‹"><span class="toc-text">çº¿ç¨‹é€šè®¯ç»¼åˆæ¡ˆä¾‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#wait-notifyçš„å¼€é”€åŠé—®é¢˜"><span class="toc-text">wait()&#x2F;notifyçš„å¼€é”€åŠé—®é¢˜</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13-æ‰‹å†™ä¸€ä¸ªBooleanLock"><span class="toc-text">13.æ‰‹å†™ä¸€ä¸ªBooleanLock</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#LOCKæ¥å£"><span class="toc-text">LOCKæ¥å£</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BooleanLockå®ç°ç±»"><span class="toc-text">BooleanLockå®ç°ç±»</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#æµ‹è¯•BooleanLockçš„æ•ˆæœ"><span class="toc-text">æµ‹è¯•BooleanLockçš„æ•ˆæœ</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#14-ç»™åº”ç”¨ç¨‹åºæ³¨å…¥é’©å­Hook"><span class="toc-text">14.ç»™åº”ç”¨ç¨‹åºæ³¨å…¥é’©å­Hook</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#15-æ•è·çº¿ç¨‹çš„Runtimeå¼‚å¸¸"><span class="toc-text">15.æ•è·çº¿ç¨‹çš„Runtimeå¼‚å¸¸</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#16-ThreadGroupçº¿ç¨‹ç»„"><span class="toc-text">16.ThreadGroupçº¿ç¨‹ç»„</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#è·å–çº¿ç¨‹ç»„ä¿¡æ¯"><span class="toc-text">è·å–çº¿ç¨‹ç»„ä¿¡æ¯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#æ‰“æ–­çº¿ç¨‹ç»„interrupt"><span class="toc-text">æ‰“æ–­çº¿ç¨‹ç»„interrupt()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#çº¿ç¨‹ç»„setDaemon"><span class="toc-text">çº¿ç¨‹ç»„setDaemon()</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#17-çº¿ç¨‹æ± "><span class="toc-text">17.çº¿ç¨‹æ± </span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ä¸ºä»€ä¹ˆè¦ä½¿ç”¨çº¿ç¨‹æ± "><span class="toc-text">ä¸ºä»€ä¹ˆè¦ä½¿ç”¨çº¿ç¨‹æ± </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#æ‰‹å†™çº¿ç¨‹æ± "><span class="toc-text">æ‰‹å†™çº¿ç¨‹æ± </span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ä¸´æ—¶é˜Ÿåˆ—"><span class="toc-text">ä¸´æ—¶é˜Ÿåˆ—</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#å…³é—­çº¿ç¨‹æ± -amp-æ‹’ç»ç­–ç•¥"><span class="toc-text">å…³é—­çº¿ç¨‹æ± &amp;æ‹’ç»ç­–ç•¥</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#è‡ªåŠ¨æ‰©å®¹-amp-é—²æ—¶å›æ”¶"><span class="toc-text">è‡ªåŠ¨æ‰©å®¹&amp;é—²æ—¶å›æ”¶</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#æµ‹è¯•çº¿ç¨‹æ± "><span class="toc-text">æµ‹è¯•çº¿ç¨‹æ± </span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#å‚è€ƒèµ„æ–™"><span class="toc-text">å‚è€ƒèµ„æ–™</span></a></li></ol>
  </div>


  </div>
</div>

    <section id="comments" style="margin:10px;padding:10px;background:#fff;">
      
  <section class="disqus-comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript" target="_blank" rel="noopener">comments powered by Disqus.</a></noscript>
    </div>
  </section>

  <script>
    var disqus_shortname = 'imlgw';
    
    var disqus_url = 'http://imlgw.top/2019/04/07/java-duo-xian-cheng-xue-xi-bi-ji/';
    
    (function(){
      var dsq = document.createElement('script');
      dsq.type = 'text/javascript';
      dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>

  <script id="dsq-count-scr" src="//imlgw.disqus.com/count.js" async></script>



    </section>
<div class="copyright">
    <span>æœ¬ä½œå“é‡‡ç”¨</span>
    <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank" rel="noopener">çŸ¥è¯†å…±äº«ç½²å 4.0 å›½é™…è®¸å¯åè®®</a>
    <span>è¿›è¡Œè®¸å¯ã€‚ è½¬è½½æ—¶è¯·æ³¨æ˜åŸæ–‡é“¾æ¥ã€‚</span>
</div>


  
    <div class="post-nav">
      <div class="post-nav-item post-nav-next">
        
          <span>ã€ˆ </span>
          <a href="/2019/02/27/leetcode-lian-biao/" rel="next" title="LeetCodeé“¾è¡¨">
          LeetCodeé“¾è¡¨
          </a>
        
      </div>
  
      <div class="post-nav-item post-nav-prev">
          
          <a href="/2019/04/09/java-duo-xian-cheng-li-mian-de-she-ji-mo-shi/" rel="prev" title="Javaå¤šçº¿ç¨‹ä¹‹è®¾è®¡æ¨¡å¼">
            Javaå¤šçº¿ç¨‹ä¹‹è®¾è®¡æ¨¡å¼
          </a>
          <span>ã€‰</span>
        
      </div>
    </div>
  

    </div>

    

  </div>
  <footer class="footer text-center">
    <div id="bottom-inner">
        <a class="bottom-item" href="https://github.com/imlgw" target="_blank">GitHub</a> |
        <a class="bottom-item" href="/links">å‹æƒ…é“¾æ¥</a> |
        <a class="bottom-item" href="https://hexo.io" target="_blank">Powered by hexo</a> |
        <a class="bottom-item" href="https://imlgw.avosapps.us/" target="_blank" rel="noopener">åšå®¢è¯„è®ºç®¡ç†</a>
    </div>
    <div id="bottom-inner">
        <a class="bottom-item" href="http://beian.miit.gov.cn/publish/query/indexFirst.action" target="_blank">é„‚ICPå¤‡18011208å·</a>
    </div>
</footer>

  

<script>
  (function(window, document, undefined) {

    var timer = null;

    function returnTop() {
      cancelAnimationFrame(timer);
      timer = requestAnimationFrame(function fn() {
        var oTop = document.body.scrollTop || document.documentElement.scrollTop;
        if (oTop > 0) {
          document.body.scrollTop = document.documentElement.scrollTop = oTop - 50;
          timer = requestAnimationFrame(fn);
        } else {
          cancelAnimationFrame(timer);
        }
      });
    }

    var hearts = [];
    window.requestAnimationFrame = (function() {
      return window.requestAnimationFrame ||
        window.webkitRequestAnimationFrame ||
        window.mozRequestAnimationFrame ||
        window.oRequestAnimationFrame ||
        window.msRequestAnimationFrame ||
        function(callback) {
          setTimeout(callback, 1000 / 60);
        }
    })();
    init();

    function init() {
      css(".heart{z-index:9999;width: 10px;height: 10px;position: fixed;background: #f00;transform: rotate(45deg);-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);}.heart:after,.heart:before{content: '';width: inherit;height: inherit;background: inherit;border-radius: 50%;-webkit-border-radius: 50%;-moz-border-radius: 50%;position: absolute;}.heart:after{top: -5px;}.heart:before{left: -5px;}");
      attachEvent();
      gameloop();
      addMenuEvent();
    }

    function gameloop() {
      for (var i = 0; i < hearts.length; i++) {
        if (hearts[i].alpha <= 0) {
          document.body.removeChild(hearts[i].el);
          hearts.splice(i, 1);
          continue;
        }
        hearts[i].y--;
        hearts[i].scale += 0.004;
        hearts[i].alpha -= 0.013;
        hearts[i].el.style.cssText = "left:" + hearts[i].x + "px;top:" + hearts[i].y + "px;opacity:" + hearts[i].alpha + ";transform:scale(" + hearts[i].scale + "," + hearts[i].scale + ") rotate(45deg);background:" + hearts[i].color;
      }
      requestAnimationFrame(gameloop);
    }

    /**
     * ç»™logoè®¾ç½®ç‚¹å‡»äº‹ä»¶
     * 
     * - å›åˆ°é¡¶éƒ¨
     * - å‡ºç°çˆ±å¿ƒ
     */
    function attachEvent() {
      var old = typeof window.onclick === "function" && window.onclick;
      var logo = document.getElementById("logo");
      if (logo) {
        logo.onclick = function(event) {
          returnTop();
          old && old();
          createHeart(event);
        }
      }
      
    }

    function createHeart(event) {
      var d = document.createElement("div");
      d.className = "heart";
      hearts.push({
        el: d,
        x: event.clientX - 5,
        y: event.clientY - 5,
        scale: 1,
        alpha: 1,
        color: randomColor()
      });
      document.body.appendChild(d);
    }

    function css(css) {
      var style = document.createElement("style");
      style.type = "text/css";
      try {
        style.appendChild(document.createTextNode(css));
      } catch (ex) {
        style.styleSheet.cssText = css;
      }
      document.getElementsByTagName('head')[0].appendChild(style);
    }

    function randomColor() {
      // return "rgb(" + (~~(Math.random() * 255)) + "," + (~~(Math.random() * 255)) + "," + (~~(Math.random() * 255)) + ")";
      return "#F44336";
    }

    function addMenuEvent() {
      var menu = document.getElementById('menu-main-post');
      if (menu) {
        var toc = document.getElementById('toc');
        if (toc) {
          menu.onclick = function() {
            if (toc) {
              if (toc.style.display == 'block') {
                toc.style.display = 'none';
              } else {
                toc.style.display = 'block';
              }
            }
          };
        } else {
          menu.style.display = 'none';
        }
      }
    }

  })(window, document);
</script>

  



  

<script src="https://cdn.jsdelivr.net/npm/live2d-widget@3.x/lib/L2Dwidget.min.js"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"https://cdn.jsdelivr.net/npm/live2d-widget-model-hijiki@1.0.5/assets/hijiki.model.json"},"display":{"superSample":2,"width":160,"height":320,"position":"right","hOffset":0,"vOffset":-70},"mobile":{"show":false,"scale":0.2},"log":false});</script></body>
</html>
