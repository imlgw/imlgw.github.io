
<!DOCTYPE html>
<html lang="zh-CN">


<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#202020"/>
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>
  
  
    <meta name="keywords" content="å¤šçº¿ç¨‹,å¹¶å‘ç¼–ç¨‹," />
  

  
    <meta name="description" content="å¤§æ‚²æ— æ³ªï¼Œå¤§æ‚Ÿæ— è¨€ï¼Œå¤§ç¬‘æ— å£°ã€‚" />
  
  
  
  <link rel="icon" type="image/x-icon" href="/img/cat.ico">
  
  <title>AQSæºç è§£æï¼ˆä¸Šï¼‰ [ iM1Gw0 ]</title>
  
    <!-- stylesheets list from config.yml -->
    
      <link rel="stylesheet" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css">
    
      <link rel="stylesheet" href="/css/xoxo.css">
    
  
<meta name="generator" content="Hexo 4.2.1"><link rel="stylesheet" href="/css/prism.css" type="text/css"></head>


<body>
  <div class="nav-container">
    <nav class="home-menu pure-menu pure-menu-horizontal">
  <a class="pure-menu-heading" href="/">
    
    <span class="title" style="text-transform:none">iM1Gw0</span>
  </a>

  <ul class="pure-menu-list clearfix">
      
          
            
              <li class="pure-menu-item"><a href="/" class="pure-menu-link">é¦–é¡µ</a></li>
            
          
      
          
            
              <li class="pure-menu-item pure-menu-has-children pure-menu-allow-hover">
            
              <a href="#" id="post" class="pure-menu-link">æ–‡ç« </a>
              <ul class="pure-menu-children">
              
                  
                    <li class="pure-menu-item"><a href="/categories" style="color:#202020;" class="pure-menu-link">åˆ†ç±»</a></li>
                  
              
                  
                    <li class="pure-menu-item"><a href="/archives" style="color:#202020;" class="pure-menu-link">å½’æ¡£</a></li>
                  
              
                  
                    <li class="pure-menu-item"><a href="/tags" style="color:#202020;" class="pure-menu-link">æ ‡ç­¾</a></li>
                  
              
                  
                    <li class="pure-menu-item"><a href="/music" style="color:#202020;" class="pure-menu-link">éŸ³ä¹</a></li>
                  
              
              </ul>
            </li>
          
      
          
            
              <li class="pure-menu-item pure-menu-has-children pure-menu-allow-hover">
            
              <a href="#" id="ç®—æ³•" class="pure-menu-link">ç®—æ³•</a>
              <ul class="pure-menu-children">
              
                  
                    <li class="pure-menu-item"><a href="http://imlgw.top/2019/05/04/leetcode-shu-zu/" style="color:#202020;" class="pure-menu-link">æ•°ç»„</a></li>
                  
              
                  
                    <li class="pure-menu-item"><a href="http://imlgw.top/2019/02/27/leetcode-lian-biao/" style="color:#202020;" class="pure-menu-link">é“¾è¡¨</a></li>
                  
              
                  
                    <li class="pure-menu-item"><a href="http://imlgw.top/2019/10/01/leetcode-zhan-dui-lie/" style="color:#202020;" class="pure-menu-link">æ ˆ&amp;é˜Ÿåˆ—</a></li>
                  
              
                  
                    <li class="pure-menu-item"><a href="http://imlgw.top/2019/09/15/leetcode-cha-zhao/" style="color:#202020;" class="pure-menu-link">æŸ¥æ‰¾</a></li>
                  
              
                  
                    <li class="pure-menu-item"><a href="http://imlgw.top/2019/07/20/leetcode-hua-dong-chuang-kou/" style="color:#202020;" class="pure-menu-link">æ»‘åŠ¨çª—å£</a></li>
                  
              
                  
                    <li class="pure-menu-item"><a href="http://imlgw.top/2019/09/01/leetcode-dong-tai-gui-hua/" style="color:#202020;" class="pure-menu-link">åŠ¨æ€è§„åˆ’</a></li>
                  
              
                  
                    <li class="pure-menu-item"><a href="http://imlgw.top/2019/12/06/leetcode-er-fen-cha-zhao/" style="color:#202020;" class="pure-menu-link">äºŒåˆ†æŸ¥æ‰¾</a></li>
                  
              
                  
                    <li class="pure-menu-item"><a href="http://imlgw.top/2019/11/06/leetcode-er-cha-shu/" style="color:#202020;" class="pure-menu-link">äºŒå‰æ ‘</a></li>
                  
              
                  
                    <li class="pure-menu-item"><a href="http://imlgw.top/2019/11/29/leetcode-bei-bao-wen-ti/" style="color:#202020;" class="pure-menu-link">èƒŒåŒ…é—®é¢˜</a></li>
                  
              
                  
                    <li class="pure-menu-item"><a href="http://imlgw.top/2019/10/10/leetcode-hui-su/" style="color:#202020;" class="pure-menu-link">å›æº¯</a></li>
                  
              
                  
                    <li class="pure-menu-item"><a href="http://imlgw.top/2020/01/21/leetcode-tan-xin/" style="color:#202020;" class="pure-menu-link">è´ªå¿ƒ</a></li>
                  
              
                  
                    <li class="pure-menu-item"><a href="http://imlgw.top/2020/07/03/leetcode-wei-yun-suan/" style="color:#202020;" class="pure-menu-link">ä½è¿ç®—</a></li>
                  
              
                  
                    <li class="pure-menu-item"><a href="http://imlgw.top/2020/08/28/leetcode-dan-diao-zhan/" style="color:#202020;" class="pure-menu-link">å•è°ƒæ ˆ</a></li>
                  
              
              </ul>
            </li>
          
      
          
            
              <li class="pure-menu-item"><a href="/project" class="pure-menu-link">Github</a></li>
            
          
      
          
            
              <li class="pure-menu-item"><a href="/search" class="pure-menu-link">æœç´¢</a></li>
            
          
      
          
            
              <li class="pure-menu-item"><a href="/about" class="pure-menu-link">å…³äº</a></li>
            
          
      
  </ul>
   
</nav>

  </div>

  <div class="container" id="content-outer">
    <div class="inner" id="content-inner">
      <div class="post-container">
  <article class="post" id="post">
    <header class="post-header text-center">
      <h1 class="title">
        AQSæºç è§£æï¼ˆä¸Šï¼‰
      </h1>
      <span>
        
        <time class="time" datetime="2019-09-23T16:00:00.000Z">
        2019-09-24
      </time>
        
      </span>
      <span class="slash">/</span>
      <span class="post-meta">
      <span class="post-tags">
        <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" rel="tag">å¤šçº¿ç¨‹</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" rel="tag">å¹¶å‘ç¼–ç¨‹</a></li></ul>
      </span>
    </span>
      <span class="slash">/</span>
      <span class="read">
      <span id="busuanzi_value_page_pv"></span> ç‚¹å‡»
    </span>
      <span class="slash">/</span>
      <span class="read">é˜…è¯»è€—æ—¶ 29 åˆ†é’Ÿ</span>
    </header>

    <div class="post-content">
      <h2 id="AbstractQueuedSynchronized"><a href="#AbstractQueuedSynchronized" class="headerlink" title="AbstractQueuedSynchronized"></a>AbstractQueuedSynchronized</h2><p><code>AbstractQueuedSynchronized</code> ç®€ç§°AQSï¼Œè¿™ä¸ªç±»æ˜¯æ•´ä¸ªå¹¶å‘åŒ…çš„åŸºç¡€å·¥å…·ç±»ï¼Œ ReentrantLockã€CountDownLatchã€Semaphoreã€FutureTask ç­‰å¹¶å‘å·¥å…·ç±»åº•å±‚éƒ½æ˜¯é€šè¿‡å®ƒæ¥å®ç°çš„</p>
<p>AQSå®šä¹‰äº†ä¸¤ç§èµ„æºå…±äº«çš„æ–¹å¼ï¼š</p>
<ul>
<li>Exclusiveï¼šç‹¬å å¼ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½è·å–èµ„æºå¹¶æ‰§è¡Œï¼Œæ¯”å¦‚ReentrantLockã€‚</li>
<li>Shareï¼šå…±äº«å¼ï¼Œå¤šä¸ªçº¿ç¨‹è·å–èµ„æºï¼Œå¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶æ‰§è¡Œï¼Œæ¯”å¦‚CountDownLatchï¼ŒReentrantReadWriteLockçš„ReadLockç­‰</li>
</ul>
<h3 id="AQSç»“æ„"><a href="#AQSç»“æ„" class="headerlink" title="AQSç»“æ„"></a>AQSç»“æ„</h3><h4 id="å±æ€§"><a href="#å±æ€§" class="headerlink" title="å±æ€§"></a>å±æ€§</h4><p>ä¸»è¦çš„å°±æ˜¯è¿™ä¸‰ä¸ªvolatileä¿®é¥°çš„Nodeå¯¹è±¡ï¼Œè¿˜æœ‰ä¸€äº›å¯¹åº”çš„åç§»é‡(ç”¨äºCASçš„)</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Head of the wait queue, lazily initialized.  Except for</span></span><br><span class="line"><span class="comment"> * initialization, it is modified only via method setHead.  Note:</span></span><br><span class="line"><span class="comment"> * If head exists, its waitStatus is guaranteed not to be</span></span><br><span class="line"><span class="comment"> * CANCELLED.</span></span><br><span class="line"><span class="comment"> * å¤´èŠ‚ç‚¹ï¼Œå¯ä»¥ç†è§£ä¸ºå½“å‰æŒæœ‰é”çš„èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment"> * åœ¨åˆ†æçš„è¿‡ç¨‹ä¸­ä¸è¦å°†å®ƒç®—ä½œé˜Ÿåˆ—çš„ä¸€éƒ¨åˆ†ï¼å®ƒåªæ˜¯ä¸€ä¸ªç©ºèŠ‚ç‚¹</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Node head;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Tail of the wait queue, lazily initialized.  Modified only via</span></span><br><span class="line"><span class="comment"> * method enq to add new wait node.</span></span><br><span class="line"><span class="comment"> * å°¾èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Node tail;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The synchronization state.</span></span><br><span class="line"><span class="comment"> * åŒæ­¥çŠ¶æ€ï¼Œ0ä»£è¡¨æ²¡æœ‰è¢«å ç”¨ï¼Œ1ä»£è¡¨è¢«ä¸€ä¸ªçº¿ç¨‹å ç”¨ï¼Œ&gt;1 ä»£è¡¨è¢«åŒä¸€ä¸ªçº¿ç¨‹å¤šæ¬¡å ç”¨ï¼ˆå¯é‡å…¥ï¼‰</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> state;</span><br></pre></td></tr></table></figure>

<h4 id="NodeèŠ‚ç‚¹"><a href="#NodeèŠ‚ç‚¹" class="headerlink" title="NodeèŠ‚ç‚¹"></a>NodeèŠ‚ç‚¹</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span> </span>&#123;</span><br><span class="line">    <span class="comment">/** Marker to indicate a node is waiting in shared mode */</span></span><br><span class="line">    <span class="comment">//å…±äº«æ¨¡å¼</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> Node SHARED = <span class="keyword">new</span> Node();</span><br><span class="line">    <span class="comment">/** Marker to indicate a node is waiting in exclusive mode */</span></span><br><span class="line">    <span class="comment">//ç‹¬å æ¨¡å¼</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> Node EXCLUSIVE = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** waitStatus value to indicate thread has cancelled */</span></span><br><span class="line">    <span class="comment">//å–æ¶ˆæŠ¢é”</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CANCELLED =  <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/** waitStatus value to indicate successor's thread needs unparking */</span></span><br><span class="line">    <span class="comment">//ä»£è¡¨å½“å‰èŠ‚ç‚¹çš„åç»­èŠ‚ç‚¹éœ€è¦è¢«unparkingï¼Œä¹Ÿå°±æ˜¯è¯´åç»§èŠ‚ç‚¹çŠ¶æ€æ˜¯parking</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SIGNAL    = -<span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/** waitStatus value to indicate thread is waiting on condition */</span></span><br><span class="line">    <span class="comment">//åœ¨conditionä¸Šç­‰å¾…</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CONDITION = -<span class="number">2</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * waitStatus value to indicate the next acquireShared should</span></span><br><span class="line"><span class="comment">     * unconditionally propagate</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PROPAGATE = -<span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//ä¸Šé¢çš„é‚£äº›çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">int</span> waitStatus;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å‰é©±èŠ‚ç‚¹    </span></span><br><span class="line">    <span class="keyword">volatile</span> Node prev;</span><br><span class="line">    <span class="comment">//åç»§èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">volatile</span> Node next;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The thread that enqueued this node.  Initialized on</span></span><br><span class="line"><span class="comment">     * construction and nulled out after use.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">volatile</span> Thread thread;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Link to next node waiting on condition, or the special</span></span><br><span class="line"><span class="comment">     * value SHARED.  Because condition queues are accessed only</span></span><br><span class="line"><span class="comment">     * when holding in exclusive mode, we just need a simple</span></span><br><span class="line"><span class="comment">     * linked queue to hold nodes while they are waiting on</span></span><br><span class="line"><span class="comment">     * conditions. They are then transferred to the queue to</span></span><br><span class="line"><span class="comment">     * re-acquire. And because conditions can only be exclusive,</span></span><br><span class="line"><span class="comment">     * we save a field by using special value to indicate shared</span></span><br><span class="line"><span class="comment">     * mode.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Node nextWaiter;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns true if node is waiting in shared mode.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">isShared</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> nextWaiter == SHARED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è¿”å›å‰é©±èŠ‚ç‚¹</span></span><br><span class="line">    <span class="function"><span class="keyword">final</span> Node <span class="title">predecessor</span><span class="params">()</span> <span class="keyword">throws</span> NullPointerException </span>&#123;</span><br><span class="line">        Node p = prev;</span><br><span class="line">        <span class="keyword">if</span> (p == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> p;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Node() &#123;    <span class="comment">// Used to establish initial head or SHARED marker</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Node(Thread thread, Node mode) &#123;     <span class="comment">// Used by addWaiter</span></span><br><span class="line">        <span class="keyword">this</span>.nextWaiter = mode;</span><br><span class="line">        <span class="keyword">this</span>.thread = thread;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Node(Thread thread, <span class="keyword">int</span> waitStatus) &#123; <span class="comment">// Used by Condition</span></span><br><span class="line">        <span class="keyword">this</span>.waitStatus = waitStatus;</span><br><span class="line">        <span class="keyword">this</span>.thread = thread;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ReentrantLockåˆ†æ"><a href="#ReentrantLockåˆ†æ" class="headerlink" title="ReentrantLockåˆ†æ"></a>ReentrantLockåˆ†æ</h2><p>æˆ‘ä»¬çŸ¥é“ReentrantLockå†…éƒ¨æœ‰ä¸¤ä¸ªé”ï¼Œä¸€ä¸ªæ˜¯å…¬å¹³é”(FairSync)ğŸ”’ï¼Œä¸€ä¸ªæ˜¯éå…¬å¹³é”(NonFairSync)ğŸ”’ï¼Œè¿™ä¸¤ä¸ªé”éƒ½æ˜¯ç‹¬å é”ï¼Œä¸¤è€…å®ç°çš„å·®å¼‚å…¶å®å¹¶ä¸å¤§ï¼Œæˆ‘ä»¬å…ˆä»<code>å…¬å¹³é”</code>å¼€å§‹è¯´èµ·ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">FairSync</span> <span class="keyword">extends</span> <span class="title">Sync</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">3000897897090466540L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        acquire(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Fair version of tryAcquire.  Don't grant access unless</span></span><br><span class="line"><span class="comment">     * recursive call or no waiters or is first.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Thread current = Thread.currentThread();</span><br><span class="line">        <span class="keyword">int</span> c = getState();</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!hasQueuedPredecessors() &amp;&amp;</span><br><span class="line">                compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">                setExclusiveOwnerThread(current);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">            <span class="keyword">int</span> nextc = c + acquires;</span><br><span class="line">            <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Maximum lock count exceeded"</span>);</span><br><span class="line">            setState(nextc);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Lock"><a href="#Lock" class="headerlink" title="Lock()"></a>Lock()</h3><p>ğŸ”” <strong>è¿™é‡Œæˆ‘ä»¬ä¸ºäº†æ¨¡æ‹ŸçœŸå®çš„æƒ…å†µï¼Œæˆ‘ä»¬å‡è®¾æœ‰ä¸¤ä¸ªçº¿ç¨‹<code>Thread0</code> å’Œ<code>Thread1</code> è¿‡æ¥æ‰§è¡Œäº†<code>Lock()</code> æ–¹æ³•ï¼Œä¸”<code>Thread0</code> æ¯”<code>Thread1</code> è¦å…ˆæ‰§è¡Œã€‚</strong></p>
<p><code>Lock()</code>æ–¹æ³•ä¸­è°ƒç”¨äº†çˆ¶ç±»çš„<code>acquire(1)</code></p>
<h4 id="acquire"><a href="#acquire" class="headerlink" title="acquire()"></a>acquire()</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">acquire</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!tryAcquire(arg) &amp;&amp; acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</span><br><span class="line">        selfInterrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆå°è¯•tryAcquire(1)ï¼Œè¿™ä¸ªtryLock()åœ¨AQSä¸­æ²¡æœ‰å…·ä½“å®ç°æ˜¯äº¤ç»™å­ç±»å»å®ç°çš„ï¼Œæ‰€ä»¥è¿™é‡Œå°±ä¼šè°ƒç”¨FairSyncçš„ï¼ŒtryAquire(1)</p>
<h4 id="tryAquire"><a href="#tryAquire" class="headerlink" title="tryAquire()"></a>tryAquire()</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//è·å–å½“å‰çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">final</span> Thread current = Thread.currentThread();</span><br><span class="line">    <span class="comment">//è·å–åŒæ­¥çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">int</span> c = getState();</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>) &#123; <span class="comment">//0ä»£è¡¨è¿˜æ²¡æœ‰çº¿ç¨‹å ç”¨</span></span><br><span class="line">        <span class="comment">//åˆ¤æ–­æœ‰æ²¡æœ‰å‰é©±èŠ‚ç‚¹ï¼ˆé™¤headèŠ‚ç‚¹å¤–ï¼‰ï¼Œæ²¡æœ‰åˆ™è¿›è¡ŒCASè®¾ç½®åŒæ­¥çŠ¶æ€è·å–é”</span></span><br><span class="line">        <span class="keyword">if</span> (!hasQueuedPredecessors() &amp;&amp; compareAndSetState(<span class="number">0</span>, acquires)) &#123; </span><br><span class="line">            <span class="comment">//è®¾ç½®å½“å‰çº¿ç¨‹ä¸ºç‹¬å çº¿ç¨‹</span></span><br><span class="line">            setExclusiveOwnerThread(current);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//åˆ°è¿™é‡Œå°±è¯´æ˜å·²ç»æœ‰çº¿ç¨‹å ç”¨äº†ï¼Œæ‰€ä»¥ä¸‹é¢æ˜¯ä¸ºäº†é‡å…¥</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">        <span class="comment">//è¿™é‡Œä¸ç”¨æ‹…å¿ƒå¹¶å‘çš„é—®é¢˜ï¼Œå› ä¸ºæ˜¯ç‹¬å é”ï¼ŒåŒæ—¶åªæœ‰ä¸€ä¸ªçº¿ç¨‹ä¼šåˆ°è¾¾è¿™é‡Œ</span></span><br><span class="line">        <span class="keyword">int</span> nextc = c + acquires;</span><br><span class="line">        <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Maximum lock count exceeded"</span>);</span><br><span class="line">        setState(nextc);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="hasQueuedPredecessors"><a href="#hasQueuedPredecessors" class="headerlink" title="hasQueuedPredecessors()"></a>hasQueuedPredecessors()</h4><p>å…¬å¹³é”å’Œéå…¬å¹³é”çš„tryAcquireæ–¹æ³•åŒºåˆ«å°±åœ¨è¿™é‡Œï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯åˆ¤æ–­æœ‰æ²¡æœ‰å‰é©±èŠ‚ç‚¹(ä¸åŒ…å«å¤´èŠ‚ç‚¹headï¼Œä¹Ÿå°±æ˜¯)å­˜åœ¨ï¼Œæœ‰çš„è¯ä¸ºäº†ä¿è¯å…¬å¹³æ€§å°±æ˜¯éœ€è¦ç­‰å¾…ï¼Œè¿”å›trueã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">hasQueuedPredecessors</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// The correctness of this depends on head being initialized</span></span><br><span class="line">    <span class="comment">// before tail and on head.next being accurate if the current</span></span><br><span class="line">    <span class="comment">// thread is first in queue.</span></span><br><span class="line">    Node t = tail; <span class="comment">// Read fields in reverse initialization order</span></span><br><span class="line">    Node h = head;</span><br><span class="line">    Node s;</span><br><span class="line">    <span class="comment">// å¤´ä¸ç­‰äºå°¾ï¼Œå¹¶ä¸”é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹æ‰€æŒæœ‰çº¿ç¨‹éå½“å‰çº¿ç¨‹è¿”å›true</span></span><br><span class="line">    <span class="keyword">return</span> h != t &amp;&amp;</span><br><span class="line">        ((s = h.next) == <span class="keyword">null</span> || s.thread != Thread.currentThread());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ğŸ’¡ åˆ°è¿™é‡Œæˆ‘ä»¬åˆ†æä¸‹<code>Thread0</code> å’Œ<code>Thread1</code> çš„æ‰§è¡Œæƒ…å†µ</p>
<p>ğŸ”¸ é¦–å…ˆ<code>Thread0</code>å…ˆæ‰§è¡Œäº†<code>tryAcquire(1)</code>  æ²¡æœ‰ä»»ä½•é˜»ç¢ï¼Œæ‰§è¡ŒæˆåŠŸç›´æ¥retrurn</p>
<p>ğŸ”¸ <code>Thread1</code> æ­¤æ—¶æœ‰å¤šç§æƒ…å†µï¼š</p>
<ul>
<li><p>è¿˜æ²¡æœ‰è·å–state ï¼Œ<code>Thread0</code>æ‰§è¡Œå®Œåè·å–State==1 ï¼Œç”±äºæ˜¯ç‹¬å é”ç›´æ¥return false ï¼Œè·å–é”å¤±è´¥ã€‚</p>
</li>
<li><p> å·²ç»<code>getState()==0</code>äº†ï¼Œæ‰§è¡Œ<code>hasQueuedPredecessors</code> æ–¹æ³•ï¼Œæ³¨æ„ï¼Œæ­¤æ—¶headå’Œtailéƒ½è¿˜æ²¡æœ‰åˆå§‹åŒ–ï¼Œéƒ½è¿˜æ˜¯nullï¼ˆå®˜æ–¹çš„æ³¨é‡Šä¸­ä¹Ÿæåˆ°headå’Œtailæ˜¯ lazily initialized ï¼‰æ‰€ä»¥è¿™é‡Œä¼šç›´æ¥ return falseï¼Œç„¶åç»§ç»­æ‰§è¡ŒCASï¼Œç”±äºå‰é¢<code>Thread0</code> å·²ç»å°†stateè®¾ç½®ä¸ºäº† 1 ï¼Œæ‰€ä»¥è¿™é‡ŒCASè‚¯å®šå¤±è´¥äº†ï¼Œæœ€ç»ˆ<code>Thread1</code>çš„tryAcquireå¤±è´¥è¿”å›falseã€‚</p>
</li>
</ul>
<p>ğŸ”¸ æ—¢ç„¶<code>tryAcquire()</code> å¤±è´¥äº†ï¼Œé‚£<code>Thread1</code> å°±ä¼šè½¬å¤´ç»§ç»­æ‰§è¡Œåé¢çš„æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">acquire</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!tryAcquire(arg) &amp;&amp; acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</span><br><span class="line">        selfInterrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆæ‰§è¡Œçš„å°±æ˜¯<code>AddWaiter()</code> </p>
<h4 id="addWaiter"><a href="#addWaiter" class="headerlink" title="addWaiter()"></a>addWaiter()</h4><p>è¿™ä¸ªæ–¹æ³•çš„ä½œç”¨å°±æ˜¯å°†Threadå’ŒmodeåŒ…è£…æˆNodeç„¶åæ·»åŠ åˆ°é“¾è¡¨å°¾éƒ¨ç„¶åè¿”å›è¿™ä¸ªNode</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Node <span class="title">addWaiter</span><span class="params">(Node mode)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//å°†å½“å‰çº¿ç¨‹å’Œæ¨¡å¼å°è£…è¿›Node</span></span><br><span class="line">    Node node = <span class="keyword">new</span> Node(Thread.currentThread(), mode);</span><br><span class="line">    <span class="comment">// Try the fast path of enq; backup to full enq on failure</span></span><br><span class="line">    Node pred = tail;</span><br><span class="line">    <span class="comment">//å¦‚æœå°¾èŠ‚ç‚¹ä¸ä¸ºç©º</span></span><br><span class="line">    <span class="keyword">if</span> (pred != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//å°†nodeè¿æ¥åœ¨å½“å‰tailåé¢</span></span><br><span class="line">        node.prev = pred;</span><br><span class="line">        <span class="comment">//casè®¾ç½®å½“å‰tailä¸ºnode</span></span><br><span class="line">        <span class="keyword">if</span> (compareAndSetTail(pred, node)) &#123;</span><br><span class="line">            pred.next = node;</span><br><span class="line">            <span class="keyword">return</span> node;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å…¶å®å‰é¢çœ‹ä¼¼ä¼šæœ‰å¹¶å‘çš„é—®é¢˜å…¶å®å¹¶æ²¡æœ‰</span></span><br><span class="line">    <span class="comment">// ä¸Šé¢æŠ¢é”å¤±è´¥çš„çº¿ç¨‹ä¼šç›´æ¥è¿›å…¥enqæ–¹æ³•è‡ªæ—‹é‡æ–°è®¾ç½®ï¼Œç›´åˆ°æˆåŠŸ</span></span><br><span class="line">    enq(node);</span><br><span class="line">    <span class="keyword">return</span> node;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ğŸ’¡ æ ¹æ®å‰é¢åˆ†æheadå’Œtailéƒ½è¿˜æ²¡æœ‰åˆå§‹åŒ–éƒ½è¿˜æ˜¯nullï¼Œæ‰€ä»¥è¿™é‡Œä¼šç›´æ¥è¿›å…¥ <code>enq()</code>æ–¹æ³•</p>
<h4 id="enq"><a href="#enq" class="headerlink" title="enq()"></a>enq()</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Node <span class="title">enq</span><span class="params">(<span class="keyword">final</span> Node node)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        Node t = tail;</span><br><span class="line">        <span class="keyword">if</span> (t == <span class="keyword">null</span>) &#123; <span class="comment">// Must initialize</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndSetHead(<span class="keyword">new</span> Node()))</span><br><span class="line">                tail = head;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            node.prev = t;</span><br><span class="line">            <span class="keyword">if</span> (compareAndSetTail(t, node)) &#123;</span><br><span class="line">                t.next = node;</span><br><span class="line">                <span class="keyword">return</span> t;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ğŸ”¸ å¯ä»¥çœ‹åˆ°è¿™é‡Œæ˜¯ä¸€ä¸ªå¾ªç¯ï¼Œå› ä¸ºheadå’Œtailéƒ½è¿˜æ˜¯ç©ºçš„æ‰€ä»¥è¿™é‡Œè¿›å…¥ç¬¬ä¸€ä¸ªå¾ªç¯ï¼ŒCASè®¾ç½®ä¸€ä¸ªç©ºçš„Node()ä¸ºå¤´èŠ‚ç‚¹headï¼Œç„¶åå°†tailä¹ŸæŒ‡å‘è¿™ä¸ªheadï¼Œåˆ°è¿™é‡Œheadå’Œtailæ‰ç®—æ˜¯åˆå§‹åŒ–å®Œæˆäº†(lazily initialized )ã€‚</p>
<p>ğŸ”¸ å¾ªç¯ï¼Œè¿›å…¥elseï¼Œè¿™é‡Œå°±å°†å½“å‰nodeè¿æ¥åˆ°tailåé¢å¹¶ä¸”åˆ©ç”¨CASè‡ªæ—‹è®¾ç½®tailä¸ºå½“å‰nodeä¹Ÿå°±æ˜¯åŒ…å«<code>Thread1</code> çš„nodeï¼Œç„¶åreturn å½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹(è¿™é‡Œè¿”å›å€¼å¹¶æ²¡æœ‰ç”¨åˆ°)ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">acquire</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!tryAcquire(arg) &amp;&amp; acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</span><br><span class="line">        selfInterrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸‹ä¸€æ­¥å°±æ˜¯æ‰§è¡Œ<code>acquireQueued()</code></p>
<p>â“ <strong>ä¸ºä»€ä¹ˆä¸ç›´æ¥åœ¨æ„é€ å™¨é‡Œé¢å°±åˆå§‹åŒ–å¤´èŠ‚ç‚¹headï¼Ÿè€Œè¦é‡‡ç”¨æ‡’åŠ è½½çš„æ–¹å¼ï¼Ÿ</strong></p>
<blockquote>
<p>CLH queues need a dummy header node to get started. Butwe donâ€™t create them on <strong>construction</strong>, because it would be wasted  effort if there is <strong>never contention</strong>. Instead, the nodeis constructed and head and tail pointers are set up <strong>on first contention</strong>.</p>
</blockquote>
<p>ä»¥ä¸Šæ‘˜è‡ª<strong>Doug Lea</strong> å¤§å¸ˆçš„æ³¨é‡Šè§£é‡Šï¼Œæ ¹æ®æˆ‘ä»¬çš„ä¸Šé¢çš„åˆ†æï¼Œå…¶å®æˆ‘ä»¬ä¹Ÿçœ‹åˆ°äº†ï¼Œç¬¬ä¸€ä¸ªçº¿ç¨‹<code>Thread0</code> è¿‡æ¥çš„æ—¶å€™å¹¶æ²¡æœ‰å»åˆå§‹åŒ–headï¼Œåé¢çš„çº¿ç¨‹<code>Thread1</code>è¿‡æ¥çš„æ—¶å€™ æœ‰äº†ç«äº‰æ‰åˆå§‹åŒ–äº†è¿™ä¸ªå¤´èŠ‚ç‚¹headï¼Œå¦‚æœç›´æ¥åˆå§‹åŒ–è¿™ä¸ªheadï¼Œç„¶ååˆæ²¡æœ‰é”ç«äº‰ï¼Œè¿™ä¸ªheadèŠ‚ç‚¹å°±è¢«æµªè´¹äº†ã€‚ å¤§å¸ˆå°±æ˜¯å¤§å¸ˆï¼Œå¤ªå¼ºäº† ğŸ˜®</p>
<h4 id="acquireQueued"><a href="#acquireQueued" class="headerlink" title="acquireQueued()"></a>acquireQueued()</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">acquireQueued</span><span class="params">(<span class="keyword">final</span> Node node, <span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> failed = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">boolean</span> interrupted = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="comment">//è·å–å½“å‰èŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">final</span> Node p = node.predecessor();</span><br><span class="line">            <span class="comment">//å¦‚æœå‰ç½®èŠ‚ç‚¹æ˜¯headå°±å°è¯•å»è·å–é”</span></span><br><span class="line">            <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line">                <span class="comment">//è®¾ç½®å¤´èŠ‚ç‚¹ä¸ºå½“å‰èŠ‚ç‚¹</span></span><br><span class="line">                setHead(node);</span><br><span class="line">                p.next = <span class="keyword">null</span>; <span class="comment">// help GC</span></span><br><span class="line">                failed = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">return</span> interrupted;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp; parkAndCheckInterrupt())</span><br><span class="line">                interrupted = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">//å‘ç”Ÿå¼‚å¸¸å–æ¶ˆæŠ¢é”</span></span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ğŸ’¡ å› ä¸ºå‰ç½®èŠ‚ç‚¹æ˜¯headï¼Œæ‰€ä»¥è¿™é‡Œä½œä¸ºé˜Ÿåˆ—ç¬¬ä¸€ä¸ªå¯ä»¥å»å°è¯•è·å–é”ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œæ˜¯ä¸ªæ­»å¾ªç¯ï¼Œä¼šä¸€ç›´å°è¯•è·å–é”ï¼Œå…¶å®ç±»ä¼¼ä¸CASçš„è‡ªæ—‹ï¼Œä½†æ˜¯ç›¸æ¯”CASè‡ªæ—‹åˆæœ‰å¾ˆå¤§ä¸åŒï¼Œå®ƒå¹¶ä¸ä¼šä¸€ç›´è‡ªæ—‹ï¼Œè¯¦ç»†å¯ä»¥ç»§ç»­å¾€ä¸‹çœ‹ã€‚</p>
<p>ğŸ”¸ å‰é¢ä¼ é€’è¿‡æ¥çš„nodeå‰ç»§èŠ‚ç‚¹æ­£å¥½å°±æ˜¯headï¼Œæ‰€ä»¥æ‰§è¡ŒtryAcquire() ä½†æ˜¯ç”±äº<code>Thread0</code> è¿˜æ²¡æœ‰é‡Šæ”¾é”æ‰€ä»¥è¿™é‡Œä»ç„¶å¤±è´¥ã€‚</p>
<p>ğŸ”¸ è¿›å…¥ç¬¬äºŒä¸ªif æ‰§è¡Œ <code>shouldParkAfterFailedAcquire(p,node)</code></p>
<h4 id="shouldParkAfterFailedAcquire"><a href="#shouldParkAfterFailedAcquire" class="headerlink" title="shouldParkAfterFailedAcquire()"></a>shouldParkAfterFailedAcquire()</h4><p>çœ‹åå­—å°±çŸ¥é“æ˜¯å¹²å•¥çš„äº†ï¼Œè·å–å¤±è´¥æ˜¯å¦Parkï¼Ÿ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">shouldParkAfterFailedAcquire</span><span class="params">(Node pred, Node node)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//å‰ç½®èŠ‚ç‚¹çš„çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">int</span> ws = pred.waitStatus;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (ws == Node.SIGNAL)</span><br><span class="line">        <span class="comment">//å‰ç½®èŠ‚ç‚¹çŠ¶æ€ä¸º-1ï¼Œä»£è¡¨å½“å‰èŠ‚ç‚¹çš„åç»­èŠ‚ç‚¹éœ€è¦è¢«æŒ‚èµ·</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * This node has already set status asking a release</span></span><br><span class="line"><span class="comment">         * to signal it, so it can safely park.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (ws &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// å‰é©±èŠ‚ç‚¹ waitStatuså¤§äº0ï¼Œè¯´æ˜å‰é©±èŠ‚ç‚¹å–æ¶ˆäº†æ’é˜Ÿã€‚</span></span><br><span class="line">        <span class="comment">// è¿™é‡Œéœ€è¦çŸ¥é“è¿™ç‚¹ï¼šè¿›å…¥é˜»å¡é˜Ÿåˆ—æ’é˜Ÿçš„çº¿ç¨‹ä¼šè¢«æŒ‚èµ·ï¼Œè€Œå”¤é†’çš„æ“ä½œæ˜¯ç”±å‰é©±èŠ‚ç‚¹å®Œæˆçš„ã€‚</span></span><br><span class="line">        <span class="comment">// æ‰€ä»¥ä¸‹é¢è¿™å—ä»£ç è¯´çš„æ˜¯å°†å½“å‰èŠ‚ç‚¹çš„prevæŒ‡å‘waitStatus&lt;=0çš„èŠ‚ç‚¹ï¼Œ</span></span><br><span class="line">        <span class="comment">// ç®€å•è¯´ï¼Œå°±æ˜¯ä¸ºäº†æ‰¾ä¸ªæ­£å¸¸çš„å‰é©±èŠ‚ç‚¹ï¼Œå› ä¸ºä½ è¿˜å¾—ä¾èµ–å®ƒæ¥å”¤é†’å‘¢ï¼Œå¦‚æœå‰é©±èŠ‚ç‚¹å–æ¶ˆäº†æ’é˜Ÿï¼Œå°±æ— æ³•å”¤é†’ä½ äº†</span></span><br><span class="line">        <span class="comment">// åŒæ—¶è¿™ä¸ªæ“ä½œä¹Ÿä¼šå°†é‚£äº› ws&gt;0 çš„èŠ‚ç‚¹ç§»é™¤æ‰</span></span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            node.prev = pred = pred.prev;</span><br><span class="line">        &#125; <span class="keyword">while</span> (pred.waitStatus &gt; <span class="number">0</span>);</span><br><span class="line">        pred.next = node;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * waitStatus must be 0 or PROPAGATE.  Indicate that we</span></span><br><span class="line"><span class="comment">         * need a signal, but don't park yet.  Caller will need to</span></span><br><span class="line"><span class="comment">         * retry to make sure it cannot acquire before parking.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">//è®¾ç½®å‰é©±èŠ‚ç‚¹çŠ¶æ€ä¸º -1</span></span><br><span class="line">        compareAndSetWaitStatus(pred, ws, Node.SIGNAL);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„è¿™ä¸ªé‡Œé¢å›å‰”é™¤ä¸æ­£å¸¸çš„èŠ‚ç‚¹ï¼Œä¸ºä¸‹é¢çš„å”¤é†’æ“ä½œè€ƒè™‘</p>
<p>ğŸ’¡ åˆ†æ<code>Thread1</code>ï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹å½“å‰é˜Ÿåˆ—çš„çŠ¶æ€</p>
<p><img src="http://static.imlgw.top/blog/20190809/jOs2WA3R7lGR.png?imageslim" alt="mark"></p>
<p>ğŸ”¸ å› ä¸ºå‰é¢çš„æ“ä½œå¹¶æ²¡æœ‰å¯¹stateè¿›è¡Œæ“ä½œï¼Œæ‰€ä»¥è¿™é‡Œä¼šç›´æ¥è¿›å…¥æœ€åçš„elseï¼Œè®¾ç½®å‰é©±èŠ‚ç‚¹çš„çŠ¶æ€ä¸º <code>SIGNAL</code></p>
<p>ç„¶årenturn  falseå›åˆ°acquireQueuedçš„å†…å¾ªç¯</p>
<p>ğŸ”¸ å†æ¬¡å°è¯•è·å–é”ï¼Œ<code>Thread0</code> ä»ç„¶æ²¡æœ‰é‡Šæ”¾é”ï¼Œå¤±è´¥ï¼Œå†æ¬¡è¿›å…¥shouldParkAfterFailedAcquireï¼Œè¿™ä¸€æ¬¡ç”±äºå·²ç»å°†å‰ç»§èŠ‚ç‚¹çš„çŠ¶æ€è®¾ç½®ä¸º<code>SIGNAL</code> æ‰€ä»¥ç›´æ¥return trueï¼Œè¿›å…¥åé¢çš„ <code>parkAndCheckInterrupt()</code> æ–¹æ³•</p>
<p><strong>æ­¤æ—¶çŠ¶æ€å˜ä¸º</strong></p>
<p><img src="http://static.imlgw.top/blog/20190809/pQ5NOkN5mQTY.png?imageslim" alt="mark"></p>
<h4 id="parkAndCheckInterrupt"><a href="#parkAndCheckInterrupt" class="headerlink" title="parkAndCheckInterrupt()"></a>parkAndCheckInterrupt()</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">parkAndCheckInterrupt</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    LockSupport.park(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">return</span> Thread.interrupted();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ°è¿™é‡Œæˆ‘ä»¬çš„çº¿ç¨‹<code>Thread1</code>å°±ä¼šè¢«é˜»å¡ä½ï¼Œä¹Ÿä¸ä¼šç»§ç»­è‡ªæ—‹è·å–é”äº†ã€‚</p>
<blockquote>
<p>LockSupport.park()å®é™…ä¸Šè°ƒç”¨çš„æ˜¯Unsafeæä¾›çš„æŒ‡ä»¤å±äº<code>çº¿ç¨‹é˜»å¡åŸè¯­</code>ï¼Œå¯ä»¥ç†è§£ä¸ºäºŒå…ƒä¿¡å·é‡ï¼ˆåªæœ‰ä¸€ä¸ªpermitï¼‰ï¼Œè¿™ä¸ªæ–¹æ³•ä¹Ÿä¼šå“åº”Interrupt  <a href="https://segmentfault.com/a/1190000008420938" target="_blank" rel="noopener">å‚è€ƒ</a></p>
</blockquote>
<p>ğŸ”” <strong>å‡è®¾æ­¤æ—¶åˆæœ‰ä¸€ä¸ªçº¿ç¨‹<code>Thread2</code>è¿‡æ¥äº†ï¼Œå¹¶ä¸”<code>Thread0</code> ä¾ç„¶æ²¡æœ‰é‡Šæ”¾é”</strong></p>
<p>ğŸ”¸ tryAcquireå¤±è´¥</p>
<p>ğŸ”¸addWaiter()ï¼Œ å°†<code>Thread2</code>å’Œæ¨¡å¼åŒ…è£…æˆNodeæ·»åŠ åˆ°é˜Ÿå°¾ï¼ˆè¿™ä¸ªæ—¶å€™å°±ä¸ä¼šè¿›å…¥enqäº†ï¼Œå› ä¸ºtailæ­¤æ—¶ä¸º<code>Thread1</code>å·²ç»ä¸ä¸ºç©ºäº†ï¼‰ç„¶åè¿”å›åŒ…å«<code>Thread2</code>çš„èŠ‚ç‚¹ï¼Œé˜Ÿåˆ—çŠ¶æ€å˜ä¸ºï¼š</p>
<p><img src="http://static.imlgw.top/blog/20190809/yniIvx1sgpXa.png?imageslim" alt="mark"></p>
<p>ğŸ”¸acquireQueued()ï¼Œæ ¹æ®ä¸Šé¢çš„çŠ¶æ€å›¾ï¼Œè¿™é‡Œå‰ç½®èŠ‚ç‚¹å¹¶ä¸æ˜¯headï¼Œç›´æ¥è¿›å…¥shouldParkAfterFailedAcquire()</p>
<p>ğŸ”¸shouldParkAfterFailedAcquire()ï¼Œæ˜æ˜¾å‰é©±èŠ‚ç‚¹çŠ¶æ€å¹¶ä¸æ˜¯<code>SIGNAL</code> è€Œæ˜¯0ï¼Œæ‰€ä»¥ç›´æ¥åˆ©ç”¨CASè®¾ç½®å‰é©±èŠ‚ç‚¹ä¸º<code>SIGNAL</code>  çŠ¶æ€å˜ä¸ºï¼š</p>
<p><img src="http://static.imlgw.top/blog/20190809/R7GmOQ4V8ESm.png?imageslim" alt="mark"></p>
<p>å›åˆ° <code>acquireQueued()</code> ç»§ç»­è‡ªæ—‹</p>
<p>ğŸ”¸ å‰ç½®èŠ‚ç‚¹ä¸æ˜¯headï¼Œè°ƒç”¨shouldParkAfterFailedAcquire(NodeT1ï¼Œmode)ï¼ŒæˆåŠŸï¼Œè°ƒç”¨parkAndCheckInterrupté˜»å¡ï¼Œè‡³æ­¤ï¼Œ<code>Thread1</code>ï¼Œ<code>Thread2</code> éƒ½åœ¨è¿™é‡Œparkä½äº†ã€‚</p>
<h3 id="unLock"><a href="#unLock" class="headerlink" title="unLock()"></a>unLock()</h3><p>ğŸ”” ç»§ç»­ä¸Šé¢çš„æ¨¡æ‹Ÿï¼Œæ­¤æ—¶<code>Thread0</code>é‡Šæ”¾é” ï¼Œè°ƒç”¨<code>unlock()</code> æ–¹æ³•ï¼Œunlock()ä¼šè°ƒç”¨AQSä¸­çš„<code>release(1)</code>æ–¹æ³•</p>
<h4 id="release"><a href="#release" class="headerlink" title="release()"></a>release()</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">release</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (tryRelease(arg)) &#123;</span><br><span class="line">        <span class="comment">//è·å–å¤´èŠ‚ç‚¹</span></span><br><span class="line">        Node h = head;</span><br><span class="line">        <span class="comment">//å¤´èŠ‚ç‚¹ä¸ä¸ºç©ºï¼Œå¹¶ä¸”å¤´èŠ‚ç‚¹çš„waitStatusä¸æ˜¯0</span></span><br><span class="line">        <span class="keyword">if</span> (h != <span class="keyword">null</span> &amp;&amp; h.waitStatus != <span class="number">0</span>)</span><br><span class="line">            <span class="comment">//unparkåç»§èŠ‚ç‚¹</span></span><br><span class="line">            unparkSuccessor(h);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆæ‰§è¡Œ<code>tryRelease(1)</code> ï¼Œå’Œ<code>tryAcquire()</code> ä¸€æ ·ï¼Œè¿™ä¸ªæ–¹æ³•æœ€åæ˜¯äº¤ç»™å­ç±»å»å®ç°çš„</p>
<h4 id="tryRelease"><a href="#tryRelease" class="headerlink" title="tryRelease()"></a>tryRelease()</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryRelease</span><span class="params">(<span class="keyword">int</span> releases)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//åŒæ­¥çŠ¶æ€å‡1</span></span><br><span class="line">    <span class="keyword">int</span> c = getState() - releases;</span><br><span class="line">    <span class="keyword">if</span> (Thread.currentThread() != getExclusiveOwnerThread())</span><br><span class="line">        <span class="comment">//è§£é”çº¿ç¨‹ä¸æ˜¯å½“å‰çº¿ç¨‹ï¼Œè§£é“ƒè¿˜é¡»ç³»é“ƒäºº</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalMonitorStateException();</span><br><span class="line">    <span class="comment">//å’Œä¸Šé¢ä¸€æ ·è¿™é‡Œä¸ç”¨æ‹…å¿ƒå¹¶å‘çš„é—®é¢˜ï¼Œå› ä¸ºæ˜¯ç‹¬å é”ï¼ŒåŒæ—¶åªæœ‰ä¸€ä¸ªçº¿ç¨‹ä¼šåˆ°è¾¾è¿™é‡Œ</span></span><br><span class="line">    <span class="keyword">boolean</span> free = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">//ä¸ä¸º0åˆ™ä»£è¡¨è¢«é‡å…¥äº†ï¼Œéœ€è¦å¤šæ¬¡releaseç›´åˆ°0æ‰ä¼šé‡Šæ”¾é”</span></span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">        free = <span class="keyword">true</span>;</span><br><span class="line">        setExclusiveOwnerThread(<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    setState(c);</span><br><span class="line">    <span class="keyword">return</span> free;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>tryRelease()æˆåŠŸç»§ç»­æ‰§è¡Œåé¢çš„è¯­å¥ï¼Œçœ‹ä¸€ä¸‹å½“å‰AQSé˜Ÿåˆ—çš„çŠ¶æ€</p>
<p><img src="http://static.imlgw.top/blog/20190809/R7GmOQ4V8ESm.png?imageslim" alt="mark"></p>
<p>ğŸ”¸ å¤´èŠ‚ç‚¹head ! =null å¹¶ä¸”head.waitStateä¸æ˜¯0ï¼Œæ‰§è¡ŒunparkSuccessor().</p>
<h4 id="unparkSuccessor"><a href="#unparkSuccessor" class="headerlink" title="unparkSuccessor()"></a>unparkSuccessor()</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">unparkSuccessor</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * If status is negative (i.e., possibly needing signal) try</span></span><br><span class="line"><span class="comment">     * to clear in anticipation of signalling.  It is OK if this</span></span><br><span class="line"><span class="comment">     * fails or if status is changed by waiting thread.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">int</span> ws = node.waitStatus;</span><br><span class="line">    <span class="keyword">if</span> (ws &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="comment">//å¦‚æœå½“å‰èŠ‚ç‚¹çš„wså°äº0å°±è®¾ç½®ä¸º0ï¼Œå…è®¸å¤±è´¥</span></span><br><span class="line">        <span class="comment">//å…¶å®æ˜¯ç‹¬å é”çš„è¯è¿™é‡Œè‚¯å®šä¸ä¼šå¤±è´¥ï¼Œå› ä¸ºåªæœ‰ä¸€ä¸ªçº¿ç¨‹</span></span><br><span class="line">        <span class="comment">//releaseæ‰§è¡Œå®Œä¹‹åï¼Œè¿™ä¸ªèŠ‚ç‚¹å°±ä¼šè¢«ç§»é™¤æ‰ã€‚ç„¶åè¢«GC</span></span><br><span class="line">        compareAndSetWaitStatus(node, ws, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Thread to unpark is held in successor, which is normally</span></span><br><span class="line"><span class="comment">     * just the next node.  But if cancelled or apparently null,</span></span><br><span class="line"><span class="comment">     * traverse backwards from tail to find the actual</span></span><br><span class="line"><span class="comment">     * non-cancelled successor.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">//è·å–åç»§èŠ‚ç‚¹</span></span><br><span class="line">    Node s = node.next;</span><br><span class="line">    <span class="comment">//åç»§èŠ‚ç‚¹ä¸ºç©ºï¼Œæˆ–è€…å·²ç»æ’¤é”€äº†ï¼Œå–æ¶ˆæŠ¢é”ï¼ˆ1&gt;0ï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> (s == <span class="keyword">null</span> || s.waitStatus &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        s = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">//ä»åå¾€å‰éå†æ‰¾åˆ°æ­£æ•°ç¬¬ä¸€ä¸ªwaitStatus&lt;0çš„</span></span><br><span class="line">        <span class="keyword">for</span> (Node t = tail; t != <span class="keyword">null</span> &amp;&amp; t != node; t = t.prev)</span><br><span class="line">            <span class="keyword">if</span> (t.waitStatus &lt;= <span class="number">0</span>)</span><br><span class="line">                s = t;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="keyword">null</span>)</span><br><span class="line">        <span class="comment">//ç„¶åé‡Šæ”¾å®ƒ</span></span><br><span class="line">        LockSupport.unpark(s.thread);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ğŸ”¸ <code>Thread1</code> è¢«<code>unpark()</code> ç»§ç»­æ‰§è¡Œã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">parkAndCheckInterrupt</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    LockSupport.park(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">return</span> Thread.interrupted();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿”å›<code>Thread1</code>çš„ ä¸­æ–­æ ‡å¿—ä½ï¼Œå¹¶å¤åŸä¸ºfalseï¼Œç»“æŸ<code>parkAndCheckInterrupt()</code>æ–¹æ³•ï¼Œå†æ¬¡å›åˆ°<code>acquireQueued()</code> çš„å¾ªç¯ä¸­æ‰§è¡Œç¬¬ä¸€ä¸ªif</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (;;) &#123;</span><br><span class="line">    <span class="keyword">final</span> Node p = node.predecessor();</span><br><span class="line">    <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line">        setHead(node);</span><br><span class="line">        p.next = <span class="keyword">null</span>; <span class="comment">// help GC</span></span><br><span class="line">        failed = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">return</span> interrupted; <span class="comment">//è¿”å›ä¸­æ–­çŠ¶æ€</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp; parkAndCheckInterrupt())</span><br><span class="line">        interrupted = <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ğŸ”¸ ç”±äº<code>Thread0</code> å·²ç»é‡Šæ”¾é”ï¼ŒåŒæ­¥çŠ¶æ€å·²ç»å˜ä¸º0ï¼Œ<code>Thread1</code> å¯ä»¥ç›´æ¥<code>tryAcquire</code>è·å–åˆ°é”ï¼Œç„¶åè®¾ç½®å¤´èŠ‚ç‚¹ä¸ºå½“å‰èŠ‚ç‚¹ï¼Œå°†ä¹‹å‰çš„headèŠ‚ç‚¹<strong>ç§»é™¤</strong>ï¼Œè¿”å›ä¸­æ–­çŠ¶æ€ï¼Œç”±äºä¹‹å‰parkæœŸé—´æ²¡æœ‰è¢«ä¸­æ–­ç›´æ¥<code>return false</code>ï¼ŒacquireæˆåŠŸï¼ï¼ï¼ <code>Thread1</code> è·å¾—é”ï¼ï¼ï¼</p>
<p>â“ <strong>ä¸ºä»€ä¹ˆè¦ä»åå¾€å‰éå†ï¼Ÿ</strong></p>
<blockquote>
<p>è¿™é‡Œçœ‹äº†ä¸€äº›åšå®¢ä»‹ç»ï¼Œå¤§æ¦‚æœ‰ä¸¤ä¸ªè¯´æ³•ï¼Œä¸€ä¸ªæ˜¯åœ¨<code>enq()</code> æ–¹æ³•é‡Œé¢ï¼Œå…ˆè®¾ç½®çš„<code>node.prev = pred;</code>å†æ‰§è¡Œçš„CASæœ€åæ‰§è¡Œçš„<code>t.next = node;</code> CASæˆåŠŸånextä¹Ÿè®¸è¿˜æ²¡æœ‰è®¾ç½®æˆåŠŸï¼Œä»å‰å¾€åéå†æœ‰å¯èƒ½æ‰¾ä¸åˆ°è¿™ä¸ªåˆšåŠ å…¥çš„èŠ‚ç‚¹ï¼›å…¶æ¬¡ï¼Œåœ¨<code>cancelAcquire(node);</code> çš„æœ€åä¸€æ­¥æœ‰ä¸€ä¸ª<code>node.next=node</code>çš„æ“ä½œï¼Œå¦‚æœè¿™ä¸ªæ—¶å€™ä»å‰å¾€åéå†ä¼šå¯¼è‡´æ­»å¾ªç¯ã€‚</p>
</blockquote>
<p>â“ <strong>ä»åå¾€å‰éå†æ‰¾åˆ°æœ€å‰é¢ç¬¬ä¸€ä¸ªwaitStatus&lt;0çš„èŠ‚ç‚¹ï¼Œè¿™ä¸ªæ“ä½œå¦‚æœè¿”å›çš„æ˜¯ä¸ªä¸­é—´èŠ‚ç‚¹æ€ä¹ˆåŠï¼Ÿ</strong></p>
<blockquote>
<p>ä¸è¦æ€•ï¼Œæˆ‘ä»¬ç»§ç»­æ‰§è¡Œï¼Œé¦–å…ˆå®ƒæ˜¯ä¸ªä¸­é—´èŠ‚ç‚¹è€Œä¸”æ˜¯å…¬å¹³é”ï¼Œå®ƒæœ‰å‰é©±èŠ‚ç‚¹ï¼Œunparkåè‚¯å®šè·å–ä¸åˆ°é”(å…¬å¹³é”éœ€è¦æ£€æµ‹æ˜¯å¦æœ‰å‰é©±èŠ‚ç‚¹)ï¼Œç„¶åæ‰§è¡Œ<code>shouldParkAfterFailedAcquire()</code>ï¼Œè¿˜è®°å¾—è¿™ä¸ªæ–¹æ³•é‡Œé¢çš„ä¸€ä¸ªæ“ä½œä¹ˆï¼Ÿï¼Ÿå¦‚æœå‰é©±èŠ‚ç‚¹çŠ¶æ€&gt;0ï¼Œä»–å°±ä¼šæ¸…é™¤è¿™äº›ä¸æ­£å¸¸çš„èŠ‚ç‚¹ï¼Œè¿”å›falseï¼Œä¸parkè‡ªæ—‹ï¼Œä¸‹ä¸€æ¬¡å¾ªç¯è¿™ä¸ªèŠ‚ç‚¹åœ¨è·å–é”å°±å¯ä»¥è·å–åˆ°äº†ï¼Œå¦™å“‰ï¼ï¼ï¼</p>
</blockquote>
<p>æ³¨æ„<strong>setHead</strong>æ˜¯è¿™æ ·çš„</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setHead</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">    head = node;</span><br><span class="line">    node.thread = <span class="keyword">null</span>; <span class="comment">//è®¾ç½®çº¿ç¨‹ä¸ºnull</span></span><br><span class="line">    node.prev = <span class="keyword">null</span>; <span class="comment">//è®¾ç½®å‰é©±ä¸ºç©º</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶é˜Ÿåˆ—çŠ¶æ€å˜ä¸ºï¼š</p>
<p><img src="http://static.imlgw.top/blog/20190809/wFDlbQTu417I.png?imageslim" alt="mark"></p>
<p>å†å¾€åå°±æ˜¯é‡å¤å‰é¢çš„è¿‡ç¨‹å•¦ã€‚</p>
<h3 id="éå…¬å¹³é”å…¬å¹³é”åŒºåˆ«"><a href="#éå…¬å¹³é”å…¬å¹³é”åŒºåˆ«" class="headerlink" title="éå…¬å¹³é”å…¬å¹³é”åŒºåˆ«"></a>éå…¬å¹³é”å…¬å¹³é”åŒºåˆ«</h3><p>ä¸Šé¢æ˜¯ä»‹ç»çš„å…¬å¹³é”ï¼Œæ‰€è°“çš„å…¬å¹³å°±æ˜¯å…ˆæ¥ååˆ°FIFOã€‚</p>
<p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹éå…¬å¹³é”çš„lockå’ŒnonfairTryAcquire()çš„å®ç°ï¼Œè¿™ä¸¤ä¸ªé”çš„åŒºåˆ«å…¶å®å°±æ˜¯è¿™ä¸¤ä¸ªæ–¹æ³•ã€‚</p>
<h4 id="lock"><a href="#lock" class="headerlink" title="lock()"></a>lock()</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>))</span><br><span class="line">        setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        acquire(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°éå…¬å¹³é”<code>lock()</code>çš„æ—¶å€™ï¼Œä¸ç®¡ä¸‰ä¸ƒäºŒåä¸€å…ˆCASè¯•ä¸€ä¸‹èƒ½ä¸èƒ½è·å–åˆ°é”ï¼Œè·å–åˆ°å°±ç›´æ¥è¿”å›</p>
<h4 id="nonfairTryAcquire"><a href="#nonfairTryAcquire" class="headerlink" title="nonfairTryAcquire()"></a>nonfairTryAcquire()</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">nonfairTryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Thread current = Thread.currentThread();</span><br><span class="line">    <span class="keyword">int</span> c = getState();</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">            setExclusiveOwnerThread(current);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">        <span class="keyword">int</span> nextc = c + acquires;</span><br><span class="line">        <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>) <span class="comment">// overflow</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Maximum lock count exceeded"</span>);</span><br><span class="line">        setState(nextc);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯¹æ¯”å…¬å¹³é”çš„å®ç°ï¼Œä¼šå‘ç°å°‘äº†<code>hasQueuedPredecessors()</code> è¿™ä¸ªæ–¹æ³•ï¼Œæ‰€ä»¥å¦‚æœå‰é¢<code>lock()</code> çš„æ—¶å€™æ²¡æœ‰CASæˆåŠŸï¼Œåˆ°è¿™é‡Œåå¦‚æœä¹‹å‰æŒæœ‰é”çš„çº¿ç¨‹é‡Šæ”¾äº†é”ï¼Œå®ƒåˆä¼šå†æ¬¡å°è¯•CASè·å–é”ï¼Œè¿™é‡Œå…¶å®å°±ä½“ç°äº†éå…¬å¹³é”çš„ç‰¹ç‚¹ï¼Œ**å…ˆç­‰å¾…é”çš„çº¿ç¨‹ä¸ä¸€å®šèƒ½å…ˆè·å–åˆ°é”ï¼Œä¸­é—´å…è®¸æœ‰äºº<code>&quot;æ’é˜Ÿ&quot;</code>**ï¼Œå¦‚æœè¿™ä¸€æ¬¡è¿˜æ˜¯å¤±è´¥äº†ï¼Œå°±ä¼šå’Œå…¬å¹³é”ä¸€æ ·è€è€å®å®å»ç­‰å¾…é˜Ÿåˆ—ä¸­æ’é˜Ÿ</p>
<p>ä¸€èˆ¬è€Œè¨€ï¼Œéå…¬å¹³é”çš„æ€§èƒ½ä¼šæ¯”å…¬å¹³é”å¥½ï¼Œè€Œéå…¬å¹³é”å¯èƒ½ä¼šå¯¼è‡´æ’åœ¨åé¢çš„çº¿ç¨‹é¥¥é¥¿</p>
<h3 id="æµç¨‹å›¾"><a href="#æµç¨‹å›¾" class="headerlink" title="æµç¨‹å›¾"></a>æµç¨‹å›¾</h3><p><img src="http://static.imlgw.top/blog/20190810/6FEWGydOmVzm.png?imageslim" alt="mark"></p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><strong>ã€ŠJavaå¹¶å‘ç¼–ç¨‹ä¹‹ç¾ã€‹</strong></p>
<p><a href="https://javadoop.com/2017/06/16/AbstractQueuedSynchronizer/" target="_blank" rel="noopener">ä¸€è¡Œä¸€è¡Œæºç åˆ†ææ¸…æ¥šAbstractQueuedSynchronizer</a></p>
<p><a href="https://blog.csdn.net/pfnie/article/details/53191892" target="_blank" rel="noopener">AbstractQueuedSynchronizeræºç å‰–æï¼ˆå…­ï¼‰- æ·±åˆ»è§£æä¸æ¨¡æ‹Ÿçº¿ç¨‹ç«äº‰èµ„æº</a></p>
<p><a href="https://segmentfault.com/a/1190000008420938" target="_blank" rel="noopener">[æµ…è°ˆJavaå¹¶å‘ç¼–ç¨‹ç³»åˆ—ï¼ˆå…«ï¼‰â€”â€” LockSupportåŸç†å‰–æ]</a></p>
<p><a href="https://brightloong.github.io/2018/06/21/Java%E5%90%8C%E6%AD%A5%E5%99%A8%E2%80%94%E2%80%94AQS%E5%AD%A6%E4%B9%A0/" target="_blank" rel="noopener">JavaåŒæ­¥å™¨â€”â€”AQSå­¦ä¹ </a></p>

    </div>

  </article>
  <div class="toc-container">
    
  <div id="toc" class="toc-article">
    <strong class="toc-title">ç›®å½•</strong>
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#AbstractQueuedSynchronized"><span class="toc-text">AbstractQueuedSynchronized</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#AQSç»“æ„"><span class="toc-text">AQSç»“æ„</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#å±æ€§"><span class="toc-text">å±æ€§</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#NodeèŠ‚ç‚¹"><span class="toc-text">NodeèŠ‚ç‚¹</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ReentrantLockåˆ†æ"><span class="toc-text">ReentrantLockåˆ†æ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Lock"><span class="toc-text">Lock()</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#acquire"><span class="toc-text">acquire()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#tryAquire"><span class="toc-text">tryAquire()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#hasQueuedPredecessors"><span class="toc-text">hasQueuedPredecessors()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#addWaiter"><span class="toc-text">addWaiter()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#enq"><span class="toc-text">enq()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#acquireQueued"><span class="toc-text">acquireQueued()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#shouldParkAfterFailedAcquire"><span class="toc-text">shouldParkAfterFailedAcquire()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#parkAndCheckInterrupt"><span class="toc-text">parkAndCheckInterrupt()</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#unLock"><span class="toc-text">unLock()</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#release"><span class="toc-text">release()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#tryRelease"><span class="toc-text">tryRelease()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#unparkSuccessor"><span class="toc-text">unparkSuccessor()</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#éå…¬å¹³é”å…¬å¹³é”åŒºåˆ«"><span class="toc-text">éå…¬å¹³é”å…¬å¹³é”åŒºåˆ«</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#lock"><span class="toc-text">lock()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#nonfairTryAcquire"><span class="toc-text">nonfairTryAcquire()</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#æµç¨‹å›¾"><span class="toc-text">æµç¨‹å›¾</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#å‚è€ƒ"><span class="toc-text">å‚è€ƒ</span></a></li></ol>
  </div>


  </div>
</div>

    <section id="comments" style="margin:10px;padding:10px;background:#fff;">
      
  <section class="disqus-comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript" target="_blank" rel="noopener">comments powered by Disqus.</a></noscript>
    </div>
  </section>

  <script>
    var disqus_shortname = 'imlgw';
    
    var disqus_url = 'http://imlgw.top/2019/09/24/abstractqueuedsynchronizer/';
    
    (function(){
      var dsq = document.createElement('script');
      dsq.type = 'text/javascript';
      dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>

  <script id="dsq-count-scr" src="//imlgw.disqus.com/count.js" async></script>



    </section>
<div class="copyright">
    <span>æœ¬ä½œå“é‡‡ç”¨</span>
    <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank" rel="noopener">çŸ¥è¯†å…±äº«ç½²å 4.0 å›½é™…è®¸å¯åè®®</a>
    <span>è¿›è¡Œè®¸å¯ã€‚ è½¬è½½æ—¶è¯·æ³¨æ˜åŸæ–‡é“¾æ¥ã€‚</span>
</div>


  
    <div class="post-nav">
      <div class="post-nav-item post-nav-next">
        
          <span>ã€ˆ </span>
          <a href="/2019/09/15/leetcode-cha-zhao/" rel="next" title="LeetCodeæŸ¥æ‰¾">
          LeetCodeæŸ¥æ‰¾
          </a>
        
      </div>
  
      <div class="post-nav-item post-nav-prev">
          
          <a href="/2019/10/01/leetcode-zhan-dui-lie/" rel="prev" title="LeetCodeæ ˆ&amp;é˜Ÿåˆ—">
            LeetCodeæ ˆ&amp;é˜Ÿåˆ—
          </a>
          <span>ã€‰</span>
        
      </div>
    </div>
  

    </div>

    

  </div>
  <footer class="footer text-center">
    <div id="bottom-inner">
        <a class="bottom-item" href="https://github.com/imlgw" target="_blank">GitHub</a> |
        <a class="bottom-item" href="/links">å‹æƒ…é“¾æ¥</a> |
        <a class="bottom-item" href="https://hexo.io" target="_blank">Powered by hexo</a> |
        <a class="bottom-item" href="https://imlgw.avosapps.us/" target="_blank" rel="noopener">åšå®¢è¯„è®ºç®¡ç†</a>
    </div>
    <div id="bottom-inner">
        <a class="bottom-item" href="http://beian.miit.gov.cn/publish/query/indexFirst.action" target="_blank">é„‚ICPå¤‡18011208å·</a>
    </div>
</footer>

  
  
  <script>
  (function(window, document, undefined) {

    var timer = null;

    function returnTop() {
      cancelAnimationFrame(timer);
      timer = requestAnimationFrame(function fn() {
        var oTop = document.body.scrollTop || document.documentElement.scrollTop;
        if (oTop > 0) {
          document.body.scrollTop = document.documentElement.scrollTop = oTop - 50;
          timer = requestAnimationFrame(fn);
        } else {
          cancelAnimationFrame(timer);
        }
      });
    }

    var hearts = [];
    window.requestAnimationFrame = (function() {
      return window.requestAnimationFrame ||
        window.webkitRequestAnimationFrame ||
        window.mozRequestAnimationFrame ||
        window.oRequestAnimationFrame ||
        window.msRequestAnimationFrame ||
        function(callback) {
          setTimeout(callback, 1000 / 60);
        }
    })();
    init();

    function init() {
      css(".heart{z-index:9999;width: 10px;height: 10px;position: fixed;background: #f00;transform: rotate(45deg);-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);}.heart:after,.heart:before{content: '';width: inherit;height: inherit;background: inherit;border-radius: 50%;-webkit-border-radius: 50%;-moz-border-radius: 50%;position: absolute;}.heart:after{top: -5px;}.heart:before{left: -5px;}");
      attachEvent();
      gameloop();
      addMenuEvent();
    }

    function gameloop() {
      for (var i = 0; i < hearts.length; i++) {
        if (hearts[i].alpha <= 0) {
          document.body.removeChild(hearts[i].el);
          hearts.splice(i, 1);
          continue;
        }
        hearts[i].y--;
        hearts[i].scale += 0.004;
        hearts[i].alpha -= 0.013;
        hearts[i].el.style.cssText = "left:" + hearts[i].x + "px;top:" + hearts[i].y + "px;opacity:" + hearts[i].alpha + ";transform:scale(" + hearts[i].scale + "," + hearts[i].scale + ") rotate(45deg);background:" + hearts[i].color;
      }
      requestAnimationFrame(gameloop);
    }

    /**
     * ç»™logoè®¾ç½®ç‚¹å‡»äº‹ä»¶
     * 
     * - å›åˆ°é¡¶éƒ¨
     * - å‡ºç°çˆ±å¿ƒ
     */
    function attachEvent() {
      var old = typeof window.onclick === "function" && window.onclick;
      var logo = document.getElementById("logo");
      if (logo) {
        logo.onclick = function(event) {
          returnTop();
          old && old();
          createHeart(event);
        }
      }
      
    }

    function createHeart(event) {
      var d = document.createElement("div");
      d.className = "heart";
      hearts.push({
        el: d,
        x: event.clientX - 5,
        y: event.clientY - 5,
        scale: 1,
        alpha: 1,
        color: randomColor()
      });
      document.body.appendChild(d);
    }

    function css(css) {
      var style = document.createElement("style");
      style.type = "text/css";
      try {
        style.appendChild(document.createTextNode(css));
      } catch (ex) {
        style.styleSheet.cssText = css;
      }
      document.getElementsByTagName('head')[0].appendChild(style);
    }

    function randomColor() {
      // return "rgb(" + (~~(Math.random() * 255)) + "," + (~~(Math.random() * 255)) + "," + (~~(Math.random() * 255)) + ")";
      return "#F44336";
    }

    function addMenuEvent() {
      var menu = document.getElementById('menu-main-post');
      if (menu) {
        var toc = document.getElementById('toc');
        if (toc) {
          menu.onclick = function() {
            if (toc) {
              if (toc.style.display == 'block') {
                toc.style.display = 'none';
              } else {
                toc.style.display = 'block';
              }
            }
          };
        } else {
          menu.style.display = 'none';
        }
      }
    }

  })(window, document);
</script>
  
  



  

<script src="https://cdn.jsdelivr.net/npm/live2d-widget@3.x/lib/L2Dwidget.min.js"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"https://cdn.jsdelivr.net/npm/live2d-widget-model-hijiki@1.0.5/assets/hijiki.model.json"},"display":{"superSample":2,"width":160,"height":320,"position":"right","hOffset":0,"vOffset":-70},"mobile":{"show":false,"scale":0.2},"log":false});</script></body>
</html>
